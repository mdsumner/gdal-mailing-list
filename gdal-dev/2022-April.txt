From lelong.ph at meltemus.com  Sat Apr  2 01:17:30 2022
From: lelong.ph at meltemus.com (Philippe Lelong)
Date: Sat, 2 Apr 2022 08:17:30 +0000
Subject: [gdal-dev] Memory allocation issues on Android 11+ and scudo
In-Reply-To: <97af754a281742a6b04b818d52f64f55@meltemus.com>
References: <4a02d507464245a9927fa96256baf66e@meltemus.com>,
 <242686ab-582c-d165-d8a4-20de414743b2@spatialys.com>,
 <300e56b68efc4b96b17e70c6cd75a655@meltemus.com>,
 <97af754a281742a6b04b818d52f64f55@meltemus.com>
Message-ID: <eef2f3a56cd34275bd6366caa63e9a88@meltemus.com>

Hi again,


Still fighting with that one.


I have tried to not run gdal multithreaded, same issue. I have also tried to replace malloc(nSize) with calloc(1, nSize) in VSIMalloc to make sure the memory is initialized, same issue. And many other things... still crashing.


I don't know how to interpret the logs I joined in the previous mail with VSIMalloc etc debugging, do you see anything special in them?


Any other idea I can try to isolate the problem?


Thanks in advance

Philippe.


________________________________
From: gdal-dev <gdal-dev-bounces at lists.osgeo.org> on behalf of Philippe Lelong <lelong.ph at meltemus.com>
Sent: Tuesday, March 29, 2022 7:15 AM
To: gdal-dev at lists.osgeo.org
Subject: Re: [gdal-dev] Memory allocation issues on Android 11+ and scudo


Hi,

I have some results.


First of all note that fprintf(stderr,...)  does nothing on Android since it is redirected to /dev/null. I had to modify cpl_simple.txt in order to use

__android_log_print(ANDROID_LOG_INFO,LOG_TAG, ... instead.


You can find the full logs here: https://www.virtual-winds.org/maitai/gdal_crash.zip


Here is the end of one of them, just before the crash:



03-28 21:02:14.430 20211 20268 E GDAL_VSI: Thread[0x7765183cb0] VSIRealloc(0x7736492fd0, 14768) = 0x7736489630, current_cumul = 22725820, mal+cal-free = 163282
03-28 21:02:14.430 20211 20268 E GDAL_VSI: Thread[0x7765183cb0] VSIRealloc(0x7736489630, 14784) = 0x7736489630, current_cumul = 22725836, mal+cal-free = 163282
03-28 21:02:14.430 20211 20268 E GDAL_VSI: Thread[0x7765183cb0] VSIMalloc(14784) = 0x773645f620, current_cumul = 22740668, mal+cal-free = 163283
03-28 21:02:14.430 20211 20268 E GDAL_VSI: Thread[0x7765183cb0] VSIRealloc(0x773645f620, 14800) = 0x773645f620, current_cumul = 22740684, mal+cal-free = 163284
03-28 21:02:14.430 20211 20268 E GDAL_VSI: Thread[0x7765183cb0] VSIRealloc(0x773645f620, 29568) = 0x7736455c60, current_cumul = 22755452, mal+cal-free = 163284
03-28 21:02:14.430 20211 20268 E GDAL_VSI: Thread[0x7765183cb0] VSIRealloc(0x7736455c60, 29584) = 0x7736455c60, current_cumul = 22755468, mal+cal-free = 163284
03-28 21:02:14.430 20211 20268 E GDAL_VSI: Thread[0x7765183cb0] VSIFree(0x773669f630, (14784 bytes))
03-28 21:02:14.430 20211 20268 E GDAL_VSI: Thread[0x7765183cb0] VSIFree(0x7736489630, (14784 bytes))
03-28 21:02:14.431  1781  5039 D BtGatt.ContextMap: remove() - id: 10
03-28 21:02:14.431  1781  5039 E BtGatt.ContextMap: remove() - removed: 10
03-28 21:02:14.432  1323  1567 D ActivityManager: Received SERVICE intent 0xa7cee6b Key{startService pkg=com.sec.android.app.shealth intent=act=com.samsung.android.app.shealth.tracker.pedometer.PedometerService.HBA cmp=com.sec.android.app.shealth/com.samsung.android.app.shealth.tracker.pedometer.service.PedometerService flags=0x0 u=0} requestCode=0 from uid 1000
03-28 21:02:14.433  1781  3013 I bt_stack: [INFO:gatt_api.cc(1102)] GATT_Deregister gatt_if=10
03-28 21:02:14.434  3224  3224 W [MCFServer]_BleAdapterCallbackManager: onCallbackDied - client was dead, unregister bleAdapter callback appId:17
03-28 21:02:14.435  3224  3224 I [MCFServer]_McfMainController: destroyBleAdapter - appId=17 , mBleAdapterCallbacks size:0
03-28 21:02:14.435  3224  3224 I [MCFServer]_McfMainController: destroyBleAdapter - mBleAdapterCallbacks is empty, destroyBleAdapterManager after 3s
03-28 21:02:14.435  1781  3013 I bt_stack: [INFO:gatt_api.cc(1155)] Initialize tGATT_REG
03-28 21:02:14.438  1781  2610 E BtGatt.GattService: [GSIM LOG]: gsimLogHandler, msg: MESSAGE_SCAN_STOP, appName: com.samsung.android.mcfserver, scannerId: 10, reportDelayMillis=0
03-28 21:02:14.440  1323  1567 V SamsungAlarmManager: setLocked to kernel - W:94823351 / NW:94183790, now=94162423
03-28 21:02:14.441  1323  1323 W Looper  : Drained
03-28 21:02:14.441  1323  3033 W LocationManagerService: onFreezeStateChanged, uid[10400]=false
03-28 21:02:14.441  1323  3033 I PowerManagerService: [PWL] SetWakeLockEnableDisable uid = 10400 , disable= false
03-28 21:02:14.441  1323  3033 I PowerManagerService: [PWL] can not change uid =  10400
03-28 21:02:14.442  1323  1360 V SamsungAlarmManager: setLocked to kernel - W:94823351 / NW:94183790, now=94162425
03-28 21:02:14.444  1323  1546 W system_server: Long monitor contention with owner AlarmManager (1567) at void com.android.server.alarm.AlarmManagerService$AlarmThread.run()(AlarmManagerService.java:5025) waiters=0 in void com.android.server.alarm.AlarmManagerService$DeliveryTracker.alarmComplete(android.os.IBinder) for 296ms
03-28 21:02:14.444   857   857 D Zygote  : Forked child process 21000
03-28 21:02:14.444  1323  3033 W LocationManagerService: onFreezeStateChanged, uid[10301]=false
03-28 21:02:14.445  1323  3033 I PowerManagerService: [PWL] SetWakeLockEnableDisable uid = 10301 , disable= false
03-28 21:02:14.445  1323  1432 I ActivityManager: Start proc 21000:android:drmService/1000 for service {android/com.android.server.DrmEventService}
03-28 21:02:14.445  1323  3033 I PowerManagerService: [PWL] can not change uid =  10301
03-28 21:02:14.445  1323  1431 W BroadcastQueue: Skipping deliver [background] BroadcastRecord{9698798 u-1 android.intent.action.BATTERY_CHANGED} to ReceiverList{8e48bc4 19599 com.facebook.orca/10400/u0 remote:393b6d7}: process gone or crashing
03-28 21:02:14.445  1323  1431 W BroadcastQueue: Skipping deliver [background] BroadcastRecord{9698798 u-1 android.intent.action.BATTERY_CHANGED} to ReceiverList{687dc5e 19599 com.facebook.orca/10400/u0 remote:b49e199}: process gone or crashing
03-28 21:02:14.446  1323  1431 W BroadcastQueue: Skipping deliver [background] BroadcastRecord{cf3bf1 u-1 android.intent.action.BATTERY_CHANGED} to ReceiverList{26d4e3d 19145 com.facebook.katana/10301/u0 remote:87e8394}: process gone or crashing
03-28 21:02:14.446  1323  3033 W LocationManagerService: onFreezeStateChanged, uid[10382]=false
03-28 21:02:14.446  1323  3033 I PowerManagerService: [PWL] SetWakeLockEnableDisable uid = 10382 , disable= false
03-28 21:02:14.446  1323  3033 I PowerManagerService: [PWL] can not change uid =  10382
03-28 21:02:14.447  1809  1809 D QS      : setQSExpansion 0.0 -122.85
03-28 21:02:14.449  8549  8549 I PedometerService: onStartCommand  true, true, true, 1648400236406, 1648400236842, false, false
03-28 21:02:14.451  1809  1809 V SecQSFragmentAnimatorBase: setQsExpansionPosition 0.0
03-28 21:02:14.451  1809  1809 V QsExpandAnimator: setQsExpansionPosition 0.0 0
03-28 21:02:14.451  1323  1431 W BroadcastQueue: Skipping deliver [background] BroadcastRecord{cf3bf1 u-1 android.intent.action.BATTERY_CHANGED} to ReceiverList{86abcc6 19145 com.facebook.katana/10301/u0 remote:8f3e2a1}: process gone or crashing
03-28 21:02:14.452  1323  1360 D SamsungAlarmManager: setInexact (T:3/F:0/AC:false) 20220329T000214 now=94162435 - CU:10251/CP:2699/OP:PendingIntent{9e623d6: PendingIntentRecord{650d89a com.google.android.gms/com.google.android.gms.tron broadcastIntent}}
03-28 21:02:14.452  1323  1360 V SamsungAlarmManager: setLocked to kernel - W:94823351 / NW:94183790, now=94162435
03-28 21:02:14.457  1323  2605 D SemContextService: lock : requestToUpdate
03-28 21:02:14.458  1323  2605 D SemContext.CaeProvider.SensorStatusCheckImpl: Sensor Check Event is null!!
03-28 21:02:14.458  1323  2605 D SemContextService:     .requestToUpdate() : service = Sensor Status Check
03-28 21:02:14.458  1323  2605 D SemContextService: unlock : requestToUpdate
03-28 21:02:14.464  1809  1809 D QS      : setQSExpansion 0.0 -122.85
03-28 21:02:14.466  8549 31023 I SHEALTH#WI#WearableConnectionMonitor: (print) : getConnectedWearableDeviceList(), size : 1
03-28 21:02:14.466 20211 20264 E GDAL_VSI: Thread[0x776957bcb0] VSIRealloc(0x78ab48f090, 13504) = 0x77341bbb20, current_cumul = 22743760, mal+cal-free = 163385
03-28 21:02:14.466 20211 20264 E GDAL_VSI: Thread[0x776957bcb0] VSIRealloc(0x77341bbb20, 13520) = 0x77341bbb20, current_cumul = 22743776, mal+cal-free = 163385
03-28 21:02:14.470 21000 21000 E android:drmSer: Not starting debugger since process cannot load the jdwp agent.
03-28 21:02:14.471 21000 21000 E USNET   : USNET: appName: android:drmService
03-28 21:02:14.471 21000 21000 D ProcessState: Binder ioctl to enable oneway spam detection failed: Invalid argument
03-28 21:02:14.473   996  1051 I heimdall: insert_task_to_group:64, insert tgid 21000 to group com.google.process.gapps, ret = 0
03-28 21:02:14.476 21000 21000 D ActivityThread: setConscryptValidator
03-28 21:02:14.476 21000 21000 D ActivityThread: setConscryptValidator - put
03-28 21:02:14.479  1323  2605 I ActivityManager: DSS OFF for android
03-28 21:02:14.484  1323  2605 D ActivityManager: attachApplicationLocked() app=ProcessRecord{60e4cac 21000:android:drmService/1000} app.isolatedEntryPoint=null instr2=null
03-28 21:02:14.492  1809  1809 W LooperSlow: RunCallback: type=3, action=android.view.ViewRootImpl$TraversalRunnable at d06ee61, token=null, latencyMillis=918, dur=91ms
03-28 21:02:14.494  1809  1809 D IndicatorGardenInputProperty: updateRotation() prv:-1 >> new:0
03-28 21:02:14.495  1809  1809 D DeviceState: getDeviceResolutionPixelSize - currentDensity = 450 deviceDensity = 450 initialDisplaySizeFactor = 1440 currentDisplaySizeFactor = 1080 initialDisplayDensity = 600 proportionalDensity = 450 proportionalPixel = 72
03-28 21:02:14.495  1809  1809 D DeviceState: getDeviceResolutionPixelSize - currentDensity = 450 deviceDensity = 450 initialDisplaySizeFactor = 1440 currentDisplaySizeFactor = 1080 initialDisplayDensity = 600 proportionalDensity = 450 proportionalPixel = 27
03-28 21:02:14.495  1809  1809 D DeviceState: getDeviceResolutionPixelSize - currentDensity = 450 deviceDensity = 450 initialDisplaySizeFactor = 1440 currentDisplaySizeFactor = 1080 initialDisplayDensity = 600 proportionalDensity = 450 proportionalPixel = 16
03-28 21:02:14.495  1809  1809 E IndicatorGardenAlgorithmBasicCutout: NOT MATCH !!!! resourceHeight:74, cutoutHeight:75 ([IndicatorGardenInputProperty]  Rotation(0-0,90-1,180-2,270-3)0, Density:2.8125, ScreenWidthSize:1080, CoverSidePadding:0, mIndicatorGardenCenterOffset:12, mCameraCutoutCropSize:0, mGardenPaddingStart:23, mIndicatorCornerPadding:72, mCameraSidePadding:27, mCameraTopMargin:16, DpCutout:DisplayCutout{insets=Rect(0, 75 - 0, 0) waterfall=Insets{left=0, top=0, right=0, bottom=0} boundingRect={Bounds=[Rect(0, 0 - 0, 0), Rect(511, 0 - 569, 75), Rect(0, 0 - 0, 0), Rect(0, 0 - 0, 0)]} cutoutPathParserInfo={CutoutPathParserInfo{displayWidth=1080 displayHeight=2400 density={2.8125} cutoutSpec={M 0, 0 H -10.4 V 26.66666666666667 H 10.4 V 0 H 0 Z @dp} rotation={0} scale={1.0}}}})
03-28 21:02:14.495  1809  1809 E IndicatorGardenAlgorithmBasicCutout: NOT MATCH !!!! resourceHeight:74, cutoutHeight:75 ([IndicatorGardenInputProperty]  Rotation(0-0,90-1,180-2,270-3)0, Density:2.8125, ScreenWidthSize:1080, CoverSidePadding:0, mIndicatorGardenCenterOffset:12, mCameraCutoutCropSize:0, mGardenPaddingStart:23, mIndicatorCornerPadding:72, mCameraSidePadding:27, mCameraTopMargin:16, DpCutout:DisplayCutout{insets=Rect(0, 75 - 0, 0) waterfall=Insets{left=0, top=0, right=0, bottom=0} boundingRect={Bounds=[Rect(0, 0 - 0, 0), Rect(511, 0 - 569, 75), Rect(0, 0 - 0, 0), Rect(0, 0 - 0, 0)]} cutoutPathParserInfo={CutoutPathParserInfo{displayWidth=1080 displayHeight=2400 density={2.8125} cutoutSpec={M 0, 0 H -10.4 V 26.66666666666667 H 10.4 V 0 H 0 Z @dp} rotation={0} scale={1.0}}}})
03-28 21:02:14.495 21000 21000 D ActivityThread: handleBindApplication()++ app=android:drmService
03-28 21:02:14.496 21000 21000 D CompatibilityChangeReporter: Compat change id reported: 171979766; UID 1000; state: ENABLED
03-28 21:02:14.505  1809  1809 D SystemUIService: SYSUI_RAM_OPTIMIZATION onTrimMemory=15
03-28 21:02:14.506   583   583 I lmkd    : 2(delay),0(swap), 0(freelimit) memory pressure events were skipped after a kill!
03-28 21:02:14.506  1809  1809 D StatusBar: SYSUI_RAM_OPTIMIZATION onTrimMemory=15
03-28 21:02:14.506  1809  1809 D SystemUIService: onTrimMemory : 15
03-28 21:02:14.506   583   583 I lmkd    : cached 0, sandbox(not0) 0
03-28 21:02:14.506  1809  1809 D SystemUIService: Last Info is 03-28 21:00:08.559. It still remains until reset time. So skip this.
03-28 21:02:14.506  1809  1809 D SystemUIService: SYSUI_RAM_OPTIMIZATION onTrimMemory=15
03-28 21:02:14.506  1809  1809 D StatusBar: SYSUI_RAM_OPTIMIZATION onTrimMemory=15
03-28 21:02:14.506  1809  1809 D SystemUIService: onTrimMemory : 15
03-28 21:02:14.507  1809  1809 D SystemUIService: Last Info is 03-28 21:00:08.559. It still remains until reset time. So skip this.
03-28 21:02:14.507  1809  1809 W Looper  : Slow dispatch took 106ms main h=android.view.Choreographer$FrameHandler c=android.view.Choreographer$FrameDisplayEventReceiver at 15dac12 m=0
03-28 21:02:14.510   583   583 E libprocessgroup: set_timerslack_ns write failed: No such process
03-28 21:02:14.511   583   583 I lmkd    : Reclaim 'android.process.acore' (27861), uid 10071, oom_score_adj 850, state 99 to free 33916kB rss, 56816kB swap; reason: low watermark is breached and swap is low (1848484kB < 838860kB)
03-28 21:02:14.521 20211 20264 E GDAL_VSI: Thread[0x776957bcb0] VSIFree(0x77341bbb20, (13520 bytes))
03-28 21:02:14.533   857   857 I Zygote  : Process 27861 exited due to signal 9 (Killed)
03-28 21:02:14.533  1323  5047 D InputMethodManagerService: removeClient
03-28 21:02:14.533   583   583 I lmkd    : cached 0, sandbox(not0) 0
03-28 21:02:14.535   583   583 E libprocessgroup: set_timerslack_ns write failed: No such process
03-28 21:02:14.537  1323  2310 I ActivityManager: Process android.process.acore (pid 27861) has died: picked CEM (290,316)
03-28 21:02:14.537  1323  1433 I libprocessgroup: Successfully killed process cgroup uid 10071 pid 27861 in 0ms
03-28 21:02:14.538   583   583 I lmkd    : Reclaim 'com.samsung.cmh:CMH' (28089), uid 5004, oom_score_adj 850, state 99 to free 29444kB rss, 53292kB swap; reason: low watermark is breached and swap is low (1863132kB < 838860kB)
03-28 21:02:14.539  1781  1781 D HidDeviceService: handleMessage(): msg.what=8
03-28 21:02:14.540  1809  1809 W LooperSlow: RunCallback: type=3, action=android.view.ViewRootImpl$TraversalRunnable at fe916b9, token=null, latencyMillis=31, dur=31ms
03-28 21:02:14.540  1809  1809 W Looper  : Slow dispatch took 31ms main h=android.view.Choreographer$FrameHandler c=android.view.Choreographer$FrameDisplayEventReceiver at 15dac12 m=0
03-28 21:02:14.541  1809  1809 W Looper  : Drained
03-28 21:02:14.557 20211 20264 E GDAL_VSI: Thread[0x776957bcb0] VSIRealloc(0x789d45b450, 21280) = 0x772f097cc0, current_cumul = 22758320, mal+cal-free = 163504
03-28 21:02:14.557 20211 20264 E GDAL_VSI: Thread[0x776957bcb0] VSIRealloc(0x772f097cc0, 21296) = 0x772f097cc0, current_cumul = 22758336, mal+cal-free = 163504
03-28 21:02:14.558 20211 20269 E GDAL_VSI: Thread[0x7764085cb0] VSIFree(0x7a89741610, (55312 bytes))
03-28 21:02:14.566   857   857 I Zygote  : Process 28089 exited due to signal 9 (Killed)
03-28 21:02:14.566  1323  1553 I ActivityManager: Process com.samsung.cmh:CMH (pid 28089) has died: picked CEM (277,320)
03-28 21:02:14.566   583   583 I lmkd    : cached 0, sandbox(not0) 0
03-28 21:02:14.566 20211 20262 E GDAL_VSI: Thread[0x7770e3dcb0] VSIRealloc(0x7a3f23d980, 57120) = 0x7a3f23d980, current_cumul = 22716708, mal+cal-free = 163501
03-28 21:02:14.566  1323  1433 I libprocessgroup: Successfully killed process cgroup uid 5004 pid 28089 in 0ms
03-28 21:02:14.568  1781  1781 D HidDeviceService: handleMessage(): msg.what=8
03-28 21:02:14.575   583   583 I lmkd    : Reclaim 'com.google.android.gms' (18299), uid 10251, oom_score_adj 800, state 10 to free 41892kB rss, 50312kB swap; reason: low watermark is breached and swap is low (1871592kB < 838860kB)
03-28 21:02:14.588 20983 20983 V GraphicsEnvironment: ANGLE Developer option for 'com.google.android.apps.turbo' set to: 'default'
03-28 21:02:14.594  1809  3054 I OpenGLRenderer: Davey! duration=989ms; Flags=0, FrameTimelineVsyncId=1355581, IntendedVsync=50486826840932, Vsync=50487676840898, InputEventId=0, HandleInputStart=50487682229734, AnimationStart=50487682230811, PerformTraversalsStart=50487682231618, DrawStart=50487777157695, FrameDeadline=50486843507598, FrameInterval=50487682147349, FrameStartTime=16666666, SyncQueued=50487779379772, SyncStart=50487780687541, IssueDrawCommandsStart=50487786418772, SwapBuffers=50487808932657, FrameCompleted=50487817955695, DequeueBufferDuration=1428731, QueueBufferDuration=4194269, GpuCompleted=50487811641964, SwapBuffersCompleted=50487817955695, DisplayPresentTime=0,
03-28 21:02:14.608  1323  2605 D ConnectivityService: ConnectivityService NetworkRequestInfo binderDied(uid/pid:10251/18299, [NetworkRequest [ LISTEN id=3417, [ Transports: WIFI Capabilities: NOT_RESTRICTED&TRUSTED&NOT_VPN&NOT_VCN_MANAGED Uid: 10251 RequestorUid: 10251 RequestorPkg: com.google.android.gms UnderlyingNetworks: Null] ]], android.os.BinderProxy at f2b50f3)
03-28 21:02:14.608   583   583 I lmkd    : cached 0, sandbox(not0) 0
03-28 21:02:14.609   857   857 I Zygote  : Process 18299 exited due to signal 9 (Killed)
03-28 21:02:14.610  1323  2457 D ConnectivityService: ConnectivityService NetworkRequestInfo binderDied(uid/pid:10251/18299, [NetworkRequest [ LISTEN id=3418, [ Transports: WIFI Capabilities: NOT_RESTRICTED&TRUSTED&NOT_VPN&NOT_VCN_MANAGED Uid: 10251 RequestorUid: 10251 RequestorPkg: com.google.android.gms UnderlyingNetworks: Null] ]], android.os.BinderProxy at 70db1b0)
03-28 21:02:14.610  1323  2605 I ActivityManager: Process com.google.android.gms (pid 18299) has died: svc SVC (283,318)
03-28 21:02:14.611  1323  1433 I libprocessgroup: Successfully killed process cgroup uid 10251 pid 18299 in 0ms
03-28 21:02:14.611  1323  2605 W ActivityManager: Scheduling restart of crashed service com.google.android.gms/.cast.service.CastPersistentService in 50492ms for start-requested
03-28 21:02:14.613  1323  5045 E WifiMulticastLockManager: Multicaster binderDied
03-28 21:02:14.615   583   583 E libprocessgroup: set_timerslack_ns write failed: No such process
03-28 21:02:14.616 20211 20267 W libc    : malloc(40) failed: returning null pointer
03-28 21:02:14.616 20211 20263 W libc    : malloc(40) failed: returning null pointer
03-28 21:02:14.616 20211 20266 W libc    : malloc(34) failed: returning null pointer
03-28 21:02:14.616 20211 20269 W libc    : malloc(72) failed: returning null pointer
03-28 21:02:14.616 20211 20268 W libc    : malloc(32) failed: returning null pointer
03-28 21:02:14.616 20211 20262 W libc    : malloc(68) failed: returning null pointer
03-28 21:02:14.616 20211 20264 W libc    : malloc(32) failed: returning null pointer
03-28 21:02:14.617 20211 20265 W libc    : malloc(32) failed: returning null pointer
03-28 21:02:14.617 20211 20269 W libc    : malloc(128) failed: returning null pointer
--------- beginning of crash
03-28 21:02:14.617 20211 20262 F libc    : Fatal signal 6 (SIGABRT), code -1 (SI_QUEUE) in tid 20262 (Thread (pooled)), pid 20211 (.meltemus.qtvlm)
03-28 21:02:14.617 20211 20264 W libc    : malloc(128) failed: returning null pointer

I hope you can understand something, I don't.

Best regards and thank


________________________________
From: gdal-dev <gdal-dev-bounces at lists.osgeo.org> on behalf of Philippe Lelong <lelong.ph at meltemus.com>
Sent: Monday, March 28, 2022 3:50 PM
To: gdal-dev at lists.osgeo.org
Subject: Re: [gdal-dev] Memory allocation issues on Android 11+ and scudo


Thanks Even and Greg for your fast replies


The app and GDAL are built with Android NDK 21 (I have tried NDK 30 and 31) and is targeting SDK 30. High memory Android device is 10Gb or even 14Gb with RAM PLUS. I can add that the app itself is based on Qt 5.15.8 and runs fine on Windows, Linux, Raspberry 2/3/4 32bits or 64bits, MacOS, iOS and Android without Scudo. It is heavily multithreaded including during GDAL calls.


I can also add that I have tried a 32bits build (armv7) running on these armV8 devices, same problem, although the messages in logcat are a bit different. I can also say that I am 99.9% sure this is triggered by GDAL, because our same exactly S52/57 module reading other formats without GDAL does not crash.


I have seen these debug defines in cpl_simple.cpp. I will enable them, rebuild and report here. I don't have a scudo device apart from a emulated one but it is x86-64 and it does not seem to behave exactly the same as the users' ARM64 bits (Samsung S21). My feeling is that it is connected to ARM 64 architecture.


Thanks again, more later hopefully.

Philippe.


________________________________
From: Even Rouault <even.rouault at spatialys.com>
Sent: Monday, March 28, 2022 3:24 PM
To: Philippe Lelong; gdal-dev at lists.osgeo.org
Subject: Re: [gdal-dev] Memory allocation issues on Android 11+ and scudo


Hi,

didn't hear about Scudo before, but it seems it is a LLVM side project: https://llvm.org/docs/ScudoHardenedAllocator.html

So perhaps you could build and use it on Linux as shown in https://llvm.org/docs/ScudoHardenedAllocator.html#library

Besides a potential bug in the allocator, it might be that the S57 driver has a memory allocation pattern that doesn't please Scudo.

Assuming that the problematic memory allocations are done using GDAL's VSIMalloc() (and not C++ new/delete), then have a look at the various #define that you can set at the top of port/cpl_vsisimple.cpp and can be used to trace memory allocations

// Uncomment to check consistent usage of VSIMalloc(), VSIRealloc(),
// VSICalloc(), VSIFree(), VSIStrdup().
// #define DEBUG_VSIMALLOC

// Uncomment to compute memory usage statistics.
// DEBUG_VSIMALLOC must also be defined.
// #define DEBUG_VSIMALLOC_STATS

// Uncomment to print every memory allocation or deallocation.
// DEBUG_VSIMALLOC must also be defined.
// #define DEBUG_VSIMALLOC_VERBOSE

// Number of bytes of the malloc/calloc/free that triggers a debug trace.
// Can be 0 for all allocs.
#define THRESHOLD_PRINT 10000

Even



Le 28/03/2022 ? 14:58, Philippe Lelong a ?crit :

Hi,


I am searching for this issue for months now, and cannot find any solution.

To make a long story short, we are using GDAL to decode OGR/S57 charts for years now. We are facing numerous crashes under Android 11 and up if and only if this Android 11 implementation is using SCUDO as a memory allocator (if jemalloc is used no problems). We face this problem with an old GDAL2.1.3 version, so we updated to GDAL 3.4.1 but the issue is the same.


What I can see is that the memory grows exponentially until no more memory is available and crash, even on systems with huge memory available while an Android device without SCUDO and very limited memory (let's say 4Gb) in the same exact conditions, with the same apk, runs perfectly. The logcat command show this:



03-28 12:40:34.255  4959  5005 W libc    : malloc(264196) failed: returning null pointer
03-28 12:40:34.255  4959  5005 W libc    : malloc(264196) failed: returning null pointer
03-28 12:40:34.256  4959  5005 W libc    : malloc(264196) failed: returning null pointer
03-28 12:40:34.256  4959  5005 W libc    : malloc(264196) failed: returning null pointer
03-28 12:40:34.612   630   630 D io_stats: !@ Write_top(KB): kworker/u16:1(32583) 8
03-28 12:40:34.820  4959  5041 I scudo   : Scudo ERROR: out of memory trying to allocate 64 bytes
03-28 12:40:34.820  4959  5042 I scudo   : Scudo ERROR: out of memory trying to allocate 64 bytes
03-28 12:40:34.820  4959  5033 I scudo   : Scudo ERROR: out of memory trying to allocate 64 bytes
03-28 12:40:34.820  4959  5031 I scudo   : Scudo ERROR: out of memory trying to allocate 64 bytes
03-28 12:40:34.820  4959  5038 I scudo   : Scudo ERROR: out of memory trying to allocate 64 bytes
03-28 12:40:34.820  4959  5040 I scudo   : Scudo ERROR: out of memory trying to allocate 64 bytes

and then crash

Any help on how to debug and eventually fix this would be highly appreciated.

Best regards,
Philippe from qtVlm development team.




_______________________________________________
gdal-dev mailing list
gdal-dev at lists.osgeo.org<mailto:gdal-dev at lists.osgeo.org>
https://lists.osgeo.org/mailman/listinfo/gdal-dev


--
http://www.spatialys.com
My software is free, but my time generally not.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220402/144862be/attachment-0001.html>

From andrew at aitchison.me.uk  Sat Apr  2 04:09:57 2022
From: andrew at aitchison.me.uk (Andrew C Aitchison)
Date: Sat, 2 Apr 2022 12:09:57 +0100 (BST)
Subject: [gdal-dev] Memory allocation issues on Android 11+ and scudo
In-Reply-To: <eef2f3a56cd34275bd6366caa63e9a88@meltemus.com>
References: <4a02d507464245a9927fa96256baf66e@meltemus.com>,
 <242686ab-582c-d165-d8a4-20de414743b2@spatialys.com>,
 <300e56b68efc4b96b17e70c6cd75a655@meltemus.com>,
 <97af754a281742a6b04b818d52f64f55@meltemus.com>
 <eef2f3a56cd34275bd6366caa63e9a88@meltemus.com>
Message-ID: <dc1355a-53db-5547-e2d2-de718cd0475a@aitchison.me.uk>

On Sat, 2 Apr 2022, Philippe Lelong wrote:

> Hi again,
>
> Still fighting with that one.>
>
> I have tried to not run gdal multithreaded, same issue. I have also
> tried to replace malloc(nSize) with calloc(1, nSize) in VSIMalloc to
> make sure the memory is initialized, same issue. And many other
> things... still crashing.
>
> I don't know how to interpret the logs I joined in the previous mail
> with VSIMalloc etc debugging, do you see anything special in them?
>
> Any other idea I can try to isolate the problem?

Is valgrind an option, or would that replace the problem memory library ?

I believe that valgrind is not the only memory debugger.

-----

The "swap is low" message
> 03-28 21:02:14.511   583   583 I lmkd    : Reclaim 'android.process.acore' (27861), uid 10071, oom_score_adj 850, state 99 to free 33916kB rss, 56816kB swap; reason: low watermark is breached and swap is low (1848484kB < 838860kB)
is intriguing - to me it suggests a 32bit sign issue
      1 848 484 kB <
        838 860 kB
Could there be a 32/64bit library mismatch ?

-- 
Andrew C. Aitchison					Kendal, UK
 			andrew at aitchison.me.uk

From even.rouault at spatialys.com  Sat Apr  2 04:26:45 2022
From: even.rouault at spatialys.com (Even Rouault)
Date: Sat, 2 Apr 2022 13:26:45 +0200
Subject: [gdal-dev] Memory allocation issues on Android 11+ and scudo
In-Reply-To: <eef2f3a56cd34275bd6366caa63e9a88@meltemus.com>
References: <4a02d507464245a9927fa96256baf66e@meltemus.com>
 <242686ab-582c-d165-d8a4-20de414743b2@spatialys.com>
 <300e56b68efc4b96b17e70c6cd75a655@meltemus.com>
 <97af754a281742a6b04b818d52f64f55@meltemus.com>
 <eef2f3a56cd34275bd6366caa63e9a88@meltemus.com>
Message-ID: <0b2e12bd-0c49-1df3-6ce4-051b20c1c5fb@spatialys.com>

Hi,

Not that this will give you answers, but I've just tried? the procedure 
of https://llvm.org/docs/ScudoHardenedAllocator.html#library to build 
Scudo as a memory allocator on Linux, and I can ran the 
autotest/ogr/ogr_s57.py tests or test_ogrsf some.000 under it just fine.

Did you try to play with the "release_to_os_interval_ms" setting of 
Scudo, like lowering it ?

I'm wondering if using some malloc recording/replay tooling couldn't be 
of help to try to isolate memory allocation from the logic of the code, 
and possibly use that as a way for Scudo folks to replicate if that 
turns to be a Scudo bug. Random googling led to 
https://github.com/alk/malloc-trace-replay. I've never have used such 
thing. Might not be applicable

Even


Le 02/04/2022 ? 10:17, Philippe Lelong a ?crit?:
>
> Hi again,
>
>
> Still fighting with that one.
>
>
> I have tried to not run gdal multithreaded, same issue. I have also 
> tried to replace malloc(nSize) with calloc(1, nSize) in VSIMalloc?to 
> make sure the memory is initialized, same issue. And many other 
> things... still crashing.
>
>
> I don't know how to interpret the logs I joined in the previous mail 
> with VSIMalloc etc debugging, do you see anything special in them?
>
>
> Any other idea I can try to isolate the problem?
>
>
> Thanks in advance
>
> Philippe.
>
>
>
> ------------------------------------------------------------------------
> *From:* gdal-dev <gdal-dev-bounces at lists.osgeo.org> on behalf of 
> Philippe Lelong <lelong.ph at meltemus.com>
> *Sent:* Tuesday, March 29, 2022 7:15 AM
> *To:* gdal-dev at lists.osgeo.org
> *Subject:* Re: [gdal-dev] Memory allocation issues on Android 11+ and 
> scudo
>
> Hi,
>
> I have some results.
>
>
> First of all note that fprintf(stderr,...)? does nothing on Android 
> since it is redirected to /dev/null. I had to modify cpl_simple.txt in 
> order to use
>
> __android_log_print(ANDROID_LOG_INFO,LOG_TAG, ... instead.
>
>
> You can find the full logs here: 
> https://www.virtual-winds.org/maitai/gdal_crash.zip 
> <https://www.virtual-winds.org/maitai/gdal_crash.zip>
>
>
> Here is the end of one of them, just before the crash:
>
>
>
> 03-28 21:02:14.430 20211 20268 E GDAL_VSI: Thread[0x7765183cb0] 
> VSIRealloc(0x7736492fd0, 14768) = 0x7736489630, current_cumul = 
> 22725820, mal+cal-free = 163282
> 03-28 21:02:14.430 20211 20268 E GDAL_VSI: Thread[0x7765183cb0] 
> VSIRealloc(0x7736489630, 14784) = 0x7736489630, current_cumul = 
> 22725836, mal+cal-free = 163282
> 03-28 21:02:14.430 20211 20268 E GDAL_VSI: Thread[0x7765183cb0] 
> VSIMalloc(14784) = 0x773645f620, current_cumul = 22740668, 
> mal+cal-free = 163283
> 03-28 21:02:14.430 20211 20268 E GDAL_VSI: Thread[0x7765183cb0] 
> VSIRealloc(0x773645f620, 14800) = 0x773645f620, current_cumul = 
> 22740684, mal+cal-free = 163284
> 03-28 21:02:14.430 20211 20268 E GDAL_VSI: Thread[0x7765183cb0] 
> VSIRealloc(0x773645f620, 29568) = 0x7736455c60, current_cumul = 
> 22755452, mal+cal-free = 163284
> 03-28 21:02:14.430 20211 20268 E GDAL_VSI: Thread[0x7765183cb0] 
> VSIRealloc(0x7736455c60, 29584) = 0x7736455c60, current_cumul = 
> 22755468, mal+cal-free = 163284
> 03-28 21:02:14.430 20211 20268 E GDAL_VSI: Thread[0x7765183cb0] 
> VSIFree(0x773669f630, (14784 bytes))
> 03-28 21:02:14.430 20211 20268 E GDAL_VSI: Thread[0x7765183cb0] 
> VSIFree(0x7736489630, (14784 bytes))
> 03-28 21:02:14.431? 1781? 5039 D BtGatt.ContextMap: remove() - id: 10
> 03-28 21:02:14.431? 1781? 5039 E BtGatt.ContextMap: remove() - removed: 10
> 03-28 21:02:14.432? 1323? 1567 D ActivityManager: Received SERVICE 
> intent 0xa7cee6b Key{startService pkg=com.sec.android.app.shealth 
> intent=act=com.samsung.android.app.shealth.tracker.pedometer.PedometerService.HBA 
> cmp=com.sec.android.app.shealth/com.samsung.android.app.shealth.tracker.pedometer.service.PedometerService 
> flags=0x0 u=0} requestCode=0 from uid 1000
> 03-28 21:02:14.433? 1781? 3013 I bt_stack: [INFO:gatt_api.cc(1102)] 
> GATT_Deregister gatt_if=10
> 03-28 21:02:14.434? 3224? 3224 W 
> [MCFServer]_BleAdapterCallbackManager: onCallbackDied - client was 
> dead, unregister bleAdapter callback appId:17
> 03-28 21:02:14.435? 3224? 3224 I [MCFServer]_McfMainController: 
> destroyBleAdapter - appId=17 , mBleAdapterCallbacks size:0
> 03-28 21:02:14.435? 3224? 3224 I [MCFServer]_McfMainController: 
> destroyBleAdapter - mBleAdapterCallbacks is empty, 
> destroyBleAdapterManager after 3s
> 03-28 21:02:14.435? 1781? 3013 I bt_stack: [INFO:gatt_api.cc(1155)] 
> Initialize tGATT_REG
> 03-28 21:02:14.438? 1781? 2610 E BtGatt.GattService: [GSIM LOG]: 
> gsimLogHandler, msg: MESSAGE_SCAN_STOP, appName: 
> com.samsung.android.mcfserver, scannerId: 10, reportDelayMillis=0
> 03-28 21:02:14.440? 1323? 1567 V SamsungAlarmManager: setLocked to 
> kernel - W:94823351 / NW:94183790, now=94162423
> 03-28 21:02:14.441? 1323? 1323 W Looper? : Drained
> 03-28 21:02:14.441? 1323? 3033 W LocationManagerService: 
> onFreezeStateChanged, uid[10400]=false
> 03-28 21:02:14.441? 1323? 3033 I PowerManagerService: [PWL] 
> SetWakeLockEnableDisable uid = 10400 , disable= false
> 03-28 21:02:14.441? 1323? 3033 I PowerManagerService: [PWL] can not 
> change uid =? 10400
> 03-28 21:02:14.442? 1323? 1360 V SamsungAlarmManager: setLocked to 
> kernel - W:94823351 / NW:94183790, now=94162425
> 03-28 21:02:14.444? 1323? 1546 W system_server: Long monitor 
> contention with owner AlarmManager (1567) at void 
> com.android.server.alarm.AlarmManagerService$AlarmThread.run()(AlarmManagerService.java:5025) 
> waiters=0 in void 
> com.android.server.alarm.AlarmManagerService$DeliveryTracker.alarmComplete(android.os.IBinder) 
> for 296ms
> 03-28 21:02:14.444? ?857? ?857 D Zygote? : Forked child process 21000
> 03-28 21:02:14.444? 1323? 3033 W LocationManagerService: 
> onFreezeStateChanged, uid[10301]=false
> 03-28 21:02:14.445? 1323? 3033 I PowerManagerService: [PWL] 
> SetWakeLockEnableDisable uid = 10301 , disable= false
> 03-28 21:02:14.445? 1323? 1432 I ActivityManager: Start proc 
> 21000:android:drmService/1000 for service 
> {android/com.android.server.DrmEventService}
> 03-28 21:02:14.445? 1323? 3033 I PowerManagerService: [PWL] can not 
> change uid =? 10301
> 03-28 21:02:14.445? 1323? 1431 W BroadcastQueue: Skipping deliver 
> [background] BroadcastRecord{9698798 u-1 
> android.intent.action.BATTERY_CHANGED} to ReceiverList{8e48bc4 19599 
> com.facebook.orca/10400/u0 remote:393b6d7}: process gone or crashing
> 03-28 21:02:14.445? 1323? 1431 W BroadcastQueue: Skipping deliver 
> [background] BroadcastRecord{9698798 u-1 
> android.intent.action.BATTERY_CHANGED} to ReceiverList{687dc5e 19599 
> com.facebook.orca/10400/u0 remote:b49e199}: process gone or crashing
> 03-28 21:02:14.446? 1323? 1431 W BroadcastQueue: Skipping deliver 
> [background] BroadcastRecord{cf3bf1 u-1 
> android.intent.action.BATTERY_CHANGED} to ReceiverList{26d4e3d 19145 
> com.facebook.katana/10301/u0 remote:87e8394}: process gone or crashing
> 03-28 21:02:14.446? 1323? 3033 W LocationManagerService: 
> onFreezeStateChanged, uid[10382]=false
> 03-28 21:02:14.446? 1323? 3033 I PowerManagerService: [PWL] 
> SetWakeLockEnableDisable uid = 10382 , disable= false
> 03-28 21:02:14.446? 1323? 3033 I PowerManagerService: [PWL] can not 
> change uid =? 10382
> 03-28 21:02:14.447? 1809? 1809 D QS? ? ? : setQSExpansion 0.0 -122.85
> 03-28 21:02:14.449? 8549? 8549 I PedometerService: onStartCommand? 
> true, true, true, 1648400236406, 1648400236842, false, false
> 03-28 21:02:14.451? 1809? 1809 V SecQSFragmentAnimatorBase: 
> setQsExpansionPosition 0.0
> 03-28 21:02:14.451? 1809? 1809 V QsExpandAnimator: 
> setQsExpansionPosition 0.0 0
> 03-28 21:02:14.451? 1323? 1431 W BroadcastQueue: Skipping deliver 
> [background] BroadcastRecord{cf3bf1 u-1 
> android.intent.action.BATTERY_CHANGED} to ReceiverList{86abcc6 19145 
> com.facebook.katana/10301/u0 remote:8f3e2a1}: process gone or crashing
> 03-28 21:02:14.452? 1323? 1360 D SamsungAlarmManager: setInexact 
> (T:3/F:0/AC:false) 20220329T000214 now=94162435 - 
> CU:10251/CP:2699/OP:PendingIntent{9e623d6: PendingIntentRecord{650d89a 
> com.google.android.gms/com.google.android.gms.tron broadcastIntent}}
> 03-28 21:02:14.452? 1323? 1360 V SamsungAlarmManager: setLocked to 
> kernel - W:94823351 / NW:94183790, now=94162435
> 03-28 21:02:14.457? 1323? 2605 D SemContextService: lock : requestToUpdate
> 03-28 21:02:14.458? 1323? 2605 D 
> SemContext.CaeProvider.SensorStatusCheckImpl: Sensor Check Event is null!!
> 03-28 21:02:14.458? 1323? 2605 D SemContextService:? ? 
> ?.requestToUpdate() : service = Sensor Status Check
> 03-28 21:02:14.458? 1323? 2605 D SemContextService: unlock : 
> requestToUpdate
> 03-28 21:02:14.464? 1809? 1809 D QS? ? ? : setQSExpansion 0.0 -122.85
> 03-28 21:02:14.466? 8549 31023 I SHEALTH#WI#WearableConnectionMonitor: 
> (print) : getConnectedWearableDeviceList(), size : 1
> 03-28 21:02:14.466 20211 20264 E GDAL_VSI: Thread[0x776957bcb0] 
> VSIRealloc(0x78ab48f090, 13504) = 0x77341bbb20, current_cumul = 
> 22743760, mal+cal-free = 163385
> 03-28 21:02:14.466 20211 20264 E GDAL_VSI: Thread[0x776957bcb0] 
> VSIRealloc(0x77341bbb20, 13520) = 0x77341bbb20, current_cumul = 
> 22743776, mal+cal-free = 163385
> 03-28 21:02:14.470 21000 21000 E android:drmSer: Not starting debugger 
> since process cannot load the jdwp agent.
> 03-28 21:02:14.471 21000 21000 E USNET? ?: USNET: appName: 
> android:drmService
> 03-28 21:02:14.471 21000 21000 D ProcessState: Binder ioctl to enable 
> oneway spam detection failed: Invalid argument
> 03-28 21:02:14.473? ?996? 1051 I heimdall: insert_task_to_group:64, 
> insert tgid 21000 to group com.google.process.gapps, ret = 0
> 03-28 21:02:14.476 21000 21000 D ActivityThread: setConscryptValidator
> 03-28 21:02:14.476 21000 21000 D ActivityThread: setConscryptValidator 
> - put
> 03-28 21:02:14.479? 1323? 2605 I ActivityManager: DSS OFF for android
> 03-28 21:02:14.484? 1323? 2605 D ActivityManager: 
> attachApplicationLocked() app=ProcessRecord{60e4cac 
> 21000:android:drmService/1000} app.isolatedEntryPoint=null instr2=null
> 03-28 21:02:14.492? 1809? 1809 W LooperSlow: RunCallback: type=3, 
> action=android.view.ViewRootImpl$TraversalRunnable at d06ee61, 
> token=null, latencyMillis=918, dur=91ms
> 03-28 21:02:14.494? 1809? 1809 D IndicatorGardenInputProperty: 
> updateRotation() prv:-1 >> new:0
> 03-28 21:02:14.495? 1809? 1809 D DeviceState: 
> getDeviceResolutionPixelSize - currentDensity = 450 deviceDensity = 
> 450 initialDisplaySizeFactor = 1440 currentDisplaySizeFactor = 1080 
> initialDisplayDensity = 600 proportionalDensity = 450 
> proportionalPixel = 72
> 03-28 21:02:14.495? 1809? 1809 D DeviceState: 
> getDeviceResolutionPixelSize - currentDensity = 450 deviceDensity = 
> 450 initialDisplaySizeFactor = 1440 currentDisplaySizeFactor = 1080 
> initialDisplayDensity = 600 proportionalDensity = 450 
> proportionalPixel = 27
> 03-28 21:02:14.495? 1809? 1809 D DeviceState: 
> getDeviceResolutionPixelSize - currentDensity = 450 deviceDensity = 
> 450 initialDisplaySizeFactor = 1440 currentDisplaySizeFactor = 1080 
> initialDisplayDensity = 600 proportionalDensity = 450 
> proportionalPixel = 16
> 03-28 21:02:14.495? 1809? 1809 E IndicatorGardenAlgorithmBasicCutout: 
> NOT MATCH !!!! resourceHeight:74, cutoutHeight:75 
> ([IndicatorGardenInputProperty] Rotation(0-0,90-1,180-2,270-3)0, 
> Density:2.8125, ScreenWidthSize:1080, CoverSidePadding:0, 
> mIndicatorGardenCenterOffset:12, mCameraCutoutCropSize:0, 
> mGardenPaddingStart:23, mIndicatorCornerPadding:72, 
> mCameraSidePadding:27, mCameraTopMargin:16, 
> DpCutout:DisplayCutout{insets=Rect(0, 75 - 0, 0) 
> waterfall=Insets{left=0, top=0, right=0, bottom=0} 
> boundingRect={Bounds=[Rect(0, 0 - 0, 0), Rect(511, 0 - 569, 75), 
> Rect(0, 0 - 0, 0), Rect(0, 0 - 0, 0)]} 
> cutoutPathParserInfo={CutoutPathParserInfo{displayWidth=1080 
> displayHeight=2400 density={2.8125} cutoutSpec={M 0, 0 H -10.4 V 
> 26.66666666666667 H 10.4 V 0 H 0 Z @dp} rotation={0} scale={1.0}}}})
> 03-28 21:02:14.495? 1809? 1809 E IndicatorGardenAlgorithmBasicCutout: 
> NOT MATCH !!!! resourceHeight:74, cutoutHeight:75 
> ([IndicatorGardenInputProperty] Rotation(0-0,90-1,180-2,270-3)0, 
> Density:2.8125, ScreenWidthSize:1080, CoverSidePadding:0, 
> mIndicatorGardenCenterOffset:12, mCameraCutoutCropSize:0, 
> mGardenPaddingStart:23, mIndicatorCornerPadding:72, 
> mCameraSidePadding:27, mCameraTopMargin:16, 
> DpCutout:DisplayCutout{insets=Rect(0, 75 - 0, 0) 
> waterfall=Insets{left=0, top=0, right=0, bottom=0} 
> boundingRect={Bounds=[Rect(0, 0 - 0, 0), Rect(511, 0 - 569, 75), 
> Rect(0, 0 - 0, 0), Rect(0, 0 - 0, 0)]} 
> cutoutPathParserInfo={CutoutPathParserInfo{displayWidth=1080 
> displayHeight=2400 density={2.8125} cutoutSpec={M 0, 0 H -10.4 V 
> 26.66666666666667 H 10.4 V 0 H 0 Z @dp} rotation={0} scale={1.0}}}})
> 03-28 21:02:14.495 21000 21000 D ActivityThread: 
> handleBindApplication()++ app=android:drmService
> 03-28 21:02:14.496 21000 21000 D CompatibilityChangeReporter: Compat 
> change id reported: 171979766; UID 1000; state: ENABLED
> 03-28 21:02:14.505? 1809? 1809 D SystemUIService: 
> SYSUI_RAM_OPTIMIZATION onTrimMemory=15
> 03-28 21:02:14.506? ?583? ?583 I lmkd? ? : 2(delay),0(swap), 
> 0(freelimit) memory pressure events were skipped after a kill!
> 03-28 21:02:14.506? 1809? 1809 D StatusBar: SYSUI_RAM_OPTIMIZATION 
> onTrimMemory=15
> 03-28 21:02:14.506? 1809? 1809 D SystemUIService: onTrimMemory : 15
> 03-28 21:02:14.506? ?583? ?583 I lmkd? ? : cached 0, sandbox(not0) 0
> 03-28 21:02:14.506? 1809? 1809 D SystemUIService: Last Info is 03-28 
> 21:00:08.559. It still remains until reset time. So skip this.
> 03-28 21:02:14.506? 1809? 1809 D SystemUIService: 
> SYSUI_RAM_OPTIMIZATION onTrimMemory=15
> 03-28 21:02:14.506? 1809? 1809 D StatusBar: SYSUI_RAM_OPTIMIZATION 
> onTrimMemory=15
> 03-28 21:02:14.506? 1809? 1809 D SystemUIService: onTrimMemory : 15
> 03-28 21:02:14.507? 1809? 1809 D SystemUIService: Last Info is 03-28 
> 21:00:08.559. It still remains until reset time. So skip this.
> 03-28 21:02:14.507? 1809? 1809 W Looper? : Slow dispatch took 106ms 
> main h=android.view.Choreographer$FrameHandler 
> c=android.view.Choreographer$FrameDisplayEventReceiver at 15dac12 m=0
> 03-28 21:02:14.510? ?583? ?583 E libprocessgroup: set_timerslack_ns 
> write failed: No such process
> 03-28 21:02:14.511? ?583? ?583 I lmkd? ? : Reclaim 
> 'android.process.acore' (27861), uid 10071, oom_score_adj 850, state 
> 99 to free 33916kB rss, 56816kB swap; reason: low watermark is 
> breached and swap is low (1848484kB < 838860kB)
> 03-28 21:02:14.521 20211 20264 E GDAL_VSI: Thread[0x776957bcb0] 
> VSIFree(0x77341bbb20, (13520 bytes))
> 03-28 21:02:14.533? ?857? ?857 I Zygote? : Process 27861 exited due to 
> signal 9 (Killed)
> 03-28 21:02:14.533? 1323? 5047 D InputMethodManagerService: removeClient
> 03-28 21:02:14.533? ?583? ?583 I lmkd? ? : cached 0, sandbox(not0) 0
> 03-28 21:02:14.535? ?583? ?583 E libprocessgroup: set_timerslack_ns 
> write failed: No such process
> 03-28 21:02:14.537? 1323? 2310 I ActivityManager: Process 
> android.process.acore (pid 27861) has died: picked CEM (290,316)
> 03-28 21:02:14.537? 1323? 1433 I libprocessgroup: Successfully killed 
> process cgroup uid 10071 pid 27861 in 0ms
> 03-28 21:02:14.538? ?583? ?583 I lmkd? ? : Reclaim 
> 'com.samsung.cmh:CMH' (28089), uid 5004, oom_score_adj 850, state 99 
> to free 29444kB rss, 53292kB swap; reason: low watermark is breached 
> and swap is low (1863132kB < 838860kB)
> 03-28 21:02:14.539? 1781? 1781 D HidDeviceService: handleMessage(): 
> msg.what=8
> 03-28 21:02:14.540? 1809? 1809 W LooperSlow: RunCallback: type=3, 
> action=android.view.ViewRootImpl$TraversalRunnable at fe916b9, 
> token=null, latencyMillis=31, dur=31ms
> 03-28 21:02:14.540? 1809? 1809 W Looper? : Slow dispatch took 31ms 
> main h=android.view.Choreographer$FrameHandler 
> c=android.view.Choreographer$FrameDisplayEventReceiver at 15dac12 m=0
> 03-28 21:02:14.541? 1809? 1809 W Looper? : Drained
> 03-28 21:02:14.557 20211 20264 E GDAL_VSI: Thread[0x776957bcb0] 
> VSIRealloc(0x789d45b450, 21280) = 0x772f097cc0, current_cumul = 
> 22758320, mal+cal-free = 163504
> 03-28 21:02:14.557 20211 20264 E GDAL_VSI: Thread[0x776957bcb0] 
> VSIRealloc(0x772f097cc0, 21296) = 0x772f097cc0, current_cumul = 
> 22758336, mal+cal-free = 163504
> 03-28 21:02:14.558 20211 20269 E GDAL_VSI: Thread[0x7764085cb0] 
> VSIFree(0x7a89741610, (55312 bytes))
> 03-28 21:02:14.566? ?857? ?857 I Zygote? : Process 28089 exited due to 
> signal 9 (Killed)
> 03-28 21:02:14.566? 1323? 1553 I ActivityManager: Process 
> com.samsung.cmh:CMH (pid 28089) has died: picked CEM (277,320)
> 03-28 21:02:14.566? ?583? ?583 I lmkd? ? : cached 0, sandbox(not0) 0
> 03-28 21:02:14.566 20211 20262 E GDAL_VSI: Thread[0x7770e3dcb0] 
> VSIRealloc(0x7a3f23d980, 57120) = 0x7a3f23d980, current_cumul = 
> 22716708, mal+cal-free = 163501
> 03-28 21:02:14.566? 1323? 1433 I libprocessgroup: Successfully killed 
> process cgroup uid 5004 pid 28089 in 0ms
> 03-28 21:02:14.568? 1781? 1781 D HidDeviceService: handleMessage(): 
> msg.what=8
> 03-28 21:02:14.575? ?583? ?583 I lmkd? ? : Reclaim 
> 'com.google.android.gms' (18299), uid 10251, oom_score_adj 800, state 
> 10 to free 41892kB rss, 50312kB swap; reason: low watermark is 
> breached and swap is low (1871592kB < 838860kB)
> 03-28 21:02:14.588 20983 20983 V GraphicsEnvironment: ANGLE Developer 
> option for 'com.google.android.apps.turbo' set to: 'default'
> 03-28 21:02:14.594? 1809? 3054 I OpenGLRenderer: Davey! 
> duration=989ms; Flags=0, FrameTimelineVsyncId=1355581, 
> IntendedVsync=50486826840932, Vsync=50487676840898, InputEventId=0, 
> HandleInputStart=50487682229734, AnimationStart=50487682230811, 
> PerformTraversalsStart=50487682231618, DrawStart=50487777157695, 
> FrameDeadline=50486843507598, FrameInterval=50487682147349, 
> FrameStartTime=16666666, SyncQueued=50487779379772, 
> SyncStart=50487780687541, IssueDrawCommandsStart=50487786418772, 
> SwapBuffers=50487808932657, FrameCompleted=50487817955695, 
> DequeueBufferDuration=1428731, QueueBufferDuration=4194269, 
> GpuCompleted=50487811641964, SwapBuffersCompleted=50487817955695, 
> DisplayPresentTime=0,
> 03-28 21:02:14.608? 1323? 2605 D ConnectivityService: 
> ConnectivityService NetworkRequestInfo binderDied(uid/pid:10251/18299, 
> [NetworkRequest [ LISTEN id=3417, [ Transports: WIFI Capabilities: 
> NOT_RESTRICTED&TRUSTED&NOT_VPN&NOT_VCN_MANAGED Uid: 10251 
> RequestorUid: 10251 RequestorPkg: com.google.android.gms 
> UnderlyingNetworks: Null] ]], android.os.BinderProxy at f2b50f3)
> 03-28 21:02:14.608? ?583? ?583 I lmkd? ? : cached 0, sandbox(not0) 0
> 03-28 21:02:14.609? ?857? ?857 I Zygote? : Process 18299 exited due to 
> signal 9 (Killed)
> 03-28 21:02:14.610? 1323? 2457 D ConnectivityService: 
> ConnectivityService NetworkRequestInfo binderDied(uid/pid:10251/18299, 
> [NetworkRequest [ LISTEN id=3418, [ Transports: WIFI Capabilities: 
> NOT_RESTRICTED&TRUSTED&NOT_VPN&NOT_VCN_MANAGED Uid: 10251 
> RequestorUid: 10251 RequestorPkg: com.google.android.gms 
> UnderlyingNetworks: Null] ]], android.os.BinderProxy at 70db1b0)
> 03-28 21:02:14.610? 1323? 2605 I ActivityManager: Process 
> com.google.android.gms (pid 18299) has died: svc SVC (283,318)
> 03-28 21:02:14.611? 1323? 1433 I libprocessgroup: Successfully killed 
> process cgroup uid 10251 pid 18299 in 0ms
> 03-28 21:02:14.611? 1323? 2605 W ActivityManager: Scheduling restart 
> of crashed service 
> com.google.android.gms/.cast.service.CastPersistentService in 50492ms 
> for start-requested
> 03-28 21:02:14.613? 1323? 5045 E WifiMulticastLockManager: Multicaster 
> binderDied
> 03-28 21:02:14.615? ?583? ?583 E libprocessgroup: set_timerslack_ns 
> write failed: No such process
> 03-28 21:02:14.616 20211 20267 W libc? ? : malloc(40) failed: 
> returning null pointer
> 03-28 21:02:14.616 20211 20263 W libc? ? : malloc(40) failed: 
> returning null pointer
> 03-28 21:02:14.616 20211 20266 W libc? ? : malloc(34) failed: 
> returning null pointer
> 03-28 21:02:14.616 20211 20269 W libc? ? : malloc(72) failed: 
> returning null pointer
> 03-28 21:02:14.616 20211 20268 W libc? ? : malloc(32) failed: 
> returning null pointer
> 03-28 21:02:14.616 20211 20262 W libc? ? : malloc(68) failed: 
> returning null pointer
> 03-28 21:02:14.616 20211 20264 W libc? ? : malloc(32) failed: 
> returning null pointer
> 03-28 21:02:14.617 20211 20265 W libc? ? : malloc(32) failed: 
> returning null pointer
> 03-28 21:02:14.617 20211 20269 W libc? ? : malloc(128) failed: 
> returning null pointer
> --------- beginning of crash
> 03-28 21:02:14.617 20211 20262 F libc? ? : Fatal signal 6 (SIGABRT), 
> code -1 (SI_QUEUE) in tid 20262 (Thread (pooled)), pid 20211 
> (.meltemus.qtvlm)
> 03-28 21:02:14.617 20211 20264 W libc? ? : malloc(128) failed: 
> returning null pointer
>
> I hope you can understand something, I don't.
>
> Best regards and thank
>
>
> ------------------------------------------------------------------------
> *From:* gdal-dev <gdal-dev-bounces at lists.osgeo.org> on behalf of 
> Philippe Lelong <lelong.ph at meltemus.com>
> *Sent:* Monday, March 28, 2022 3:50 PM
> *To:* gdal-dev at lists.osgeo.org
> *Subject:* Re: [gdal-dev] Memory allocation issues on Android 11+ and 
> scudo
>
> Thanks Even and Greg for your fast replies
>
>
> The app and GDAL are built with Android?NDK 21 (I have tried NDK 30 
> and 31) and is targeting SDK 30. High memory Android?device is 10Gb or 
> even 14Gb with RAM PLUS. I can add that the app itself is based on Qt 
> 5.15.8 and runs fine on Windows, Linux, Raspberry 2/3/4 32bits or 
> 64bits, MacOS, iOS and Android without Scudo. It is heavily 
> multithreaded including during?GDAL calls.
>
>
> I can also add that I have tried a 32bits build (armv7) running on 
> these armV8 devices, same problem, although the messages in logcat are 
> a bit different. I can also say that I am 99.9% sure this is triggered 
> by GDAL, because our same exactly S52/57 module?reading other formats 
> without GDAL does not crash.
>
>
> I have seen these debug defines in cpl_simple.cpp. I will enable them, 
> rebuild and report here. I don't have a scudo device apart from a 
> emulated one but it is x86-64 and it does not seem to behave 
> exactly?the same as the users' ARM64 bits (Samsung S21). My feeling is 
> that it is connected to ARM 64 architecture.
>
>
> Thanks again, more later hopefully.
>
> Philippe.
>
>
>
> ------------------------------------------------------------------------
> *From:* Even Rouault <even.rouault at spatialys.com>
> *Sent:* Monday, March 28, 2022 3:24 PM
> *To:* Philippe Lelong; gdal-dev at lists.osgeo.org
> *Subject:* Re: [gdal-dev] Memory allocation issues on Android 11+ and 
> scudo
>
> Hi,
>
> didn't hear about Scudo before, but it seems it is a LLVM side 
> project: https://llvm.org/docs/ScudoHardenedAllocator.html
>
> So perhaps you could build and use it on Linux as shown in 
> https://llvm.org/docs/ScudoHardenedAllocator.html#library
>
> Besides a potential bug in the allocator, it might be that the S57 
> driver has a memory allocation pattern that doesn't please Scudo.
>
> Assuming that the problematic memory allocations are done using GDAL's 
> VSIMalloc() (and not C++ new/delete), then have a look at the various 
> #define that you can set at the top of port/cpl_vsisimple.cpp and can 
> be used to trace memory allocations
>
> // Uncomment to check consistent usage of VSIMalloc(), VSIRealloc(),
> // VSICalloc(), VSIFree(), VSIStrdup().
> // #define DEBUG_VSIMALLOC
>
> // Uncomment to compute memory usage statistics.
> // DEBUG_VSIMALLOC must also be defined.
> // #define DEBUG_VSIMALLOC_STATS
>
> // Uncomment to print every memory allocation or deallocation.
> // DEBUG_VSIMALLOC must also be defined.
> // #define DEBUG_VSIMALLOC_VERBOSE
>
> // Number of bytes of the malloc/calloc/free that triggers a debug trace.
> // Can be 0 for all allocs.
> #define THRESHOLD_PRINT 10000
>
> Even
>
>
> Le 28/03/2022 ? 14:58, Philippe Lelong a ?crit?:
>>
>> Hi,
>>
>>
>> I am searching for this issue for months now, and cannot find any 
>> solution.
>>
>>
>> To make a long story short, we are using GDAL to decode OGR/S57 
>> charts for years now. We are facing numerous crashes under Android 11 
>> and up if and only if this Android 11 implementation is using SCUDO 
>> as a memory allocator (if jemalloc is used no problems). We face this 
>> problem with an old GDAL2.1.3 version, so we updated to GDAL 3.4.1 
>> but the issue is the same.
>>
>>
>> What I can see is that the memory grows exponentially until no more 
>> memory is available and crash, even on systems with huge memory 
>> available while an Android device without SCUDO and very limited 
>> memory (let's say 4Gb) in the same exact?conditions, with the same 
>> apk, runs perfectly. The logcat command show this:
>>
>> 03-28 12:40:34.255? 4959? 5005 W libc? ? : malloc(264196) failed: 
>> returning null pointer
>> 03-28 12:40:34.255? 4959? 5005 W libc ? : malloc(264196) failed: 
>> returning null pointer
>> 03-28 12:40:34.256? 4959? 5005 W libc ? : malloc(264196) failed: 
>> returning null pointer
>> 03-28 12:40:34.256? 4959? 5005 W libc ? : malloc(264196) failed: 
>> returning null pointer
>> 03-28 12:40:34.612? ?630? ?630 D io_stats: !@ Write_top(KB): 
>> kworker/u16:1(32583) 8
>> 03-28 12:40:34.820? 4959? 5041 I scudo ?: Scudo ERROR: out of memory 
>> trying to allocate 64 bytes
>> 03-28 12:40:34.820? 4959? 5042 I scudo ?: Scudo ERROR: out of memory 
>> trying to allocate 64 bytes
>> 03-28 12:40:34.820? 4959? 5033 I scudo ?: Scudo ERROR: out of memory 
>> trying to allocate 64 bytes
>> 03-28 12:40:34.820? 4959? 5031 I scudo ?: Scudo ERROR: out of memory 
>> trying to allocate 64 bytes
>> 03-28 12:40:34.820? 4959? 5038 I scudo ?: Scudo ERROR: out of memory 
>> trying to allocate 64 bytes
>> 03-28 12:40:34.820? 4959? 5040 I scudo ?: Scudo ERROR: out of memory 
>> trying to allocate 64 bytes
>>
>> and then crash
>>
>> Any help on how to debug and eventually fix this would be highly 
>> appreciated.
>>
>> Best regards,
>> Philippe from qtVlm development team.
>>
>>
>> _______________________________________________
>> gdal-dev mailing list
>> gdal-dev at lists.osgeo.org
>> https://lists.osgeo.org/mailman/listinfo/gdal-dev
> -- 
> http://www.spatialys.com
> My software is free, but my time generally not.
>
> _______________________________________________
> gdal-dev mailing list
> gdal-dev at lists.osgeo.org
> https://lists.osgeo.org/mailman/listinfo/gdal-dev

-- 
http://www.spatialys.com
My software is free, but my time generally not.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220402/2c0e3454/attachment-0001.html>

From lelong.ph at meltemus.com  Sat Apr  2 05:14:26 2022
From: lelong.ph at meltemus.com (Philippe Lelong)
Date: Sat, 2 Apr 2022 12:14:26 +0000
Subject: [gdal-dev] Memory allocation issues on Android 11+ and scudo
In-Reply-To: <0b2e12bd-0c49-1df3-6ce4-051b20c1c5fb@spatialys.com>
References: <4a02d507464245a9927fa96256baf66e@meltemus.com>
 <242686ab-582c-d165-d8a4-20de414743b2@spatialys.com>
 <300e56b68efc4b96b17e70c6cd75a655@meltemus.com>
 <97af754a281742a6b04b818d52f64f55@meltemus.com>
 <eef2f3a56cd34275bd6366caa63e9a88@meltemus.com>,
 <0b2e12bd-0c49-1df3-6ce4-051b20c1c5fb@spatialys.com>
Message-ID: <73a3aec528a44df3a101669d2924a06f@meltemus.com>

Hi,


Thanks Even for taking the time.


Note that the crash does not occur immediately. You have to load many S57s to get it. I do have an automatic procedure that crash always at the same time, but it is not a specific chart that crashes (= I can load the chart that crashes in the test loop without any problem, or if I change the order it will crash elsewhere but again always at the same place, with an out of memory error).


My typical test is using Netherlands S57 charts (https://vaarweginformatie.nl/frp/main/#/page/infra_enc, take zeeland and nederland at the end of the page), and open/close them one by one in a loop.


I have not tried "release_to_os_interval_ms", I will.


Thanks again

Philippe.




________________________________
From: Even Rouault <even.rouault at spatialys.com>
Sent: Saturday, April 2, 2022 1:26 PM
To: Philippe Lelong; gdal-dev at lists.osgeo.org
Subject: Re: [gdal-dev] Memory allocation issues on Android 11+ and scudo


Hi,

Not that this will give you answers, but I've just tried  the procedure of https://llvm.org/docs/ScudoHardenedAllocator.html#library to build Scudo as a memory allocator on Linux, and I can ran the autotest/ogr/ogr_s57.py tests or test_ogrsf some.000 under it just fine.

Did you try to play with the "release_to_os_interval_ms" setting of Scudo, like lowering it ?

I'm wondering if using some malloc recording/replay tooling couldn't be of help to try to isolate memory allocation from the logic of the code, and possibly use that as a way for Scudo folks to replicate if that turns to be a Scudo bug. Random googling led to https://github.com/alk/malloc-trace-replay. I've never have used such thing. Might not be applicable

Even


Le 02/04/2022 ? 10:17, Philippe Lelong a ?crit :

Hi again,


Still fighting with that one.


I have tried to not run gdal multithreaded, same issue. I have also tried to replace malloc(nSize) with calloc(1, nSize) in VSIMalloc to make sure the memory is initialized, same issue. And many other things... still crashing.


I don't know how to interpret the logs I joined in the previous mail with VSIMalloc etc debugging, do you see anything special in them?


Any other idea I can try to isolate the problem?


Thanks in advance

Philippe.


________________________________
From: gdal-dev <gdal-dev-bounces at lists.osgeo.org><mailto:gdal-dev-bounces at lists.osgeo.org> on behalf of Philippe Lelong <lelong.ph at meltemus.com><mailto:lelong.ph at meltemus.com>
Sent: Tuesday, March 29, 2022 7:15 AM
To: gdal-dev at lists.osgeo.org<mailto:gdal-dev at lists.osgeo.org>
Subject: Re: [gdal-dev] Memory allocation issues on Android 11+ and scudo


Hi,

I have some results.


First of all note that fprintf(stderr,...)  does nothing on Android since it is redirected to /dev/null. I had to modify cpl_simple.txt in order to use

__android_log_print(ANDROID_LOG_INFO,LOG_TAG, ... instead.


You can find the full logs here: https://www.virtual-winds.org/maitai/gdal_crash.zip


Here is the end of one of them, just before the crash:



03-28 21:02:14.430 20211 20268 E GDAL_VSI: Thread[0x7765183cb0] VSIRealloc(0x7736492fd0, 14768) = 0x7736489630, current_cumul = 22725820, mal+cal-free = 163282
03-28 21:02:14.430 20211 20268 E GDAL_VSI: Thread[0x7765183cb0] VSIRealloc(0x7736489630, 14784) = 0x7736489630, current_cumul = 22725836, mal+cal-free = 163282
03-28 21:02:14.430 20211 20268 E GDAL_VSI: Thread[0x7765183cb0] VSIMalloc(14784) = 0x773645f620, current_cumul = 22740668, mal+cal-free = 163283
03-28 21:02:14.430 20211 20268 E GDAL_VSI: Thread[0x7765183cb0] VSIRealloc(0x773645f620, 14800) = 0x773645f620, current_cumul = 22740684, mal+cal-free = 163284
03-28 21:02:14.430 20211 20268 E GDAL_VSI: Thread[0x7765183cb0] VSIRealloc(0x773645f620, 29568) = 0x7736455c60, current_cumul = 22755452, mal+cal-free = 163284
03-28 21:02:14.430 20211 20268 E GDAL_VSI: Thread[0x7765183cb0] VSIRealloc(0x7736455c60, 29584) = 0x7736455c60, current_cumul = 22755468, mal+cal-free = 163284
03-28 21:02:14.430 20211 20268 E GDAL_VSI: Thread[0x7765183cb0] VSIFree(0x773669f630, (14784 bytes))
03-28 21:02:14.430 20211 20268 E GDAL_VSI: Thread[0x7765183cb0] VSIFree(0x7736489630, (14784 bytes))
03-28 21:02:14.431  1781  5039 D BtGatt.ContextMap: remove() - id: 10
03-28 21:02:14.431  1781  5039 E BtGatt.ContextMap: remove() - removed: 10
03-28 21:02:14.432  1323  1567 D ActivityManager: Received SERVICE intent 0xa7cee6b Key{startService pkg=com.sec.android.app.shealth intent=act=com.samsung.android.app.shealth.tracker.pedometer.PedometerService.HBA cmp=com.sec.android.app.shealth/com.samsung.android.app.shealth.tracker.pedometer.service.PedometerService flags=0x0 u=0} requestCode=0 from uid 1000
03-28 21:02:14.433  1781  3013 I bt_stack: [INFO:gatt_api.cc(1102)] GATT_Deregister gatt_if=10
03-28 21:02:14.434  3224  3224 W [MCFServer]_BleAdapterCallbackManager: onCallbackDied - client was dead, unregister bleAdapter callback appId:17
03-28 21:02:14.435  3224  3224 I [MCFServer]_McfMainController: destroyBleAdapter - appId=17 , mBleAdapterCallbacks size:0
03-28 21:02:14.435  3224  3224 I [MCFServer]_McfMainController: destroyBleAdapter - mBleAdapterCallbacks is empty, destroyBleAdapterManager after 3s
03-28 21:02:14.435  1781  3013 I bt_stack: [INFO:gatt_api.cc(1155)] Initialize tGATT_REG
03-28 21:02:14.438  1781  2610 E BtGatt.GattService: [GSIM LOG]: gsimLogHandler, msg: MESSAGE_SCAN_STOP, appName: com.samsung.android.mcfserver, scannerId: 10, reportDelayMillis=0
03-28 21:02:14.440  1323  1567 V SamsungAlarmManager: setLocked to kernel - W:94823351 / NW:94183790, now=94162423
03-28 21:02:14.441  1323  1323 W Looper  : Drained
03-28 21:02:14.441  1323  3033 W LocationManagerService: onFreezeStateChanged, uid[10400]=false
03-28 21:02:14.441  1323  3033 I PowerManagerService: [PWL] SetWakeLockEnableDisable uid = 10400 , disable= false
03-28 21:02:14.441  1323  3033 I PowerManagerService: [PWL] can not change uid =  10400
03-28 21:02:14.442  1323  1360 V SamsungAlarmManager: setLocked to kernel - W:94823351 / NW:94183790, now=94162425
03-28 21:02:14.444  1323  1546 W system_server: Long monitor contention with owner AlarmManager (1567) at void com.android.server.alarm.AlarmManagerService$AlarmThread.run()(AlarmManagerService.java:5025) waiters=0 in void com.android.server.alarm.AlarmManagerService$DeliveryTracker.alarmComplete(android.os.IBinder) for 296ms
03-28 21:02:14.444   857   857 D Zygote  : Forked child process 21000
03-28 21:02:14.444  1323  3033 W LocationManagerService: onFreezeStateChanged, uid[10301]=false
03-28 21:02:14.445  1323  3033 I PowerManagerService: [PWL] SetWakeLockEnableDisable uid = 10301 , disable= false
03-28 21:02:14.445  1323  1432 I ActivityManager: Start proc 21000:android:drmService/1000 for service {android/com.android.server.DrmEventService}
03-28 21:02:14.445  1323  3033 I PowerManagerService: [PWL] can not change uid =  10301
03-28 21:02:14.445  1323  1431 W BroadcastQueue: Skipping deliver [background] BroadcastRecord{9698798 u-1 android.intent.action.BATTERY_CHANGED} to ReceiverList{8e48bc4 19599 com.facebook.orca/10400/u0 remote:393b6d7}: process gone or crashing
03-28 21:02:14.445  1323  1431 W BroadcastQueue: Skipping deliver [background] BroadcastRecord{9698798 u-1 android.intent.action.BATTERY_CHANGED} to ReceiverList{687dc5e 19599 com.facebook.orca/10400/u0 remote:b49e199}: process gone or crashing
03-28 21:02:14.446  1323  1431 W BroadcastQueue: Skipping deliver [background] BroadcastRecord{cf3bf1 u-1 android.intent.action.BATTERY_CHANGED} to ReceiverList{26d4e3d 19145 com.facebook.katana/10301/u0 remote:87e8394}: process gone or crashing
03-28 21:02:14.446  1323  3033 W LocationManagerService: onFreezeStateChanged, uid[10382]=false
03-28 21:02:14.446  1323  3033 I PowerManagerService: [PWL] SetWakeLockEnableDisable uid = 10382 , disable= false
03-28 21:02:14.446  1323  3033 I PowerManagerService: [PWL] can not change uid =  10382
03-28 21:02:14.447  1809  1809 D QS      : setQSExpansion 0.0 -122.85
03-28 21:02:14.449  8549  8549 I PedometerService: onStartCommand  true, true, true, 1648400236406, 1648400236842, false, false
03-28 21:02:14.451  1809  1809 V SecQSFragmentAnimatorBase: setQsExpansionPosition 0.0
03-28 21:02:14.451  1809  1809 V QsExpandAnimator: setQsExpansionPosition 0.0 0
03-28 21:02:14.451  1323  1431 W BroadcastQueue: Skipping deliver [background] BroadcastRecord{cf3bf1 u-1 android.intent.action.BATTERY_CHANGED} to ReceiverList{86abcc6 19145 com.facebook.katana/10301/u0 remote:8f3e2a1}: process gone or crashing
03-28 21:02:14.452  1323  1360 D SamsungAlarmManager: setInexact (T:3/F:0/AC:false) 20220329T000214 now=94162435 - CU:10251/CP:2699/OP:PendingIntent{9e623d6: PendingIntentRecord{650d89a com.google.android.gms/com.google.android.gms.tron broadcastIntent}}
03-28 21:02:14.452  1323  1360 V SamsungAlarmManager: setLocked to kernel - W:94823351 / NW:94183790, now=94162435
03-28 21:02:14.457  1323  2605 D SemContextService: lock : requestToUpdate
03-28 21:02:14.458  1323  2605 D SemContext.CaeProvider.SensorStatusCheckImpl: Sensor Check Event is null!!
03-28 21:02:14.458  1323  2605 D SemContextService:     .requestToUpdate() : service = Sensor Status Check
03-28 21:02:14.458  1323  2605 D SemContextService: unlock : requestToUpdate
03-28 21:02:14.464  1809  1809 D QS      : setQSExpansion 0.0 -122.85
03-28 21:02:14.466  8549 31023 I SHEALTH#WI#WearableConnectionMonitor: (print) : getConnectedWearableDeviceList(), size : 1
03-28 21:02:14.466 20211 20264 E GDAL_VSI: Thread[0x776957bcb0] VSIRealloc(0x78ab48f090, 13504) = 0x77341bbb20, current_cumul = 22743760, mal+cal-free = 163385
03-28 21:02:14.466 20211 20264 E GDAL_VSI: Thread[0x776957bcb0] VSIRealloc(0x77341bbb20, 13520) = 0x77341bbb20, current_cumul = 22743776, mal+cal-free = 163385
03-28 21:02:14.470 21000 21000 E android:drmSer: Not starting debugger since process cannot load the jdwp agent.
03-28 21:02:14.471 21000 21000 E USNET   : USNET: appName: android:drmService
03-28 21:02:14.471 21000 21000 D ProcessState: Binder ioctl to enable oneway spam detection failed: Invalid argument
03-28 21:02:14.473   996  1051 I heimdall: insert_task_to_group:64, insert tgid 21000 to group com.google.process.gapps, ret = 0
03-28 21:02:14.476 21000 21000 D ActivityThread: setConscryptValidator
03-28 21:02:14.476 21000 21000 D ActivityThread: setConscryptValidator - put
03-28 21:02:14.479  1323  2605 I ActivityManager: DSS OFF for android
03-28 21:02:14.484  1323  2605 D ActivityManager: attachApplicationLocked() app=ProcessRecord{60e4cac 21000:android:drmService/1000} app.isolatedEntryPoint=null instr2=null
03-28 21:02:14.492  1809  1809 W LooperSlow: RunCallback: type=3, action=android.view.ViewRootImpl$TraversalRunnable at d06ee61, token=null, latencyMillis=918, dur=91ms
03-28 21:02:14.494  1809  1809 D IndicatorGardenInputProperty: updateRotation() prv:-1 >> new:0
03-28 21:02:14.495  1809  1809 D DeviceState: getDeviceResolutionPixelSize - currentDensity = 450 deviceDensity = 450 initialDisplaySizeFactor = 1440 currentDisplaySizeFactor = 1080 initialDisplayDensity = 600 proportionalDensity = 450 proportionalPixel = 72
03-28 21:02:14.495  1809  1809 D DeviceState: getDeviceResolutionPixelSize - currentDensity = 450 deviceDensity = 450 initialDisplaySizeFactor = 1440 currentDisplaySizeFactor = 1080 initialDisplayDensity = 600 proportionalDensity = 450 proportionalPixel = 27
03-28 21:02:14.495  1809  1809 D DeviceState: getDeviceResolutionPixelSize - currentDensity = 450 deviceDensity = 450 initialDisplaySizeFactor = 1440 currentDisplaySizeFactor = 1080 initialDisplayDensity = 600 proportionalDensity = 450 proportionalPixel = 16
03-28 21:02:14.495  1809  1809 E IndicatorGardenAlgorithmBasicCutout: NOT MATCH !!!! resourceHeight:74, cutoutHeight:75 ([IndicatorGardenInputProperty]  Rotation(0-0,90-1,180-2,270-3)0, Density:2.8125, ScreenWidthSize:1080, CoverSidePadding:0, mIndicatorGardenCenterOffset:12, mCameraCutoutCropSize:0, mGardenPaddingStart:23, mIndicatorCornerPadding:72, mCameraSidePadding:27, mCameraTopMargin:16, DpCutout:DisplayCutout{insets=Rect(0, 75 - 0, 0) waterfall=Insets{left=0, top=0, right=0, bottom=0} boundingRect={Bounds=[Rect(0, 0 - 0, 0), Rect(511, 0 - 569, 75), Rect(0, 0 - 0, 0), Rect(0, 0 - 0, 0)]} cutoutPathParserInfo={CutoutPathParserInfo{displayWidth=1080 displayHeight=2400 density={2.8125} cutoutSpec={M 0, 0 H -10.4 V 26.66666666666667 H 10.4 V 0 H 0 Z @dp} rotation={0} scale={1.0}}}})
03-28 21:02:14.495  1809  1809 E IndicatorGardenAlgorithmBasicCutout: NOT MATCH !!!! resourceHeight:74, cutoutHeight:75 ([IndicatorGardenInputProperty]  Rotation(0-0,90-1,180-2,270-3)0, Density:2.8125, ScreenWidthSize:1080, CoverSidePadding:0, mIndicatorGardenCenterOffset:12, mCameraCutoutCropSize:0, mGardenPaddingStart:23, mIndicatorCornerPadding:72, mCameraSidePadding:27, mCameraTopMargin:16, DpCutout:DisplayCutout{insets=Rect(0, 75 - 0, 0) waterfall=Insets{left=0, top=0, right=0, bottom=0} boundingRect={Bounds=[Rect(0, 0 - 0, 0), Rect(511, 0 - 569, 75), Rect(0, 0 - 0, 0), Rect(0, 0 - 0, 0)]} cutoutPathParserInfo={CutoutPathParserInfo{displayWidth=1080 displayHeight=2400 density={2.8125} cutoutSpec={M 0, 0 H -10.4 V 26.66666666666667 H 10.4 V 0 H 0 Z @dp} rotation={0} scale={1.0}}}})
03-28 21:02:14.495 21000 21000 D ActivityThread: handleBindApplication()++ app=android:drmService
03-28 21:02:14.496 21000 21000 D CompatibilityChangeReporter: Compat change id reported: 171979766; UID 1000; state: ENABLED
03-28 21:02:14.505  1809  1809 D SystemUIService: SYSUI_RAM_OPTIMIZATION onTrimMemory=15
03-28 21:02:14.506   583   583 I lmkd    : 2(delay),0(swap), 0(freelimit) memory pressure events were skipped after a kill!
03-28 21:02:14.506  1809  1809 D StatusBar: SYSUI_RAM_OPTIMIZATION onTrimMemory=15
03-28 21:02:14.506  1809  1809 D SystemUIService: onTrimMemory : 15
03-28 21:02:14.506   583   583 I lmkd    : cached 0, sandbox(not0) 0
03-28 21:02:14.506  1809  1809 D SystemUIService: Last Info is 03-28 21:00:08.559. It still remains until reset time. So skip this.
03-28 21:02:14.506  1809  1809 D SystemUIService: SYSUI_RAM_OPTIMIZATION onTrimMemory=15
03-28 21:02:14.506  1809  1809 D StatusBar: SYSUI_RAM_OPTIMIZATION onTrimMemory=15
03-28 21:02:14.506  1809  1809 D SystemUIService: onTrimMemory : 15
03-28 21:02:14.507  1809  1809 D SystemUIService: Last Info is 03-28 21:00:08.559. It still remains until reset time. So skip this.
03-28 21:02:14.507  1809  1809 W Looper  : Slow dispatch took 106ms main h=android.view.Choreographer$FrameHandler c=android.view.Choreographer$FrameDisplayEventReceiver at 15dac12 m=0
03-28 21:02:14.510   583   583 E libprocessgroup: set_timerslack_ns write failed: No such process
03-28 21:02:14.511   583   583 I lmkd    : Reclaim 'android.process.acore' (27861), uid 10071, oom_score_adj 850, state 99 to free 33916kB rss, 56816kB swap; reason: low watermark is breached and swap is low (1848484kB < 838860kB)
03-28 21:02:14.521 20211 20264 E GDAL_VSI: Thread[0x776957bcb0] VSIFree(0x77341bbb20, (13520 bytes))
03-28 21:02:14.533   857   857 I Zygote  : Process 27861 exited due to signal 9 (Killed)
03-28 21:02:14.533  1323  5047 D InputMethodManagerService: removeClient
03-28 21:02:14.533   583   583 I lmkd    : cached 0, sandbox(not0) 0
03-28 21:02:14.535   583   583 E libprocessgroup: set_timerslack_ns write failed: No such process
03-28 21:02:14.537  1323  2310 I ActivityManager: Process android.process.acore (pid 27861) has died: picked CEM (290,316)
03-28 21:02:14.537  1323  1433 I libprocessgroup: Successfully killed process cgroup uid 10071 pid 27861 in 0ms
03-28 21:02:14.538   583   583 I lmkd    : Reclaim 'com.samsung.cmh:CMH' (28089), uid 5004, oom_score_adj 850, state 99 to free 29444kB rss, 53292kB swap; reason: low watermark is breached and swap is low (1863132kB < 838860kB)
03-28 21:02:14.539  1781  1781 D HidDeviceService: handleMessage(): msg.what=8
03-28 21:02:14.540  1809  1809 W LooperSlow: RunCallback: type=3, action=android.view.ViewRootImpl$TraversalRunnable at fe916b9, token=null, latencyMillis=31, dur=31ms
03-28 21:02:14.540  1809  1809 W Looper  : Slow dispatch took 31ms main h=android.view.Choreographer$FrameHandler c=android.view.Choreographer$FrameDisplayEventReceiver at 15dac12 m=0
03-28 21:02:14.541  1809  1809 W Looper  : Drained
03-28 21:02:14.557 20211 20264 E GDAL_VSI: Thread[0x776957bcb0] VSIRealloc(0x789d45b450, 21280) = 0x772f097cc0, current_cumul = 22758320, mal+cal-free = 163504
03-28 21:02:14.557 20211 20264 E GDAL_VSI: Thread[0x776957bcb0] VSIRealloc(0x772f097cc0, 21296) = 0x772f097cc0, current_cumul = 22758336, mal+cal-free = 163504
03-28 21:02:14.558 20211 20269 E GDAL_VSI: Thread[0x7764085cb0] VSIFree(0x7a89741610, (55312 bytes))
03-28 21:02:14.566   857   857 I Zygote  : Process 28089 exited due to signal 9 (Killed)
03-28 21:02:14.566  1323  1553 I ActivityManager: Process com.samsung.cmh:CMH (pid 28089) has died: picked CEM (277,320)
03-28 21:02:14.566   583   583 I lmkd    : cached 0, sandbox(not0) 0
03-28 21:02:14.566 20211 20262 E GDAL_VSI: Thread[0x7770e3dcb0] VSIRealloc(0x7a3f23d980, 57120) = 0x7a3f23d980, current_cumul = 22716708, mal+cal-free = 163501
03-28 21:02:14.566  1323  1433 I libprocessgroup: Successfully killed process cgroup uid 5004 pid 28089 in 0ms
03-28 21:02:14.568  1781  1781 D HidDeviceService: handleMessage(): msg.what=8
03-28 21:02:14.575   583   583 I lmkd    : Reclaim 'com.google.android.gms' (18299), uid 10251, oom_score_adj 800, state 10 to free 41892kB rss, 50312kB swap; reason: low watermark is breached and swap is low (1871592kB < 838860kB)
03-28 21:02:14.588 20983 20983 V GraphicsEnvironment: ANGLE Developer option for 'com.google.android.apps.turbo' set to: 'default'
03-28 21:02:14.594  1809  3054 I OpenGLRenderer: Davey! duration=989ms; Flags=0, FrameTimelineVsyncId=1355581, IntendedVsync=50486826840932, Vsync=50487676840898, InputEventId=0, HandleInputStart=50487682229734, AnimationStart=50487682230811, PerformTraversalsStart=50487682231618, DrawStart=50487777157695, FrameDeadline=50486843507598, FrameInterval=50487682147349, FrameStartTime=16666666, SyncQueued=50487779379772, SyncStart=50487780687541, IssueDrawCommandsStart=50487786418772, SwapBuffers=50487808932657, FrameCompleted=50487817955695, DequeueBufferDuration=1428731, QueueBufferDuration=4194269, GpuCompleted=50487811641964, SwapBuffersCompleted=50487817955695, DisplayPresentTime=0,
03-28 21:02:14.608  1323  2605 D ConnectivityService: ConnectivityService NetworkRequestInfo binderDied(uid/pid:10251/18299, [NetworkRequest [ LISTEN id=3417, [ Transports: WIFI Capabilities: NOT_RESTRICTED&TRUSTED&NOT_VPN&NOT_VCN_MANAGED Uid: 10251 RequestorUid: 10251 RequestorPkg: com.google.android.gms UnderlyingNetworks: Null] ]], android.os.BinderProxy at f2b50f3)
03-28 21:02:14.608   583   583 I lmkd    : cached 0, sandbox(not0) 0
03-28 21:02:14.609   857   857 I Zygote  : Process 18299 exited due to signal 9 (Killed)
03-28 21:02:14.610  1323  2457 D ConnectivityService: ConnectivityService NetworkRequestInfo binderDied(uid/pid:10251/18299, [NetworkRequest [ LISTEN id=3418, [ Transports: WIFI Capabilities: NOT_RESTRICTED&TRUSTED&NOT_VPN&NOT_VCN_MANAGED Uid: 10251 RequestorUid: 10251 RequestorPkg: com.google.android.gms UnderlyingNetworks: Null] ]], android.os.BinderProxy at 70db1b0)
03-28 21:02:14.610  1323  2605 I ActivityManager: Process com.google.android.gms (pid 18299) has died: svc SVC (283,318)
03-28 21:02:14.611  1323  1433 I libprocessgroup: Successfully killed process cgroup uid 10251 pid 18299 in 0ms
03-28 21:02:14.611  1323  2605 W ActivityManager: Scheduling restart of crashed service com.google.android.gms/.cast.service.CastPersistentService in 50492ms for start-requested
03-28 21:02:14.613  1323  5045 E WifiMulticastLockManager: Multicaster binderDied
03-28 21:02:14.615   583   583 E libprocessgroup: set_timerslack_ns write failed: No such process
03-28 21:02:14.616 20211 20267 W libc    : malloc(40) failed: returning null pointer
03-28 21:02:14.616 20211 20263 W libc    : malloc(40) failed: returning null pointer
03-28 21:02:14.616 20211 20266 W libc    : malloc(34) failed: returning null pointer
03-28 21:02:14.616 20211 20269 W libc    : malloc(72) failed: returning null pointer
03-28 21:02:14.616 20211 20268 W libc    : malloc(32) failed: returning null pointer
03-28 21:02:14.616 20211 20262 W libc    : malloc(68) failed: returning null pointer
03-28 21:02:14.616 20211 20264 W libc    : malloc(32) failed: returning null pointer
03-28 21:02:14.617 20211 20265 W libc    : malloc(32) failed: returning null pointer
03-28 21:02:14.617 20211 20269 W libc    : malloc(128) failed: returning null pointer
--------- beginning of crash
03-28 21:02:14.617 20211 20262 F libc    : Fatal signal 6 (SIGABRT), code -1 (SI_QUEUE) in tid 20262 (Thread (pooled)), pid 20211 (.meltemus.qtvlm)
03-28 21:02:14.617 20211 20264 W libc    : malloc(128) failed: returning null pointer

I hope you can understand something, I don't.

Best regards and thank


________________________________
From: gdal-dev <gdal-dev-bounces at lists.osgeo.org><mailto:gdal-dev-bounces at lists.osgeo.org> on behalf of Philippe Lelong <lelong.ph at meltemus.com><mailto:lelong.ph at meltemus.com>
Sent: Monday, March 28, 2022 3:50 PM
To: gdal-dev at lists.osgeo.org<mailto:gdal-dev at lists.osgeo.org>
Subject: Re: [gdal-dev] Memory allocation issues on Android 11+ and scudo


Thanks Even and Greg for your fast replies


The app and GDAL are built with Android NDK 21 (I have tried NDK 30 and 31) and is targeting SDK 30. High memory Android device is 10Gb or even 14Gb with RAM PLUS. I can add that the app itself is based on Qt 5.15.8 and runs fine on Windows, Linux, Raspberry 2/3/4 32bits or 64bits, MacOS, iOS and Android without Scudo. It is heavily multithreaded including during GDAL calls.


I can also add that I have tried a 32bits build (armv7) running on these armV8 devices, same problem, although the messages in logcat are a bit different. I can also say that I am 99.9% sure this is triggered by GDAL, because our same exactly S52/57 module reading other formats without GDAL does not crash.


I have seen these debug defines in cpl_simple.cpp. I will enable them, rebuild and report here. I don't have a scudo device apart from a emulated one but it is x86-64 and it does not seem to behave exactly the same as the users' ARM64 bits (Samsung S21). My feeling is that it is connected to ARM 64 architecture.


Thanks again, more later hopefully.

Philippe.


________________________________
From: Even Rouault <even.rouault at spatialys.com><mailto:even.rouault at spatialys.com>
Sent: Monday, March 28, 2022 3:24 PM
To: Philippe Lelong; gdal-dev at lists.osgeo.org<mailto:gdal-dev at lists.osgeo.org>
Subject: Re: [gdal-dev] Memory allocation issues on Android 11+ and scudo


Hi,

didn't hear about Scudo before, but it seems it is a LLVM side project: https://llvm.org/docs/ScudoHardenedAllocator.html

So perhaps you could build and use it on Linux as shown in https://llvm.org/docs/ScudoHardenedAllocator.html#library

Besides a potential bug in the allocator, it might be that the S57 driver has a memory allocation pattern that doesn't please Scudo.

Assuming that the problematic memory allocations are done using GDAL's VSIMalloc() (and not C++ new/delete), then have a look at the various #define that you can set at the top of port/cpl_vsisimple.cpp and can be used to trace memory allocations

// Uncomment to check consistent usage of VSIMalloc(), VSIRealloc(),
// VSICalloc(), VSIFree(), VSIStrdup().
// #define DEBUG_VSIMALLOC

// Uncomment to compute memory usage statistics.
// DEBUG_VSIMALLOC must also be defined.
// #define DEBUG_VSIMALLOC_STATS

// Uncomment to print every memory allocation or deallocation.
// DEBUG_VSIMALLOC must also be defined.
// #define DEBUG_VSIMALLOC_VERBOSE

// Number of bytes of the malloc/calloc/free that triggers a debug trace.
// Can be 0 for all allocs.
#define THRESHOLD_PRINT 10000

Even



Le 28/03/2022 ? 14:58, Philippe Lelong a ?crit :

Hi,


I am searching for this issue for months now, and cannot find any solution.

To make a long story short, we are using GDAL to decode OGR/S57 charts for years now. We are facing numerous crashes under Android 11 and up if and only if this Android 11 implementation is using SCUDO as a memory allocator (if jemalloc is used no problems). We face this problem with an old GDAL2.1.3 version, so we updated to GDAL 3.4.1 but the issue is the same.


What I can see is that the memory grows exponentially until no more memory is available and crash, even on systems with huge memory available while an Android device without SCUDO and very limited memory (let's say 4Gb) in the same exact conditions, with the same apk, runs perfectly. The logcat command show this:



03-28 12:40:34.255  4959  5005 W libc    : malloc(264196) failed: returning null pointer
03-28 12:40:34.255  4959  5005 W libc    : malloc(264196) failed: returning null pointer
03-28 12:40:34.256  4959  5005 W libc    : malloc(264196) failed: returning null pointer
03-28 12:40:34.256  4959  5005 W libc    : malloc(264196) failed: returning null pointer
03-28 12:40:34.612   630   630 D io_stats: !@ Write_top(KB): kworker/u16:1(32583) 8
03-28 12:40:34.820  4959  5041 I scudo   : Scudo ERROR: out of memory trying to allocate 64 bytes
03-28 12:40:34.820  4959  5042 I scudo   : Scudo ERROR: out of memory trying to allocate 64 bytes
03-28 12:40:34.820  4959  5033 I scudo   : Scudo ERROR: out of memory trying to allocate 64 bytes
03-28 12:40:34.820  4959  5031 I scudo   : Scudo ERROR: out of memory trying to allocate 64 bytes
03-28 12:40:34.820  4959  5038 I scudo   : Scudo ERROR: out of memory trying to allocate 64 bytes
03-28 12:40:34.820  4959  5040 I scudo   : Scudo ERROR: out of memory trying to allocate 64 bytes

and then crash

Any help on how to debug and eventually fix this would be highly appreciated.

Best regards,
Philippe from qtVlm development team.




_______________________________________________
gdal-dev mailing list
gdal-dev at lists.osgeo.org<mailto:gdal-dev at lists.osgeo.org>
https://lists.osgeo.org/mailman/listinfo/gdal-dev


--
http://www.spatialys.com
My software is free, but my time generally not.



_______________________________________________
gdal-dev mailing list
gdal-dev at lists.osgeo.org<mailto:gdal-dev at lists.osgeo.org>
https://lists.osgeo.org/mailman/listinfo/gdal-dev


--
http://www.spatialys.com
My software is free, but my time generally not.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220402/22c96f6c/attachment-0001.html>

From gdt at lexort.com  Sat Apr  2 09:27:52 2022
From: gdt at lexort.com (Greg Troxel)
Date: Sat, 02 Apr 2022 12:27:52 -0400
Subject: [gdal-dev] Memory allocation issues on Android 11+ and scudo
In-Reply-To: <73a3aec528a44df3a101669d2924a06f@meltemus.com> (Philippe
 Lelong's message of "Sat, 2 Apr 2022 12:14:26 +0000")
References: <4a02d507464245a9927fa96256baf66e@meltemus.com>
 <242686ab-582c-d165-d8a4-20de414743b2@spatialys.com>
 <300e56b68efc4b96b17e70c6cd75a655@meltemus.com>
 <97af754a281742a6b04b818d52f64f55@meltemus.com>
 <eef2f3a56cd34275bd6366caa63e9a88@meltemus.com>
 <0b2e12bd-0c49-1df3-6ce4-051b20c1c5fb@spatialys.com>
 <73a3aec528a44df3a101669d2924a06f@meltemus.com>
Message-ID: <rmi8rsn8n7b.fsf@s1.lexort.com>


Philippe Lelong <lelong.ph at meltemus.com> writes:

> My typical test is using Netherlands S57 charts
> (https://vaarweginformatie.nl/frp/main/#/page/infra_enc, take zeeland
> and nederland at the end of the page), and open/close them one by one
> in a loop.
>
>
> I have not tried "release_to_os_interval_ms", I will.

Even if you are not trying to do logging/replay you really should
instrument the allocator to log each allocation/free to a file and use a
program, even if you have to write it, to keep track of the allocated
but not freed allocations.   gdal should produce a similar pattern with
various allocators, and if it doesn't that's interesting.  It is also
key to know what the total outsanding allocations are when the crash
happens.

The scudo allocator might also have logs for obtaining memory and
releasing it, and if so you should turn those on too.
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 194 bytes
Desc: not available
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220402/0b920efc/attachment.sig>

From andrew at aitchison.me.uk  Sat Apr  2 09:43:25 2022
From: andrew at aitchison.me.uk (Andrew C Aitchison)
Date: Sat, 2 Apr 2022 17:43:25 +0100 (BST)
Subject: [gdal-dev] Memory allocation issues on Android 11+ and scudo
In-Reply-To: <73a3aec528a44df3a101669d2924a06f@meltemus.com>
References: <4a02d507464245a9927fa96256baf66e@meltemus.com>
 <242686ab-582c-d165-d8a4-20de414743b2@spatialys.com>
 <300e56b68efc4b96b17e70c6cd75a655@meltemus.com>
 <97af754a281742a6b04b818d52f64f55@meltemus.com>
 <eef2f3a56cd34275bd6366caa63e9a88@meltemus.com>, 
 <0b2e12bd-0c49-1df3-6ce4-051b20c1c5fb@spatialys.com>
 <73a3aec528a44df3a101669d2924a06f@meltemus.com>
Message-ID: <2537fd8e-47c7-921b-dda-eff448e9f60@aitchison.me.uk>

On Sat, 2 Apr 2022, Philippe Lelong wrote:

> Thanks Even for taking the time.
>
> Note that the crash does not occur immediately. You have to load
> many S57s to get it. I do have an automatic procedure that crash
> always at the same time, but it is not a specific chart that crashes
> (= I can load the chart that crashes in the test loop without any
> problem, or if I change the order it will crash elsewhere but again
> always at the same place, with an out of memory error).
>
> My typical test is using Netherlands S57 charts
> (https://vaarweginformatie.nl/frp/main/#/page/infra_enc, take
> zeeland and nederland at the end of the page), and open/close them
> one by one in a loop.

Ah. Could the memory leak be in this loop ?
What language are you using ?

-- 
Andrew C. Aitchison					Kendal, UK
 			andrew at aitchison.me.uk

From Matt.Wilkie at yukon.ca  Mon Apr  4 16:07:08 2022
From: Matt.Wilkie at yukon.ca (Matt.Wilkie at yukon.ca)
Date: Mon, 4 Apr 2022 23:07:08 +0000
Subject: [gdal-dev] Standardize gdal-utils scripts return code for "no
 arguments"
Message-ID: <9070572acd2c4fa49f1d247374336fca@yukon.ca>

Hi folks,

I'm working on "Standardize gdal-utils scripts return codes #5561" for all the scripts in swig/python/gdal-utils. Currently the scripts do not return the same status code for "was run without arguments".

It would be good for the same code meant the same thing across all the scripts in the package. Given that most of the scripts use `1` now, and that this is in line with sys,exit() docs I think it makes sense to make 1 the new standard.

At present we have (return_code, num scripts with that code):

0: 30
1: 56
2:  8
-1:  9

-1 is a special case. In the script code it's written as `return -1` but subprocess.run() captures it as `4294967295`. Another special case is `gdal_auth.py` sample which with no arguments spawns a web authentication page in browser.

Changing the return code will mean anyone who is relying on those in their own scripts or programs will need to adjust. This seems to be a small price for the gain in harmonization across the utilities, to me. Your thoughts?


[0]: https://github.com/OSGeo/gdal/issues/5561
[1]: https://docs.python.org/3/library/sys.html#sys.exit, "Unix programs generally use 2 for command line syntax errors and 1 for all other kind of errors"

Matt Wilkie
Geomatics Developer & Administrator
Environment | Technology, Innovation and Mapping
T 867-667-8133 | Yukon.ca<http://yukon.ca/>
Hours: 08:30-16:30, Mon-Wed: Office, Thu: Remote, Fri: Away.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220404/7b600931/attachment.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: gdal-utils-return-codes.csv
Type: application/octet-stream
Size: 3406 bytes
Desc: gdal-utils-return-codes.csv
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220404/7b600931/attachment.obj>
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: xx-get-return-codes.py.txt
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220404/7b600931/attachment.txt>

From mdsumner at gmail.com  Mon Apr  4 16:28:56 2022
From: mdsumner at gmail.com (Michael Sumner)
Date: Tue, 5 Apr 2022 09:28:56 +1000
Subject: [gdal-dev] GDAL warp tutorial question (C vs. C++)
Message-ID: <CAAcGz9_mgquu+Y_aROPpknkpQBQGPQL4sHjWVUgvK=YAOasgmA@mail.gmail.com>

Hello, the warp tutorial  needs at least inclusion of "cpl_conv.h" for
CPLMalloc to work.

https://gdal.org/tutorials/warp_tut.html

But, I'd like to ask why it uses the style of the C examples (as per the
Raster API tutorial https://gdal.org/tutorials/raster_api_tut.html) rather
than the C++ - i.e. it uses 'GDALDatasetH hSrcDS' declarations rather than
'GDALDataset *poDataset', and all the 'GDAL<Functions>' rather than '->'
pointer syntax.

Is that recommended, or is it just old style in this tutorial (because the
apps were originally C)?

(I still get rather stuck on some of these issues, my C++ is rudimentary -
certainly I'm keen to contribute to docs and more once I understand
better).

Thanks a lot.

Best, Mike


-- 
Michael Sumner
Software and Database Engineer
Australian Antarctic Division
Hobart, Australia
e-mail: mdsumner at gmail.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220405/a7a75a50/attachment.html>

From even.rouault at spatialys.com  Tue Apr  5 03:47:42 2022
From: even.rouault at spatialys.com (Even Rouault)
Date: Tue, 5 Apr 2022 12:47:42 +0200
Subject: [gdal-dev] GDAL warp tutorial question (C vs. C++)
In-Reply-To: <CAAcGz9_mgquu+Y_aROPpknkpQBQGPQL4sHjWVUgvK=YAOasgmA@mail.gmail.com>
References: <CAAcGz9_mgquu+Y_aROPpknkpQBQGPQL4sHjWVUgvK=YAOasgmA@mail.gmail.com>
Message-ID: <3d247b59-ac52-a2cf-0ee4-2b316eb4556b@spatialys.com>


Le 05/04/2022 ? 01:28, Michael Sumner a ?crit?:
> Hello, the warp tutorial? needs at least inclusion of?"cpl_conv.h" for 
> CPLMalloc to work.
>
> https://gdal.org/tutorials/warp_tut.html
>
> But, I'd like to ask why it uses the style of the C examples (as per 
> the Raster API tutorial 
> https://gdal.org/tutorials/raster_api_tut.html) rather than the C++ - 
> i.e. it uses 'GDALDatasetH?hSrcDS' declarations rather than 
> 'GDALDataset *poDataset', and all the 'GDAL<Functions>' rather than 
> '->' pointer syntax.
>
> Is that recommended, or is it just old style in this tutorial (because 
> the apps were originally C)?

Probably just the preference of the author of the example. At least the 
first code snippet 
(https://gdal.org/tutorials/warp_tut.html#a-simple-reprojection-case) 
uses some C++ with the GDALWarpOperation class so it could be 
potentially converted to full C++ (but you'll need to keep CPLMalloc() 
and not use new[] because GDALDestroyWarpOptions() expects panSrcBands 
and panDstBands to have been allocated with CPLMalloc())

Actually I see the second snippet 
(https://gdal.org/tutorials/warp_tut.html#creating-the-output-file) does 
use some bits of C++ with the OGRSpatialReference class. It could be 
either fully converted to C++ (but some functions like 
GDALCreateGenImgProjTransformer() or GDALSuggestedWarpOutput() only 
exist in the C API, so you'd have to cast C++ dataset objects to C 
handles at some point. This also applies to the first snippet, which 
explains that using C functions is more practical to avoid those casts)) 
or C.


-- 
http://www.spatialys.com
My software is free, but my time generally not.


From mdsumner at gmail.com  Tue Apr  5 04:11:35 2022
From: mdsumner at gmail.com (Michael Sumner)
Date: Tue, 5 Apr 2022 21:11:35 +1000
Subject: [gdal-dev] GDAL warp tutorial question (C vs. C++)
In-Reply-To: <3d247b59-ac52-a2cf-0ee4-2b316eb4556b@spatialys.com>
References: <CAAcGz9_mgquu+Y_aROPpknkpQBQGPQL4sHjWVUgvK=YAOasgmA@mail.gmail.com>
 <3d247b59-ac52-a2cf-0ee4-2b316eb4556b@spatialys.com>
Message-ID: <CAAcGz985NQxn+RxaevCa+Sw4TBCY3SakZPfbDeCGA7yovyU2_w@mail.gmail.com>

Excellent - I'll submit a PR for the include in the first snippet.

I've become more au fait with the different idioms today, and this
description is very helpful.

Best, Mike

On Tue, Apr 5, 2022 at 8:47 PM Even Rouault <even.rouault at spatialys.com>
wrote:
>
>
> Le 05/04/2022 ? 01:28, Michael Sumner a ?crit :
> > Hello, the warp tutorial  needs at least inclusion of "cpl_conv.h" for
> > CPLMalloc to work.
> >
> > https://gdal.org/tutorials/warp_tut.html
> >
> > But, I'd like to ask why it uses the style of the C examples (as per
> > the Raster API tutorial
> > https://gdal.org/tutorials/raster_api_tut.html) rather than the C++ -
> > i.e. it uses 'GDALDatasetH hSrcDS' declarations rather than
> > 'GDALDataset *poDataset', and all the 'GDAL<Functions>' rather than
> > '->' pointer syntax.
> >
> > Is that recommended, or is it just old style in this tutorial (because
> > the apps were originally C)?
>
> Probably just the preference of the author of the example. At least the
> first code snippet
> (https://gdal.org/tutorials/warp_tut.html#a-simple-reprojection-case)
> uses some C++ with the GDALWarpOperation class so it could be
> potentially converted to full C++ (but you'll need to keep CPLMalloc()
> and not use new[] because GDALDestroyWarpOptions() expects panSrcBands
> and panDstBands to have been allocated with CPLMalloc())
>
> Actually I see the second snippet
> (https://gdal.org/tutorials/warp_tut.html#creating-the-output-file) does
> use some bits of C++ with the OGRSpatialReference class. It could be
> either fully converted to C++ (but some functions like
> GDALCreateGenImgProjTransformer() or GDALSuggestedWarpOutput() only
> exist in the C API, so you'd have to cast C++ dataset objects to C
> handles at some point. This also applies to the first snippet, which
> explains that using C functions is more practical to avoid those casts))
> or C.
>
>
> --
> http://www.spatialys.com
> My software is free, but my time generally not.
>


--
Michael Sumner
Software and Database Engineer
Australian Antarctic Division
Hobart, Australia
e-mail: mdsumner at gmail.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220405/939edaa0/attachment-0001.html>

From jukka.rahkonen at maanmittauslaitos.fi  Tue Apr  5 08:00:22 2022
From: jukka.rahkonen at maanmittauslaitos.fi (Rahkonen Jukka (MML))
Date: Tue, 5 Apr 2022 15:00:22 +0000
Subject: [gdal-dev] Create COG jpeg tiles with JFIF APPn markers
Message-ID: <94cc6f6532a74a39ad7a386cc286d27d@maanmittauslaitos.fi>

Hi,

I would like to inform that you did write mail to the right place even you have not received any answers yet. Unfortunately your question is too specific for most GDAL users and capable developers are very busy as you can see from the GitHub activity. Let's still hope that somebody reacts.

-Jukka Rahkonen-

L?hett?j?: gdal-dev <gdal-dev-bounces at lists.osgeo.org> Puolesta Jose Calvo
L?hetetty: tiistai 29. maaliskuuta 2022 9.59
Vastaanottaja: gdal-dev at lists.osgeo.org
Aihe: [gdal-dev] Create COG jpeg tiles with JFIF APPn markers

Hi.

Currently my c++ app creates COG files from GeoTiff tiled files.


GeoTiff files are created using JPEG compression with YCBCR photometric using following creation options:

  *   PROFILE=GeoTIFF
  *   TILED=YES
  *   BLOCKXSIZE=xxx
  *   BLOCKYSIZE=xxx
  *   COMPRESS=JPEG
  *   PHOTOMETRIC=YCBCR
  *   JPEG_QUALITY=xx
  *   JPEGTABLESMODE=0
>From this Geotiff files, app creates COG tiled files using following options:

  *   BLOCKSIZE=xxx
  *   OVERVIEWS=FORCE_USE_EXISTING
  *   COMPRESS=JPEG
  *   QUALITY=xx
Those tiles contain normal JPEG markers (SOI, SOF0, DQT) but no JFIF marker (APPn) is added. How can I ensure adding this JFIF marker?

I'm using gdal 3.1.0.7 in a ubuntu 20.10 using both strategies:

  *   internal jpeg and tiff code: --with-jpeg=internal --with-libtiff=internal
  *   external jpeg and tiff libraries: libjpeg.so.8.2.2 libtiff.so.5.5.0
Thanks in advance.

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220405/914dc640/attachment.html>

From even.rouault at spatialys.com  Tue Apr  5 08:15:51 2022
From: even.rouault at spatialys.com (Even Rouault)
Date: Tue, 5 Apr 2022 17:15:51 +0200
Subject: [gdal-dev] Create COG jpeg tiles with JFIF APPn markers
In-Reply-To: <BL1PR12MB5190329AFA73B4349D0C5ECA811E9@BL1PR12MB5190.namprd12.prod.outlook.com>
References: <BL1PR12MB5190329AFA73B4349D0C5ECA811E9@BL1PR12MB5190.namprd12.prod.outlook.com>
Message-ID: <41f62571-41bc-6913-fa6d-43bfc35c5e40@spatialys.com>

Jose,
> Those tiles contain normal JPEG markers (SOI, SOF0, DQT) but no JFIF 
> marker (APP/n/) is added. How can I ensure adding this JFIF marker?

you can't, unless you're ready to patch the JPEG codec in libtiff to do that

I should point to 
https://www.awaresystems.be/imaging/tiff/specification/TIFFTechNote2.txt 
which mentions:

"Writers should avoid including "noise" JPEG markers (COM and APPn markers).
Standard TIFF fields provide a better way to transport any non-image data.
Some JPEG codecs may change behavior if they see an APPn marker they
think they understand; since the TIFF spec requires these markers to be
ignored, this behavior is undesirable."

Even

-- 
http://www.spatialys.com
My software is free, but my time generally not.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220405/14c72b64/attachment.html>

From ritu.vatsalya at teranet.ca  Tue Apr  5 13:33:23 2022
From: ritu.vatsalya at teranet.ca (Ritu Vatsalya)
Date: Tue, 5 Apr 2022 20:33:23 +0000
Subject: [gdal-dev] Errors during make - GDAL/Linux
In-Reply-To: <BL3PR16MB4356BA5846EAE196573EEC669AE49@BL3PR16MB4356.namprd16.prod.outlook.com>
References: <BL3PR16MB4356C5AC7D522E5178BEB3A59AE59@BL3PR16MB4356.namprd16.prod.outlook.com>
 <BL3PR16MB4356BA5846EAE196573EEC669AE49@BL3PR16MB4356.namprd16.prod.outlook.com>
Message-ID: <BL3PR16MB4356AF7008CEA088F6383D449AE49@BL3PR16MB4356.namprd16.prod.outlook.com>

Hello,
I am trying to install GDAL 3.3.3 on Red Hat Enterprise Linux release 8.5.
I hit the error below during make:

make -C jpeg2000 install-obj
make[2]: Entering directory '/u01/software/gdal-3.3.3/frmts/jpeg2000'
/bin/sh /u01/software/gdal-3.3.3/libtool --mode=compile --silent --tag=CXX g++ -I/u01/software/gdal-3.3.3/port -I/u01/software/gdal-3.3.3/gcore -I/u01/software/gdal-3.3.3/alg -I/u01/software/gdal-3.3.3/ogr -I/u01/software/gdal-3.3.3/ogr/ogrsf_frmts -I/u01/software/gdal-3.3.3/gnm -I/u01/software/gdal-3.3.3/apps -DHAVE_AVX_AT_COMPILE_TIME -DHAVE_SSSE3_AT_COMPILE_TIME -DHAVE_SSE_AT_COMPILE_TIME -g -O2  -Wall -Wextra -Winit-self -Wunused-parameter -Wformat -Werror=format-security -Wno-format-nonliteral -Wlogical-op -Wshadow -Wmissing-include-dirs -Werror=vla -Wdate-time -Wnull-dereference -Wduplicated-cond -Wextra-semi -Wfloat-conversion -Wmissing-declarations -Wnon-virtual-dtor -Woverloaded-virtual -fno-operator-names -Wzero-as-null-pointer-constant -Wsuggest-override -Wimplicit-fallthrough   -DGNM_ENABLED -I/u01/software/gdal-3.3.3/port  -DGDAL_COMPILATION -c -o ../o/jpeg2000dataset.lo jpeg2000dataset.cpp
jpeg2000dataset.cpp:40:10: fatal error: jasper/jasper.h: No such file or directory
#include <jasper/jasper.h>
          ^~~~~~~~~~~~~~~~~
compilation terminated.
make[2]: *** [../../GDALmake.opt:648: ../o/jpeg2000dataset.lo] Error 1
make[2]: Leaving directory '/u01/software/gdal-3.3.3/frmts/jpeg2000'
make[1]: *** [GNUmakefile:15: jpeg2000-install-obj] Error 2
make[1]: Leaving directory '/u01/software/gdal-3.3.3/frmts'
make: *** [GNUmakefile:114: frmts-target] Error 2

Also, I tried installing GDAL version 3.3.2 and get the same issue. Please suggest.


Thanks,
Ritu Vatsalya
Sr Database Admin

Teranet Inc.
123 Front Street West, Suite 700
Toronto, ON M5J 2M2
416.254.0687
www.teranet.ca<http://www.teranet.ca/>
[togaf9-certified]
[cid:image002.png at 01D8490A.DD07B4C0]

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220405/79e683f5/attachment-0001.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: image001.jpg
Type: image/jpeg
Size: 2300 bytes
Desc: image001.jpg
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220405/79e683f5/attachment-0001.jpg>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: image002.png
Type: image/png
Size: 11290 bytes
Desc: image002.png
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220405/79e683f5/attachment-0001.png>

From mateusz at loskot.net  Tue Apr  5 13:45:29 2022
From: mateusz at loskot.net (Mateusz Loskot)
Date: Tue, 5 Apr 2022 22:45:29 +0200
Subject: [gdal-dev] Errors during make - GDAL/Linux
In-Reply-To: <BL3PR16MB4356AF7008CEA088F6383D449AE49@BL3PR16MB4356.namprd16.prod.outlook.com>
References: <BL3PR16MB4356C5AC7D522E5178BEB3A59AE59@BL3PR16MB4356.namprd16.prod.outlook.com>
 <BL3PR16MB4356BA5846EAE196573EEC669AE49@BL3PR16MB4356.namprd16.prod.outlook.com>
 <BL3PR16MB4356AF7008CEA088F6383D449AE49@BL3PR16MB4356.namprd16.prod.outlook.com>
Message-ID: <CABUeae97+yxHr6Dc6autLvWKmmLVrP60ZxmEDepswT67NFTT2w@mail.gmail.com>

On Tue, 5 Apr 2022 at 22:33, Ritu Vatsalya <ritu.vatsalya at teranet.ca> wrote:

> I am trying to install GDAL 3.3.3 on Red Hat Enterprise Linux release 8.5.
>
> jpeg2000dataset.cpp:40:10: fatal error: jasper/jasper.h: No such file or
> directory
>
> #include <jasper/jasper.h>
>
>           ^~~~~~~~~~~~~~~~~
> Please suggest.
>

https://github.com/OSGeo/gdal/issues/2402#issuecomment-613541129

By the way, at near the top of
https://www.google.com/search?q=fatal+error%3A+jasper%2Fjasper.h%3A

Best regards,
-- 
Mateusz Loskot, http://mateusz.loskot.net
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220405/85cd2d57/attachment.html>

From j1 at jimenezshaw.com  Wed Apr  6 08:38:50 2022
From: j1 at jimenezshaw.com (Javier Jimenez Shaw)
Date: Wed, 6 Apr 2022 17:38:50 +0200
Subject: [gdal-dev] CMake - cross compiling - Python
Message-ID: <CADRrdKsCm6fs2gB1GTec4MqZxS5R3ws4M2dmKyRKQwzQwnGOaQ@mail.gmail.com>

Hi

We are testing CMake compilation, and we are having a problem with python,
in particular doing Cross Compilation in macOS x86_64 to M1 (arm)
architecture. Python is found, but the x86_64 (that is not usable here),
even when we disable Python bindings.

We use this options:
GDAL_USE_EXTERNAL_LIBS=OFF
GDAL_USE_GEOTIFF=ON
BUILD_PYTHON_BINDINGS=OFF

The error I get is

[ 82%] Linking CXX executable pytest_runner
ld: warning: ignoring file
/Library/Frameworks/Python.framework/Versions/3.7/lib/libpython3.7m.dylib,
building for macOS-arm64 but attempting to link with file built for
macOS-x86_64
Undefined symbols for architecture arm64:
  "_PyRun_SimpleStringFlags", referenced from:
      _main in pytest_runner.cpp.o
  "_Py_DecodeLocale", referenced from:
      _main in pytest_runner.cpp.o
  "_Py_Finalize", referenced from:
      _main in pytest_runner.cpp.o
  "_Py_Initialize", referenced from:
      _main in pytest_runner.cpp.o
  "_Py_SetProgramName", referenced from:
      _main in pytest_runner.cpp.o
ld: symbol(s) not found for architecture arm64
clang: error: linker command failed with exit code 1 (use -v to see
invocation)
make[2]: *** [autotest/pytest_runner] Error 1
make[1]: *** [autotest/CMakeFiles/pytest_runner.dir/all] Error 2
make[1]: *** Waiting for unfinished jobs....

As a fix, I added an "if" statement in CMakeLists.txt ("# added line"
below) to consider the case when BUILD_PYTHON_BINDINGS is not enabled.

if (BUILD_PYTHON_BINDINGS)  # added line
if (Python_LOOKUP_VERSION)
  set(Python_FIND_STRATEGY VERSION)
  find_package(Python ${Python_LOOKUP_VERSION} EXACT COMPONENTS Interpreter
Development NumPy)
else ()
  set(Python_FIND_STRATEGY LOCATION)
  find_package(Python 3.6 COMPONENTS Interpreter Development NumPy)
endif ()
endif ()  # added line

But maybe there is a better solution.
If that is Ok for you, I can create a PR.

Best regards,
Javier

.___ ._ ..._ .. . ._.  .___ .. __ . _. . __..  ... .... ._ .__
Entre dos pensamientos racionales
hay infinitos pensamientos irracionales.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220406/79c4d70d/attachment.html>

From even.rouault at spatialys.com  Wed Apr  6 08:47:54 2022
From: even.rouault at spatialys.com (Even Rouault)
Date: Wed, 6 Apr 2022 17:47:54 +0200
Subject: [gdal-dev] CMake - cross compiling - Python
In-Reply-To: <CADRrdKsCm6fs2gB1GTec4MqZxS5R3ws4M2dmKyRKQwzQwnGOaQ@mail.gmail.com>
References: <CADRrdKsCm6fs2gB1GTec4MqZxS5R3ws4M2dmKyRKQwzQwnGOaQ@mail.gmail.com>
Message-ID: <3318c31c-a048-c5f7-3e42-98a76833bef5@spatialys.com>


> But maybe there is a better solution.
> If that is Ok for you, I can create a PR.
sounds good, but also move the "option(BUILD_PYTHON_BINDINGS "Build 
Python bindings" ON)" from swig/CMakeLists.txt to top CMakeLists.txt, 
just before testing it

-- 
http://www.spatialys.com
My software is free, but my time generally not.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220406/5b2dd51d/attachment.html>

From j1 at jimenezshaw.com  Wed Apr  6 09:06:44 2022
From: j1 at jimenezshaw.com (Javier Jimenez Shaw)
Date: Wed, 6 Apr 2022 18:06:44 +0200
Subject: [gdal-dev] CMake - cross compiling - Python
In-Reply-To: <3318c31c-a048-c5f7-3e42-98a76833bef5@spatialys.com>
References: <CADRrdKsCm6fs2gB1GTec4MqZxS5R3ws4M2dmKyRKQwzQwnGOaQ@mail.gmail.com>
 <3318c31c-a048-c5f7-3e42-98a76833bef5@spatialys.com>
Message-ID: <CADRrdKtFsrsSMUn9O4dTMXS2-qu-o9atqz49y+LREsLwQ7yYxA@mail.gmail.com>

Something like

option(BUILD_PYTHON_BINDINGS "Build Python bindings" ON)
if (BUILD_PYTHON_BINDINGS)
  if (Python_LOOKUP_VERSION)
    set(Python_FIND_STRATEGY VERSION)
    find_package(Python ${Python_LOOKUP_VERSION} EXACT COMPONENTS
Interpreter Development NumPy)
  else ()
    set(Python_FIND_STRATEGY LOCATION)
    find_package(Python 3.6 COMPONENTS Interpreter Development NumPy)
  endif ()
endif ()

Do I do the PR into master or into v3.5.0alpha1 ?
.___ ._ ..._ .. . ._.  .___ .. __ . _. . __..  ... .... ._ .__
Entre dos pensamientos racionales
hay infinitos pensamientos irracionales.



On Wed, 6 Apr 2022 at 17:47, Even Rouault <even.rouault at spatialys.com>
wrote:

>
> But maybe there is a better solution.
> If that is Ok for you, I can create a PR.
>
> sounds good, but also move the "option(BUILD_PYTHON_BINDINGS "Build
> Python bindings" ON)" from swig/CMakeLists.txt to top CMakeLists.txt,
> just before testing it
>
> -- http://www.spatialys.com
> My software is free, but my time generally not.
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220406/01f0f6e5/attachment.html>

From even.rouault at spatialys.com  Wed Apr  6 09:08:09 2022
From: even.rouault at spatialys.com (Even Rouault)
Date: Wed, 6 Apr 2022 18:08:09 +0200
Subject: [gdal-dev] CMake - cross compiling - Python
In-Reply-To: <CADRrdKtFsrsSMUn9O4dTMXS2-qu-o9atqz49y+LREsLwQ7yYxA@mail.gmail.com>
References: <CADRrdKsCm6fs2gB1GTec4MqZxS5R3ws4M2dmKyRKQwzQwnGOaQ@mail.gmail.com>
 <3318c31c-a048-c5f7-3e42-98a76833bef5@spatialys.com>
 <CADRrdKtFsrsSMUn9O4dTMXS2-qu-o9atqz49y+LREsLwQ7yYxA@mail.gmail.com>
Message-ID: <a61209e8-d183-b1ca-951b-4b7537b201fb@spatialys.com>


Le 06/04/2022 ? 18:06, Javier Jimenez Shaw a ?crit?:
> Something like
>
> option(BUILD_PYTHON_BINDINGS "Build Python bindings" ON)
> if (BUILD_PYTHON_BINDINGS)
> ? if (Python_LOOKUP_VERSION)
> ??? set(Python_FIND_STRATEGY VERSION)
> ? ? find_package(Python ${Python_LOOKUP_VERSION} EXACT COMPONENTS 
> Interpreter Development NumPy)
> ? else ()
> ??? set(Python_FIND_STRATEGY LOCATION)
> ??? find_package(Python 3.6 COMPONENTS Interpreter Development NumPy)
> ? endif ()
> endif ()
>
yes
> Do I do the PR into master or into v3.5.0alpha1 ?
master. (v3.5.0alpha1 is just a tag, not a branch)
> .___ ._ ..._ .. . ._. .___ .. __ . _. . __..? ... .... ._ .__
> Entre dos pensamientos racionales
> hay infinitos pensamientos irracionales.
>
>
>
> On Wed, 6 Apr 2022 at 17:47, Even Rouault <even.rouault at spatialys.com> 
> wrote:
>
>
>>     But maybe there is a better solution.
>>     If that is Ok for you, I can create a PR.
>     sounds good, but also move the "option(BUILD_PYTHON_BINDINGS
>     "Build Python bindings" ON)" from swig/CMakeLists.txt to top
>     CMakeLists.txt, just before testing it
>
>     -- 
>     http://www.spatialys.com
>     My software is free, but my time generally not.
>
-- 
http://www.spatialys.com
My software is free, but my time generally not.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220406/bc7aadef/attachment-0001.html>

From j1 at jimenezshaw.com  Wed Apr  6 09:38:54 2022
From: j1 at jimenezshaw.com (Javier Jimenez Shaw)
Date: Wed, 6 Apr 2022 18:38:54 +0200
Subject: [gdal-dev] HAVE_XLOCALE_H -vs- GDAL_HAVE_XLOCALE_H
Message-ID: <CADRrdKtJE_a2JOFgzPHGMb9Mho7KuOLfCFpjtdj66LmUXui-uA@mail.gmail.com>

Hi

I have seen these two macros defined in the code, and maybe there is a
conflict.

in "cmake/template/cpl_config.h.in" it says
/* Define to 1 if you have the <xlocale.h> header file. */
#cmakedefine GDAL_HAVE_XLOCALE_H 1

and "cmake/helpers/configure.cmake"
check_include_file("xlocale.h" GDAL_HAVE_XLOCALE_H)

but in "ogr/ogrsf_frmts/geojson/libjson/json_tokener.c" says
#ifdef HAVE_XLOCALE_H
#include <xlocale.h>
#endif

(that is failing in my M1 compilation)

Should it be
#if defined(HAVE_XLOCALE_H) || defined(GDAL_HAVE_XLOCALE_H)
or directly
#ifdef GDAL_HAVE_XLOCALE_H
or something else?

I can do such a PR.

BTW, there are multiple "HAVE_*" macros, why is this one "GDAL_HAVE_*"?

Thanks.
.___ ._ ..._ .. . ._.  .___ .. __ . _. . __..  ... .... ._ .__
Entre dos pensamientos racionales
hay infinitos pensamientos irracionales.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220406/91c7091e/attachment.html>

From even.rouault at spatialys.com  Wed Apr  6 10:08:32 2022
From: even.rouault at spatialys.com (Even Rouault)
Date: Wed, 6 Apr 2022 19:08:32 +0200
Subject: [gdal-dev] HAVE_XLOCALE_H -vs- GDAL_HAVE_XLOCALE_H
In-Reply-To: <CADRrdKtJE_a2JOFgzPHGMb9Mho7KuOLfCFpjtdj66LmUXui-uA@mail.gmail.com>
References: <CADRrdKtJE_a2JOFgzPHGMb9Mho7KuOLfCFpjtdj66LmUXui-uA@mail.gmail.com>
Message-ID: <07d07254-dc8f-b5f7-57b0-4c96e685e3bb@spatialys.com>

Javier,

could you rename GDAL_HAVE_XLOCALE_H to HAVE_XLOCALE_H, at the minimum 
in the places where it is used in 
https://github.com/OSGeo/gdal/commit/d83a9f58acb and 
https://github.com/OSGeo/gdal/commit/ab9386760f60e6a312d8418737b5fd94dd7adccb. 
(I don't think it must be used elsewhere)

As far as I remember the reason for the GDAL_ prefix was to avoid 
"contamination" for other software that use cpl_config.h, but since then 
I've restructured that file so that most of it is only defined when 
building GDAL, and not when including GDAL, so that GDAL_ prefix is no 
longer useful

Even

Le 06/04/2022 ? 18:38, Javier Jimenez Shaw a ?crit?:
> Hi
>
> I have seen these two macros defined in the code, and maybe there is a 
> conflict.
>
> in "cmake/template/cpl_config.h.in <http://cpl_config.h.in>" it says
> /* Define to 1 if you have the <xlocale.h> header file. */
> #cmakedefine GDAL_HAVE_XLOCALE_H 1
>
> and "cmake/helpers/configure.cmake"
> check_include_file("xlocale.h" GDAL_HAVE_XLOCALE_H)
>
> but in "ogr/ogrsf_frmts/geojson/libjson/json_tokener.c" says
> #ifdef HAVE_XLOCALE_H
> #include <xlocale.h>
> #endif
>
> (that is failing in my M1 compilation)
>
> Should it be
> #if defined(HAVE_XLOCALE_H) || defined(GDAL_HAVE_XLOCALE_H)
> or directly
> #ifdef GDAL_HAVE_XLOCALE_H
> or something else?
>
> I can do such a PR.
>
> BTW, there are multiple "HAVE_*" macros, why is this one "GDAL_HAVE_*"?
>
> Thanks.
> .___ ._ ..._ .. . ._. .___ .. __ . _. . __..? ... .... ._ .__
> Entre dos pensamientos racionales
> hay infinitos pensamientos irracionales.
>
>
> _______________________________________________
> gdal-dev mailing list
> gdal-dev at lists.osgeo.org
> https://lists.osgeo.org/mailman/listinfo/gdal-dev

-- 
http://www.spatialys.com
My software is free, but my time generally not.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220406/a094bc39/attachment.html>

From seri.prashanti at gmail.com  Thu Apr  7 03:24:50 2022
From: seri.prashanti at gmail.com (prashanti seri)
Date: Thu, 7 Apr 2022 15:54:50 +0530
Subject: [gdal-dev] zlib vulnerability CVE-2018-25032 affecting GAL
Message-ID: <CAB05kcy7QrJu-AAkgk-YUOCJF0QoZoA9o7AEFUeV6+fhUx5=AA@mail.gmail.com>

Hi,
 Does zlib vulnerability CVE-2018-25032 affect GDAL as it uses this lib?
any update on this?
Thanks
Prashanti
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220407/cb598b08/attachment.html>

From mateusz at loskot.net  Thu Apr  7 03:34:49 2022
From: mateusz at loskot.net (Mateusz Loskot)
Date: Thu, 7 Apr 2022 12:34:49 +0200
Subject: [gdal-dev] zlib vulnerability CVE-2018-25032 affecting GAL
In-Reply-To: <CAB05kcy7QrJu-AAkgk-YUOCJF0QoZoA9o7AEFUeV6+fhUx5=AA@mail.gmail.com>
References: <CAB05kcy7QrJu-AAkgk-YUOCJF0QoZoA9o7AEFUeV6+fhUx5=AA@mail.gmail.com>
Message-ID: <CABUeae8OMkXauuJ2CRVFe9KSL8jJ9jYOsaPoOAX2gcSZjukbwg@mail.gmail.com>

On Thu, 7 Apr 2022 at 12:29, prashanti seri <seri.prashanti at gmail.com> wrote:
>  Does zlib vulnerability CVE-2018-25032 affect GDAL as it uses this lib?

Hints:
https://github.com/OSGeo/gdal/blob/master/frmts/zlib/zlib.h#L40
https://github.com/OSGeo/gdal/blob/patch/3.2.2.1/gdal/frmts/zlib/zlib.h#L40
https://github.com/OSGeo/gdal/blob/release/3.4/gdal/frmts/zlib/zlib.h#L40

Hint on solution:
https://gdal.org/build_hints.html#zlib

Best regards,
-- 
Mateusz Loskot, http://mateusz.loskot.net

From andrew at aitchison.me.uk  Thu Apr  7 04:53:52 2022
From: andrew at aitchison.me.uk (Andrew C Aitchison)
Date: Thu, 7 Apr 2022 12:53:52 +0100 (BST)
Subject: [gdal-dev] zlib vulnerability CVE-2018-25032 affecting GAL
In-Reply-To: <CABUeae8OMkXauuJ2CRVFe9KSL8jJ9jYOsaPoOAX2gcSZjukbwg@mail.gmail.com>
References: <CAB05kcy7QrJu-AAkgk-YUOCJF0QoZoA9o7AEFUeV6+fhUx5=AA@mail.gmail.com>
 <CABUeae8OMkXauuJ2CRVFe9KSL8jJ9jYOsaPoOAX2gcSZjukbwg@mail.gmail.com>
Message-ID: <31eaf2a4-7537-33ee-9a9a-a1664627afe1@aitchison.me.uk>

On Thu, 7 Apr 2022, Mateusz Loskot wrote:

> On Thu, 7 Apr 2022 at 12:29, prashanti seri <seri.prashanti at gmail.com> wrote:
>>  Does zlib vulnerability CVE-2018-25032 affect GDAL as it uses this lib?
>
> Hints:
> https://github.com/OSGeo/gdal/blob/master/frmts/zlib/zlib.h#L40
> https://github.com/OSGeo/gdal/blob/patch/3.2.2.1/gdal/frmts/zlib/zlib.h#L40
> https://github.com/OSGeo/gdal/blob/release/3.4/gdal/frmts/zlib/zlib.h#L40

https://github.com/madler/zlib/commit/5c44459c3b28a9bd3283aaceab7c615f8020c531
   It has lain in wait 13 years before being found! The bug was introduced
   in zlib 1.2.2.2, with the addition of the Z_FIXED option. 
so I don't see how zlib 1.2.3 protects gdal from this bug.

I note that ubuntu zlib1g (1:1.2.11.dfsg-2ubuntu7.1) which was released on 
Sat, 26 Mar 2022 fixes this.

> Hint on solution:
> https://gdal.org/build_hints.html#zlib

I agree that building with a known good zlib is a solution.

-- 
Andrew C. Aitchison					Kendal, UK
 			andrew at aitchison.me.uk

From mateusz at loskot.net  Thu Apr  7 05:39:41 2022
From: mateusz at loskot.net (Mateusz Loskot)
Date: Thu, 7 Apr 2022 14:39:41 +0200
Subject: [gdal-dev] zlib vulnerability CVE-2018-25032 affecting GAL
In-Reply-To: <31eaf2a4-7537-33ee-9a9a-a1664627afe1@aitchison.me.uk>
References: <CAB05kcy7QrJu-AAkgk-YUOCJF0QoZoA9o7AEFUeV6+fhUx5=AA@mail.gmail.com>
 <CABUeae8OMkXauuJ2CRVFe9KSL8jJ9jYOsaPoOAX2gcSZjukbwg@mail.gmail.com>
 <31eaf2a4-7537-33ee-9a9a-a1664627afe1@aitchison.me.uk>
Message-ID: <CABUeae8Vi7vBgmf6cMwuJQpHhNFJDD6X3RNZv32yh7CfOm5Wcg@mail.gmail.com>

On Thu, 7 Apr 2022 at 13:54, Andrew C Aitchison <andrew at aitchison.me.uk> wrote:
> On Thu, 7 Apr 2022, Mateusz Loskot wrote:
> > On Thu, 7 Apr 2022 at 12:29, prashanti seri <seri.prashanti at gmail.com> wrote:
> >>  Does zlib vulnerability CVE-2018-25032 affect GDAL as it uses this lib?
> >
> > Hints:
> > https://github.com/OSGeo/gdal/blob/master/frmts/zlib/zlib.h#L40
> > https://github.com/OSGeo/gdal/blob/patch/3.2.2.1/gdal/frmts/zlib/zlib.h#L40
> > https://github.com/OSGeo/gdal/blob/release/3.4/gdal/frmts/zlib/zlib.h#L40
>
> [...]
> so I don't see how zlib 1.2.3 protects gdal from this bug.

The three hints were supposed to help OP find answer to her
question above: "***Does ***zlib vulnerability ***affect*** GDAL?",
that's it.

Best regards,
-- 
Mateusz Loskot, http://mateusz.loskot.net

From even.rouault at spatialys.com  Thu Apr  7 05:47:03 2022
From: even.rouault at spatialys.com (Even Rouault)
Date: Thu, 7 Apr 2022 14:47:03 +0200
Subject: [gdal-dev] zlib vulnerability CVE-2018-25032 affecting GAL
In-Reply-To: <CAB05kcy7QrJu-AAkgk-YUOCJF0QoZoA9o7AEFUeV6+fhUx5=AA@mail.gmail.com>
References: <CAB05kcy7QrJu-AAkgk-YUOCJF0QoZoA9o7AEFUeV6+fhUx5=AA@mail.gmail.com>
Message-ID: <26c53728-10f6-638a-be86-50cac42757b6@spatialys.com>

Internal zlib copy in GDAL master will be updated to 1.2.12 per 
https://github.com/OSGeo/gdal/pull/5588

Most GDAL binary distributions don't use that internal copy but the 
external zlib library provided by the operating system / distribution 
channel.

Le 07/04/2022 ? 12:24, prashanti seri a ?crit?:
> Hi,
> ?Does zlib vulnerability CVE-2018-25032 affect GDAL as it uses this 
> lib? any update on this?
> Thanks
> Prashanti
>
> _______________________________________________
> gdal-dev mailing list
> gdal-dev at lists.osgeo.org
> https://lists.osgeo.org/mailman/listinfo/gdal-dev

-- 
http://www.spatialys.com
My software is free, but my time generally not.


From gdt at lexort.com  Thu Apr  7 06:08:23 2022
From: gdt at lexort.com (Greg Troxel)
Date: Thu, 07 Apr 2022 09:08:23 -0400
Subject: [gdal-dev] zlib vulnerability CVE-2018-25032 affecting GAL
In-Reply-To: <26c53728-10f6-638a-be86-50cac42757b6@spatialys.com> (Even
 Rouault's message of "Thu, 7 Apr 2022 14:47:03 +0200")
References: <CAB05kcy7QrJu-AAkgk-YUOCJF0QoZoA9o7AEFUeV6+fhUx5=AA@mail.gmail.com>
 <26c53728-10f6-638a-be86-50cac42757b6@spatialys.com>
Message-ID: <rmir169f3co.fsf@s1.lexort.com>


Even Rouault <even.rouault at spatialys.com> writes:

> Most GDAL binary distributions don't use that internal copy but the
> external zlib library provided by the operating system / distribution
> channel.

I realize you are accomodating people who can somehow get and build gdal
sources but can't first install zlib, but from the packaging viewpoint
having included copies is a bad thing.  Yes, it shouldn't get used, but
if a dependency isn't declared it would be hidden or not provided and
then be used anyway.

I therefore think it would be good to consider removing the vendored
copies, or at least requiring explicit config to turn them on.  (I just
looked in the sources for how to build and didn't find it in README.  I
know I have figured out how to build and this isn't a request for help,
but in terms of the cmake migration the instructions are missing.)  It
looks like internal will just be used if zlib is not found.

I wonder if it's still really necessary/helpful to have included libs
like zlib.
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 194 bytes
Desc: not available
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220407/473348d7/attachment.sig>

From mateusz at loskot.net  Thu Apr  7 06:18:43 2022
From: mateusz at loskot.net (Mateusz Loskot)
Date: Thu, 7 Apr 2022 15:18:43 +0200
Subject: [gdal-dev] zlib vulnerability CVE-2018-25032 affecting GAL
In-Reply-To: <rmir169f3co.fsf@s1.lexort.com>
References: <CAB05kcy7QrJu-AAkgk-YUOCJF0QoZoA9o7AEFUeV6+fhUx5=AA@mail.gmail.com>
 <26c53728-10f6-638a-be86-50cac42757b6@spatialys.com>
 <rmir169f3co.fsf@s1.lexort.com>
Message-ID: <CABUeae9t3MAvxRgpbHxvBnnYN_ood3t1x-cNhi0PRBnPWLDEwg@mail.gmail.com>

On Thu, 7 Apr 2022 at 15:08, Greg Troxel <gdt at lexort.com> wrote:
> Even Rouault <even.rouault at spatialys.com> writes:
> I therefore think it would be good to consider removing the vendored
> copies, or at least requiring explicit config to turn them on.

+1

> I wonder if it's still really necessary/helpful to have included libs
> like zlib.

Good question that I have wondered myself about.

Best regards,
-- 
Mateusz Loskot, http://mateusz.loskot.net

From andrew at aitchison.me.uk  Thu Apr  7 07:07:52 2022
From: andrew at aitchison.me.uk (Andrew C Aitchison)
Date: Thu, 7 Apr 2022 15:07:52 +0100 (BST)
Subject: [gdal-dev] zlib vulnerability CVE-2018-25032 affecting GAL
In-Reply-To: <rmir169f3co.fsf@s1.lexort.com>
References: <CAB05kcy7QrJu-AAkgk-YUOCJF0QoZoA9o7AEFUeV6+fhUx5=AA@mail.gmail.com>
 <26c53728-10f6-638a-be86-50cac42757b6@spatialys.com>
 <rmir169f3co.fsf@s1.lexort.com>
Message-ID: <5c3f36ac-adf0-894f-fe20-4947e7e622eb@aitchison.me.uk>


On Thu, 7 Apr 2022, Greg Troxel wrote:
> Even Rouault <even.rouault at spatialys.com> writes:
>
>> Most GDAL binary distributions don't use that internal copy but the
>> external zlib library provided by the operating system / distribution
>> channel.
>
> I realize you are accomodating people who can somehow get and build gdal
> sources but can't first install zlib, but from the packaging viewpoint
> having included copies is a bad thing.  Yes, it shouldn't get used, but
> if a dependency isn't declared it would be hidden or not provided and
> then be used anyway.
>
> I therefore think it would be good to consider removing the vendored
> copies, or at least requiring explicit config to turn them on.  (I just
> looked in the sources for how to build and didn't find it in README.  I
> know I have figured out how to build and this isn't a request for help,
> but in terms of the cmake migration the instructions are missing.)  It
> looks like internal will just be used if zlib is not found.
>
> I wonder if it's still really necessary/helpful to have included libs
> like zlib.

I wondered whether it made a difference to driver plugins and "DLL hell"
- the PNG driver uses zlib/libz and libpng -
but it seems that we outlaw building gdriver plugins and internal 
libraries, so that would not be a reason to keep the internal libraries.

-- 
Andrew C. Aitchison					Kendal, UK
 			andrew at aitchison.me.uk

From jmckenna at gatewaygeomatics.com  Thu Apr  7 08:45:48 2022
From: jmckenna at gatewaygeomatics.com (Jeff McKenna)
Date: Thu, 7 Apr 2022 12:45:48 -0300
Subject: [gdal-dev] zlib vulnerability CVE-2018-25032 affecting GAL
In-Reply-To: <rmir169f3co.fsf@s1.lexort.com>
References: <CAB05kcy7QrJu-AAkgk-YUOCJF0QoZoA9o7AEFUeV6+fhUx5=AA@mail.gmail.com>
 <26c53728-10f6-638a-be86-50cac42757b6@spatialys.com>
 <rmir169f3co.fsf@s1.lexort.com>
Message-ID: <e3de552d-c385-4a77-c757-15a41c0419ab@gatewaygeomatics.com>

Thank-you Greg, this is exactly my earlier comment directly on the 
associated ticket this morning, but you explain it much better: 
https://github.com/OSGeo/gdal/issues/5587

It has caused so much grief downstream (zlib inside GDAL), that I 
believe it is time to remove it.

-jeff





On 2022-04-07 10:08 a.m., Greg Troxel wrote:
> 
> Even Rouault <even.rouault at spatialys.com> writes:
> 
>> Most GDAL binary distributions don't use that internal copy but the
>> external zlib library provided by the operating system / distribution
>> channel.
> 
> I realize you are accomodating people who can somehow get and build gdal
> sources but can't first install zlib, but from the packaging viewpoint
> having included copies is a bad thing.  Yes, it shouldn't get used, but
> if a dependency isn't declared it would be hidden or not provided and
> then be used anyway.
> 
> I therefore think it would be good to consider removing the vendored
> copies, or at least requiring explicit config to turn them on.  (I just
> looked in the sources for how to build and didn't find it in README.  I
> know I have figured out how to build and this isn't a request for help,
> but in terms of the cmake migration the instructions are missing.)  It
> looks like internal will just be used if zlib is not found.
> 
> I wonder if it's still really necessary/helpful to have included libs
> like zlib.
> 

From jmckenna at gatewaygeomatics.com  Thu Apr  7 08:47:09 2022
From: jmckenna at gatewaygeomatics.com (Jeff McKenna)
Date: Thu, 7 Apr 2022 12:47:09 -0300
Subject: [gdal-dev] zlib vulnerability CVE-2018-25032 affecting GAL
In-Reply-To: <5c3f36ac-adf0-894f-fe20-4947e7e622eb@aitchison.me.uk>
References: <CAB05kcy7QrJu-AAkgk-YUOCJF0QoZoA9o7AEFUeV6+fhUx5=AA@mail.gmail.com>
 <26c53728-10f6-638a-be86-50cac42757b6@spatialys.com>
 <rmir169f3co.fsf@s1.lexort.com>
 <5c3f36ac-adf0-894f-fe20-4947e7e622eb@aitchison.me.uk>
Message-ID: <627613f3-9c7d-f344-518f-5ad3f717f6dd@gatewaygeomatics.com>

On 2022-04-07 11:07 a.m., Andrew C Aitchison wrote:
> 
> On Thu, 7 Apr 2022, Greg Troxel wrote:
>> Even Rouault <even.rouault at spatialys.com> writes:
>>
>>> Most GDAL binary distributions don't use that internal copy but the
>>> external zlib library provided by the operating system / distribution
>>> channel.
>>
>> I realize you are accomodating people who can somehow get and build gdal
>> sources but can't first install zlib, but from the packaging viewpoint
>> having included copies is a bad thing.? Yes, it shouldn't get used, but
>> if a dependency isn't declared it would be hidden or not provided and
>> then be used anyway.
>>
>> I therefore think it would be good to consider removing the vendored
>> copies, or at least requiring explicit config to turn them on.? (I just
>> looked in the sources for how to build and didn't find it in README.? I
>> know I have figured out how to build and this isn't a request for help,
>> but in terms of the cmake migration the instructions are missing.)? It
>> looks like internal will just be used if zlib is not found.
>>
>> I wonder if it's still really necessary/helpful to have included libs
>> like zlib.
> 
> I wondered whether it made a difference to driver plugins and "DLL hell"
> - the PNG driver uses zlib/libz and libpng -
> but it seems that we outlaw building gdriver plugins and internal 
> libraries, so that would not be a reason to keep the internal libraries.
> 

I can confirm the 'DLL hell' on Windows builds, with GDAL's internal 
zlib clashing (even with trying to disable all references to the 
internal code).

-jeff


-- 
Jeff McKenna
GatewayGeo: Developers of MS4W, MapServer Consulting and Training
co-founder of FOSS4G
http://gatewaygeo.com/

From even.rouault at spatialys.com  Thu Apr  7 09:57:47 2022
From: even.rouault at spatialys.com (Even Rouault)
Date: Thu, 7 Apr 2022 18:57:47 +0200
Subject: [gdal-dev] CMake: add a
 GDAL_USE_INTERNAL_LIBS=ON/OFF/WHEN_NO_EXTERNAL variable [was Re: zlib
 vulnerability CVE-2018-25032 affecting GAL]
In-Reply-To: <rmir169f3co.fsf@s1.lexort.com>
References: <CAB05kcy7QrJu-AAkgk-YUOCJF0QoZoA9o7AEFUeV6+fhUx5=AA@mail.gmail.com>
 <26c53728-10f6-638a-be86-50cac42757b6@spatialys.com>
 <rmir169f3co.fsf@s1.lexort.com>
Message-ID: <b43a9f36-0d9f-600e-e3b3-425a7f9bce4b@spatialys.com>

https://github.com/OSGeo/gdal/pull/5594 should hopefully make everybody 
happy (if such a thing is possible)

Le 07/04/2022 ? 15:08, Greg Troxel a ?crit?:
> Even Rouault <even.rouault at spatialys.com> writes:
>
>> Most GDAL binary distributions don't use that internal copy but the
>> external zlib library provided by the operating system / distribution
>> channel.
> I realize you are accomodating people who can somehow get and build gdal
> sources but can't first install zlib, but from the packaging viewpoint
> having included copies is a bad thing.  Yes, it shouldn't get used, but
> if a dependency isn't declared it would be hidden or not provided and
> then be used anyway.
>
> I therefore think it would be good to consider removing the vendored
> copies, or at least requiring explicit config to turn them on.  (I just
> looked in the sources for how to build and didn't find it in README.  I
> know I have figured out how to build and this isn't a request for help,
> but in terms of the cmake migration the instructions are missing.)  It
> looks like internal will just be used if zlib is not found.
>
> I wonder if it's still really necessary/helpful to have included libs
> like zlib.

-- 
http://www.spatialys.com
My software is free, but my time generally not.


From kmskavi at gmail.com  Fri Apr  8 06:36:41 2022
From: kmskavi at gmail.com (Kavitha K)
Date: Fri, 8 Apr 2022 19:06:41 +0530
Subject: [gdal-dev] gdal with stack smash protection
Message-ID: <CACLbJJcXRXVP3t0OwcEPfc2BmbvY3vNPq+eUu=1v4H7_HBgV+g@mail.gmail.com>

Hi All,

I m looking for gdal with build support - stack smash protection

please confirm whether it is supported with stack smash protection

if yes, which version is supported?

Thanks,
Kavitha
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220408/35d9ab52/attachment.html>

From gdt at lexort.com  Fri Apr  8 06:50:36 2022
From: gdt at lexort.com (Greg Troxel)
Date: Fri, 08 Apr 2022 09:50:36 -0400
Subject: [gdal-dev] gdal with stack smash protection
In-Reply-To: <CACLbJJcXRXVP3t0OwcEPfc2BmbvY3vNPq+eUu=1v4H7_HBgV+g@mail.gmail.com>
 (Kavitha K.'s message of "Fri, 8 Apr 2022 19:06:41 +0530")
References: <CACLbJJcXRXVP3t0OwcEPfc2BmbvY3vNPq+eUu=1v4H7_HBgV+g@mail.gmail.com>
Message-ID: <rmipmlrbs5v.fsf@s1.lexort.com>


Kavitha K <kmskavi at gmail.com> writes:

> I m looking for gdal with build support - stack smash protection
>
> please confirm whether it is supported with stack smash protection
>
> if yes, which version is supported?

This is the dev list, so I'm assuming

  - you are already comfortable building gdal
  - you have already run the tests on your own builds
  - you intend to try to build and use a version with hardening features
    enabled
  - you realize that you should rerun the tests with the new build

but that beyond that you wonder if there is experience that would
suggest you shouldn't try because it's known to fail or that even if
builds work and tests pass it will be trouble in practice.


I maintain gdal in pkgsrc, and I just checked that gdal has no hardening
annotations, which means it's getting

  Fortify
  SSP at the "strong" level
  RELO at the partial level
  building PIE

  (details at http://www.netbsd.org/docs/pkgsrc/hardening.html)

and with this I don't see test issues that I attribute to this, and I
actually use gdal including with qgis (all on NetBSD 9 amd64) and see no
issues.

I am pretty sure if gdal works without SSP and fails with that this
would be viewed as a bug by the gdal community, but my guess is you
won't find that, because I haven't, and probably any such issues have
been long fixed.

Greg
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 194 bytes
Desc: not available
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220408/7cc8ec2b/attachment.sig>

From schwehr at gmail.com  Fri Apr  8 09:13:46 2022
From: schwehr at gmail.com (Kurt Schwehr)
Date: Fri, 8 Apr 2022 09:13:46 -0700
Subject: [gdal-dev] gdal with stack smash protection
In-Reply-To: <rmipmlrbs5v.fsf@s1.lexort.com>
References: <CACLbJJcXRXVP3t0OwcEPfc2BmbvY3vNPq+eUu=1v4H7_HBgV+g@mail.gmail.com>
 <rmipmlrbs5v.fsf@s1.lexort.com>
Message-ID: <CACmBxyt9ame-TZJorQvn_tH9tAsWh_=b4HudxKQN-Y5QE4xJqA@mail.gmail.com>

I have can confirm that most vanilla hardening available with llvm works
for the core of gdal at around version 2.4.   Can't speak for most drivers
or newer versions, but I would guess that the core is fine with hardening
for newer versions.

Note: binary add-ons are not likely to play well.

On Fri, Apr 8, 2022, 6:51 AM Greg Troxel <gdt at lexort.com> wrote:

>
> Kavitha K <kmskavi at gmail.com> writes:
>
> > I m looking for gdal with build support - stack smash protection
> >
> > please confirm whether it is supported with stack smash protection
> >
> > if yes, which version is supported?
>
> This is the dev list, so I'm assuming
>
>   - you are already comfortable building gdal
>   - you have already run the tests on your own builds
>   - you intend to try to build and use a version with hardening features
>     enabled
>   - you realize that you should rerun the tests with the new build
>
> but that beyond that you wonder if there is experience that would
> suggest you shouldn't try because it's known to fail or that even if
> builds work and tests pass it will be trouble in practice.
>
>
> I maintain gdal in pkgsrc, and I just checked that gdal has no hardening
> annotations, which means it's getting
>
>   Fortify
>   SSP at the "strong" level
>   RELO at the partial level
>   building PIE
>
>   (details at http://www.netbsd.org/docs/pkgsrc/hardening.html)
>
> and with this I don't see test issues that I attribute to this, and I
> actually use gdal including with qgis (all on NetBSD 9 amd64) and see no
> issues.
>
> I am pretty sure if gdal works without SSP and fails with that this
> would be viewed as a bug by the gdal community, but my guess is you
> won't find that, because I haven't, and probably any such issues have
> been long fixed.
>
> Greg
> _______________________________________________
> gdal-dev mailing list
> gdal-dev at lists.osgeo.org
> https://lists.osgeo.org/mailman/listinfo/gdal-dev
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220408/c40bff23/attachment.html>

From j1 at jimenezshaw.com  Mon Apr 11 02:58:16 2022
From: j1 at jimenezshaw.com (Javier Jimenez Shaw)
Date: Mon, 11 Apr 2022 11:58:16 +0200
Subject: [gdal-dev] format for a boolean raster
Message-ID: <CADRrdKsQorXRdLudxbrcPKR8_gYj4B25UN_cJY1iRibRK_3X9A@mail.gmail.com>

Hi

This question is about "best practices" to create a GeoTIFF with boolean
data.

I have to create a GeoTIFF with single band boolean data (yes/no), but also
with invalid pixels (out of area of interest, my data is not a rectangle).
For the "invalid pixels" I was thinking on using No-data-value, but not
sure.

What is the best format/configuration for that?

The final destination are people with a GIS viewer, like QGIS.

Thanks.
Javier
.___ ._ ..._ .. . ._.  .___ .. __ . _. . __..  ... .... ._ .__
Entre dos pensamientos racionales
hay infinitos pensamientos irracionales.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220411/c5b0f0db/attachment.html>

From adamgutonski at protonmail.com  Mon Apr 11 10:13:16 2022
From: adamgutonski at protonmail.com (adamgutonski)
Date: Mon, 11 Apr 2022 17:13:16 +0000
Subject: [gdal-dev] Add coded field domains to file geodatabase
Message-ID: <vYVPa2jR3jCcv3vc1SgMWKxIOCM0mCX-K_kJH8pOAZnStxv4PAopeOpE9h5COKy5KjD2RFyIin287CiAS85bQKmeLvB6W-_q006I2DQzuUY=@protonmail.com>

I am wondering how can one add a coded field domain to a file geodatabase using the FileGDB driver and File GDB API? Anytime I call AddFieldDomain it returns false:

>>> coded_domain = ogr.CreateCodedFieldDomain("name", "desc", ogr.OFTString, ogr.OFSTNone, {1:'LOW'})
>>> driver = gdal.GetDriverByName("FileGDB")
>>> datasource = driver.Create(r'C:\output\test_domains.gdb', 0, 0, 0)
>>> datasource.AddFieldDomain(coded_domain)
False
>>> datasource.TestCapability(ogr.ODsCAddFieldDomain)
False

The documentation suggests that the FileGDB driver is capable of supporting domains as of 3.3: https://gdal.org/drivers/vector/filegdb.html?highlight=domains#field-domains

I am using gdal version 3.4.2.

Am I adding the domain incorrectly, or does this mean that domains are not supported with the FileGDB driver?

Thank you,
Adam Gutonski
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220411/eba3b526/attachment.html>

From even.rouault at spatialys.com  Mon Apr 11 10:33:34 2022
From: even.rouault at spatialys.com (Even Rouault)
Date: Mon, 11 Apr 2022 19:33:34 +0200
Subject: [gdal-dev] Add coded field domains to file geodatabase
In-Reply-To: <vYVPa2jR3jCcv3vc1SgMWKxIOCM0mCX-K_kJH8pOAZnStxv4PAopeOpE9h5COKy5KjD2RFyIin287CiAS85bQKmeLvB6W-_q006I2DQzuUY=@protonmail.com>
References: <vYVPa2jR3jCcv3vc1SgMWKxIOCM0mCX-K_kJH8pOAZnStxv4PAopeOpE9h5COKy5KjD2RFyIin287CiAS85bQKmeLvB6W-_q006I2DQzuUY=@protonmail.com>
Message-ID: <bf1cce13-7435-52e4-4679-eb1d75fc72e8@spatialys.com>

Adam,

I've just clarified the doc to explain that it is read-only for the 
FileGDB driver.

The FileGDB SDK itself seems to have support for writing too, but this 
isn't implemented in the driver currently. Left as an exercise to the 
contributor as one says.

Even

Le 11/04/2022 ? 19:13, adamgutonski via gdal-dev a ?crit?:
> I am wondering how can one add a coded field domain to a file 
> geodatabase using the FileGDB driver and File GDB API?? Anytime I call 
> AddFieldDomain it returns false:
>
> >>> coded_domain = ogr.CreateCodedFieldDomain("name", "desc", 
> ogr.OFTString, ogr.OFSTNone, {1:'LOW'})
> >>> driver = gdal.GetDriverByName("FileGDB")
> >>> datasource = driver.Create(r'C:\output\test_domains.gdb', 0, 0, 0)
> *>>> datasource.AddFieldDomain(coded_domain)*
> *False*
> *>>> datasource.TestCapability(ogr.ODsCAddFieldDomain)
> False
> *
>
> The documentation suggests that the FileGDB driver is capable of 
> supporting domains as of 3.3: 
> https://gdal.org/drivers/vector/filegdb.html?highlight=domains#field-domains
>
> I am using gdal version 3.4.2.
>
> Am I adding the domain incorrectly, or does this mean that domains are 
> not supported with the FileGDB driver?
>
> Thank you,
> Adam Gutonski
>
> _______________________________________________
> gdal-dev mailing list
> gdal-dev at lists.osgeo.org
> https://lists.osgeo.org/mailman/listinfo/gdal-dev

-- 
http://www.spatialys.com
My software is free, but my time generally not.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220411/b9c3d750/attachment.html>

From nik at nikosalexandris.net  Wed Apr 13 05:43:12 2022
From: nik at nikosalexandris.net (Nikos Alexandris)
Date: Wed, 13 Apr 2022 14:43:12 +0200
Subject: [gdal-dev] Merge in-memory datasets
Message-ID: <20220413124312.o5tomsoggfyd6qml@imap.dreamhost.com>

Dear all,

I am trying to make use of in-memory datasets (to avoid creating
temporary files). Is it possible to merge two raster maps (read-in as
in-memory objects) and write out a netCDF file? `gdal_merge.py` seems
not to work with such objects, is it?

I am trying to improve a workflow (this one 
https://gis.stackexchange.com/a/426391/5256, or simpler the first 'part' 
of it, asked here: https://gis.stackexchange.com/q/427983/5256), in 
terms of speed mostly. For example, while `gdal_translate` commands can 
benefit from in-memory datasets (as shown in many Q&As and elsewhere 
Python scripts using GDAL's Python API), I can't find any example for 
`gdal_merge.py`, nor for `gdal_calc.py`.

Note rasterio's support for In-Memory files:
https://rasterio.readthedocs.io/en/latest/topics/memory-files.html.
However, it is known that support for writing netCDF files isn't great!
(See also:
https://rasterio.readthedocs.io/en/latest/topics/writing.html#supported-drivers)

Sorry for 'cross-posting' and kind regards, Nikos

From sean.gillies at gmail.com  Wed Apr 13 12:53:01 2022
From: sean.gillies at gmail.com (Sean Gillies)
Date: Wed, 13 Apr 2022 13:53:01 -0600
Subject: [gdal-dev] GDALWarpAppOptionsNew and GDALWarp usage?
Message-ID: <CAOodmJpJpV=Axe9eTZX7VR6OX=x1HgWwMfmtd4tsAHmBQh7YHw@mail.gmail.com>

Hi all,

I'm trying to figure out how to use the GDALWarp function from
gdalwarp_lib.cpp. It looks like it takes a pointer to a GDALWarpAppOptions
structure that is parsed from a string list, basically gdalwarp's argv,
right?

I'm able to get it to warp data, but the options, specifically the
resampling option, don't seem to be passed into the warper. The output is
the same for all resampling values.

Here's my C usage (Cython, actually, but translates to C).

    cdef GDALWarpAppOptions *warp_options = NULL
    cdef char **argv = NULL

    try:

        argv = CSLAddString(argv, <const char *>"lolwut")
        resampling_opt_value = Resampling(resampling).name  # like
"bilinear"
        argv = CSLAddString(argv, <const char *>"-r")
        argv = CSLAddString(argv, <const char *>resampling_opt_value)
        ...
        CSLPrint(argv, NULL)
        warp_options = GDALWarpAppOptionsNew(argv, NULL)
        output_ds = GDALWarp(
            NULL,
            dst_dataset,
            1,
            src_datasets,
            warp_options,
            NULL
        )
    finally:
        ...

The printed output, my argv, is

    lolwut
    -r
    bilinear

Does GDALWarpAppOptionsNew expect more values at the head of the command
line? Is that why it is missing "-r"? Or is my string list made up of the
wrong kind of strings? Documentation examples of building the arguments for
GDALWarp are scarce. I'd be super grateful for help from anyone who has got
code this to work.

Thanks,

-- 
Sean Gillies
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220413/93130be5/attachment.html>

From even.rouault at spatialys.com  Wed Apr 13 13:09:58 2022
From: even.rouault at spatialys.com (Even Rouault)
Date: Wed, 13 Apr 2022 22:09:58 +0200
Subject: [gdal-dev] GDALWarpAppOptionsNew and GDALWarp usage?
In-Reply-To: <CAOodmJpJpV=Axe9eTZX7VR6OX=x1HgWwMfmtd4tsAHmBQh7YHw@mail.gmail.com>
References: <CAOodmJpJpV=Axe9eTZX7VR6OX=x1HgWwMfmtd4tsAHmBQh7YHw@mail.gmail.com>
Message-ID: <c459f102-5089-9100-3027-490c007713ea@spatialys.com>

Sean,

This looks fine, except for the argv[0] value, "lolwut". What is that 
supposed to be ? I assume GDALWarpAppOptionsNew() fails on that and 
returns NULL.

The obvious demo for using GDALWarp() is the gdalwarp binary itself: 
https://github.com/OSGeo/gdal/blob/master/apps/gdalwarp_bin.cpp

The COG driver is also a user of it, perhaps more illustrative than the 
above : 
https://github.com/OSGeo/gdal/blob/master/frmts/gtiff/cogdriver.cpp#L552

Even

Le 13/04/2022 ? 21:53, Sean Gillies a ?crit?:
> Hi all,
>
> I'm trying to figure out how to use the GDALWarp function from 
> gdalwarp_lib.cpp. It looks like it takes a pointer to a 
> GDALWarpAppOptions structure that is parsed from a string list, 
> basically gdalwarp's argv, right?
>
> I'm able to get it to warp data, but the options, specifically the 
> resampling option, don't seem to be passed into the warper. The output 
> is the same for all resampling values.
>
> Here's my C usage (Cython, actually, but translates to C).
>
> ? ? cdef GDALWarpAppOptions *warp_options = NULL
> ? ? cdef char **argv = NULL
> ? ? try:
> ? ? ? ? argv = CSLAddString(argv, <const char *>"lolwut")
> ? ? ? ? resampling_opt_value = Resampling(resampling).name # like 
> "bilinear"
> ? ? ? ? argv = CSLAddString(argv, <const char *>"-r")
> ? ? ? ? argv = CSLAddString(argv, <const char *>resampling_opt_value)
> ? ? ? ? ...
> ? ? ? ? CSLPrint(argv, NULL)
> ? ? ? ? warp_options = GDALWarpAppOptionsNew(argv, NULL)
> ? ? ? ? output_ds = GDALWarp(
> ? ? ? ? ? ? NULL,
> ? ? ? ? ? ? dst_dataset,
> ? ? ? ? ? ? 1,
> ? ? ? ? ? ? src_datasets,
> ? ? ? ? ? ? warp_options,
> ? ? ? ? ? ? NULL
> ? ? ? ? )
> ? ? finally:
> ? ? ? ? ...
>
> The printed output, my argv, is
>
> ? ? lolwut
> ? ? -r
> ? ? bilinear
>
> Does GDALWarpAppOptionsNew expect more values at the head of the 
> command line? Is that why it is missing "-r"? Or is my string list 
> made up of the wrong kind of strings? Documentation examples of 
> building the arguments for GDALWarp are scarce. I'd be super grateful 
> for help from anyone who has got code this to work.
>
> Thanks,
>
> -- 
> Sean Gillies
>
> _______________________________________________
> gdal-dev mailing list
> gdal-dev at lists.osgeo.org
> https://lists.osgeo.org/mailman/listinfo/gdal-dev

-- 
http://www.spatialys.com
My software is free, but my time generally not.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220413/023bbe2c/attachment.html>

From sean.gillies at gmail.com  Wed Apr 13 13:36:03 2022
From: sean.gillies at gmail.com (Sean Gillies)
Date: Wed, 13 Apr 2022 14:36:03 -0600
Subject: [gdal-dev] GDALWarpAppOptionsNew and GDALWarp usage?
In-Reply-To: <c459f102-5089-9100-3027-490c007713ea@spatialys.com>
References: <CAOodmJpJpV=Axe9eTZX7VR6OX=x1HgWwMfmtd4tsAHmBQh7YHw@mail.gmail.com>
 <c459f102-5089-9100-3027-490c007713ea@spatialys.com>
Message-ID: <CAOodmJqs5HD+N+0T4xw-uXjrNUBqWNQGCt15J4R+S4mCqXwspg@mail.gmail.com>

Thanks, Even!

When I checked the return of GDALWarpAppOptionsNew() and the error stack, I
found that the problem was that I'd been adding an unexpected "-wt
Unknown". After screening that out, I'm getting the resampling I expect.

On Wed, Apr 13, 2022 at 2:10 PM Even Rouault <even.rouault at spatialys.com>
wrote:

> Sean,
>
> This looks fine, except for the argv[0] value, "lolwut". What is that
> supposed to be ? I assume GDALWarpAppOptionsNew() fails on that and returns
> NULL.
>
> The obvious demo for using GDALWarp() is the gdalwarp binary itself:
> https://github.com/OSGeo/gdal/blob/master/apps/gdalwarp_bin.cpp
>
> The COG driver is also a user of it, perhaps more illustrative than the
> above :
> https://github.com/OSGeo/gdal/blob/master/frmts/gtiff/cogdriver.cpp#L552
>
> Even
> Le 13/04/2022 ? 21:53, Sean Gillies a ?crit :
>
> Hi all,
>
> I'm trying to figure out how to use the GDALWarp function from
> gdalwarp_lib.cpp. It looks like it takes a pointer to a GDALWarpAppOptions
> structure that is parsed from a string list, basically gdalwarp's argv,
> right?
>
> I'm able to get it to warp data, but the options, specifically the
> resampling option, don't seem to be passed into the warper. The output is
> the same for all resampling values.
>
> Here's my C usage (Cython, actually, but translates to C).
>
>     cdef GDALWarpAppOptions *warp_options = NULL
>     cdef char **argv = NULL
>
>     try:
>
>
>         argv = CSLAddString(argv, <const char *>"lolwut")
>         resampling_opt_value = Resampling(resampling).name  # like
> "bilinear"
>         argv = CSLAddString(argv, <const char *>"-r")
>         argv = CSLAddString(argv, <const char *>resampling_opt_value)
>         ...
>         CSLPrint(argv, NULL)
>         warp_options = GDALWarpAppOptionsNew(argv, NULL)
>         output_ds = GDALWarp(
>             NULL,
>             dst_dataset,
>             1,
>             src_datasets,
>             warp_options,
>             NULL
>         )
>     finally:
>         ...
>
> The printed output, my argv, is
>
>     lolwut
>     -r
>     bilinear
>
> Does GDALWarpAppOptionsNew expect more values at the head of the command
> line? Is that why it is missing "-r"? Or is my string list made up of the
> wrong kind of strings? Documentation examples of building the arguments for
> GDALWarp are scarce. I'd be super grateful for help from anyone who has got
> code this to work.
>
> Thanks,
>
>
-- 
Sean Gillies
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220413/f3d621cd/attachment.html>

From huebenthal at uxis.de  Fri Apr 15 04:27:50 2022
From: huebenthal at uxis.de (=?UTF-8?Q?Frank_H=c3=bcbenthal?=)
Date: Fri, 15 Apr 2022 13:27:50 +0200
Subject: [gdal-dev] GetProjectionRef returns invalid projection
Message-ID: <72c74e84-4a94-e980-3a22-e23ae44a050b@uxis.de>

I use GDAL C++ to load GeoTIFF files. Since I moved to GDAL 3.4 I have 
problems to get the projection string from some (not all) of these 
GeoTIFF files. With GDAL 3.2 still something like this was returned:

PROJCS["WGS 84 / Pseudo-Mercator",GEOGCS["WGS 
84",DATUM["WGS_1984",SPHEROID["WGS 
84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4326"]],PROJECTION["Mercator_1SP"],PARAMETER["central_meridian",0],PARAMETER["scale_factor",1],PARAMETER["false_easting",0],PARAMETER["false_northing",0],UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH],EXTENSION["PROJ4","+proj=merc 
+a=6378137 +b=6378137 +lat_ts=0 +lon_0=0 +x_0=0 +y_0=0 +k=1 +units=m 
+nadgrids=@null +wktext +no_defs"],AUTHORITY["EPSG","3857"]]

With GDAL 3.4 I get for the same map file only this:

"LOCAL_CS["WGS 84 / 
Pseudo-Mercator",UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH],AUTHORITY["EPSG","3857"]]"

I use the projection to create finally a transformation, but 
OGRCreateCoordinateTransformation returns NULL with the short string 
from GDAL 3.4 while it was still working with 3.2.

Best regards,

Frank



From even.rouault at spatialys.com  Fri Apr 15 04:41:57 2022
From: even.rouault at spatialys.com (Even Rouault)
Date: Fri, 15 Apr 2022 13:41:57 +0200
Subject: [gdal-dev] GetProjectionRef returns invalid projection
In-Reply-To: <72c74e84-4a94-e980-3a22-e23ae44a050b@uxis.de>
References: <72c74e84-4a94-e980-3a22-e23ae44a050b@uxis.de>
Message-ID: <8b90217e-78fc-a07d-e1fd-d8d5bfaf4c7c@spatialys.com>

Frank,

please provide a link to such file

Even

Le 15/04/2022 ? 13:27, Frank H?benthal a ?crit?:
> I use GDAL C++ to load GeoTIFF files. Since I moved to GDAL 3.4 I have 
> problems to get the projection string from some (not all) of these 
> GeoTIFF files. With GDAL 3.2 still something like this was returned:
>
> PROJCS["WGS 84 / Pseudo-Mercator",GEOGCS["WGS 
> 84",DATUM["WGS_1984",SPHEROID["WGS 
> 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4326"]],PROJECTION["Mercator_1SP"],PARAMETER["central_meridian",0],PARAMETER["scale_factor",1],PARAMETER["false_easting",0],PARAMETER["false_northing",0],UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH],EXTENSION["PROJ4","+proj=merc 
> +a=6378137 +b=6378137 +lat_ts=0 +lon_0=0 +x_0=0 +y_0=0 +k=1 +units=m 
> +nadgrids=@null +wktext +no_defs"],AUTHORITY["EPSG","3857"]]
>
> With GDAL 3.4 I get for the same map file only this:
>
> "LOCAL_CS["WGS 84 / 
> Pseudo-Mercator",UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH],AUTHORITY["EPSG","3857"]]"
>
> I use the projection to create finally a transformation, but 
> OGRCreateCoordinateTransformation returns NULL with the short string 
> from GDAL 3.4 while it was still working with 3.2.
>
> Best regards,
>
> Frank
>
>
> _______________________________________________
> gdal-dev mailing list
> gdal-dev at lists.osgeo.org
> https://lists.osgeo.org/mailman/listinfo/gdal-dev

-- 
http://www.spatialys.com
My software is free, but my time generally not.


From huebenthal at uxis.de  Fri Apr 15 04:52:54 2022
From: huebenthal at uxis.de (=?UTF-8?Q?Frank_H=c3=bcbenthal?=)
Date: Fri, 15 Apr 2022 13:52:54 +0200
Subject: [gdal-dev] GetProjectionRef returns invalid projection
In-Reply-To: <8b90217e-78fc-a07d-e1fd-d8d5bfaf4c7c@spatialys.com>
References: <72c74e84-4a94-e980-3a22-e23ae44a050b@uxis.de>
 <8b90217e-78fc-a07d-e1fd-d8d5bfaf4c7c@spatialys.com>
Message-ID: <276555cc-d35f-b393-6fe4-1cadc1f31e7e@uxis.de>

Here it is: https://easyupload.io/rg2ltd

Unfortunately It is rather big (36MB).

Best regards,

Frank

Am 15.04.2022 um 13:41 schrieb Even Rouault:
> Frank,
>
> please provide a link to such file
>
> Even
>
> Le 15/04/2022 ? 13:27, Frank H?benthal a ?crit?:
>> I use GDAL C++ to load GeoTIFF files. Since I moved to GDAL 3.4 I 
>> have problems to get the projection string from some (not all) of 
>> these GeoTIFF files. With GDAL 3.2 still something like this was 
>> returned:
>>
>> PROJCS["WGS 84 / Pseudo-Mercator",GEOGCS["WGS 
>> 84",DATUM["WGS_1984",SPHEROID["WGS 
>> 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4326"]],PROJECTION["Mercator_1SP"],PARAMETER["central_meridian",0],PARAMETER["scale_factor",1],PARAMETER["false_easting",0],PARAMETER["false_northing",0],UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH],EXTENSION["PROJ4","+proj=merc 
>> +a=6378137 +b=6378137 +lat_ts=0 +lon_0=0 +x_0=0 +y_0=0 +k=1 +units=m 
>> +nadgrids=@null +wktext +no_defs"],AUTHORITY["EPSG","3857"]]
>>
>> With GDAL 3.4 I get for the same map file only this:
>>
>> "LOCAL_CS["WGS 84 / 
>> Pseudo-Mercator",UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH],AUTHORITY["EPSG","3857"]]"
>>
>> I use the projection to create finally a transformation, but 
>> OGRCreateCoordinateTransformation returns NULL with the short string 
>> from GDAL 3.4 while it was still working with 3.2.
>>
>> Best regards,
>>
>> Frank
>>
>>
>> _______________________________________________
>> gdal-dev mailing list
>> gdal-dev at lists.osgeo.org
>> https://lists.osgeo.org/mailman/listinfo/gdal-dev
>


From even.rouault at spatialys.com  Fri Apr 15 05:08:51 2022
From: even.rouault at spatialys.com (Even Rouault)
Date: Fri, 15 Apr 2022 14:08:51 +0200
Subject: [gdal-dev] GetProjectionRef returns invalid projection
In-Reply-To: <276555cc-d35f-b393-6fe4-1cadc1f31e7e@uxis.de>
References: <72c74e84-4a94-e980-3a22-e23ae44a050b@uxis.de>
 <8b90217e-78fc-a07d-e1fd-d8d5bfaf4c7c@spatialys.com>
 <276555cc-d35f-b393-6fe4-1cadc1f31e7e@uxis.de>
Message-ID: <4f1ae98f-fdd2-5624-177b-e484cf88e5dd@spatialys.com>

Tihs works fine for me:

$ python -c "from osgeo import gdal; ds= 
gdal.Open('/home/even/T?l?chargements/OFM.tif'); 
print(ds.GetProjectionRef())"
PROJCS["WGS 84 / Pseudo-Mercator",GEOGCS["WGS 
84",DATUM["WGS_1984",SPHEROID["WGS 
84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4326"]],PROJECTION["Mercator_1SP"],PARAMETER["central_meridian",0],PARAMETER["scale_factor",1],PARAMETER["false_easting",0],PARAMETER["false_northing",0],UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH],EXTENSION["PROJ4","+proj=merc 
+a=6378137 +b=6378137 +lat_ts=0 +lon_0=0 +x_0=0 +y_0=0 +k=1 +units=m 
+nadgrids=@null +wktext +no_defs"],AUTHORITY["EPSG","3857"]]

However I suspect that your issue is that PROJ is misconfigured and 
cannot find its proj.db. Make sure that PROJ_LIB points to the directory 
where proj.db is located

I can reproduce your issue by setting a wrong path for PROJ_LIB:

$ PROJ_LIB=/unexisting/path python -c "from osgeo import gdal; ds= 
gdal.Open('/home/even/T?l?chargements/OFM.tif'); 
print(ds.GetProjectionRef())"
Warning 1: PROJ: proj_create_from_database: Cannot find proj.db
Warning 1: The definition of projected CRS EPSG:3857 got from GeoTIFF 
keys is not the same as the one from the EPSG registry, which may cause 
issues during reprojection operations. Set GTIFF_SRS_SOURCE 
configuration option to EPSG to use official parameters (overriding the 
ones from GeoTIFF keys), or to GEOKEYS to use custom values from GeoTIFF 
keys and drop the EPSG code.
LOCAL_CS["WGS 84 / 
Pseudo-Mercator",UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH]]

Le 15/04/2022 ? 13:52, Frank H?benthal a ?crit?:
> Here it is: https://easyupload.io/rg2ltd
>
> Unfortunately It is rather big (36MB).
>
> Best regards,
>
> Frank
>
> Am 15.04.2022 um 13:41 schrieb Even Rouault:
>> Frank,
>>
>> please provide a link to such file
>>
>> Even
>>
>> Le 15/04/2022 ? 13:27, Frank H?benthal a ?crit?:
>>> I use GDAL C++ to load GeoTIFF files. Since I moved to GDAL 3.4 I 
>>> have problems to get the projection string from some (not all) of 
>>> these GeoTIFF files. With GDAL 3.2 still something like this was 
>>> returned:
>>>
>>> PROJCS["WGS 84 / Pseudo-Mercator",GEOGCS["WGS 
>>> 84",DATUM["WGS_1984",SPHEROID["WGS 
>>> 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4326"]],PROJECTION["Mercator_1SP"],PARAMETER["central_meridian",0],PARAMETER["scale_factor",1],PARAMETER["false_easting",0],PARAMETER["false_northing",0],UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH],EXTENSION["PROJ4","+proj=merc 
>>> +a=6378137 +b=6378137 +lat_ts=0 +lon_0=0 +x_0=0 +y_0=0 +k=1 +units=m 
>>> +nadgrids=@null +wktext +no_defs"],AUTHORITY["EPSG","3857"]]
>>>
>>> With GDAL 3.4 I get for the same map file only this:
>>>
>>> "LOCAL_CS["WGS 84 / 
>>> Pseudo-Mercator",UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH],AUTHORITY["EPSG","3857"]]"
>>>
>>> I use the projection to create finally a transformation, but 
>>> OGRCreateCoordinateTransformation returns NULL with the short string 
>>> from GDAL 3.4 while it was still working with 3.2.
>>>
>>> Best regards,
>>>
>>> Frank
>>>
>>>
>>> _______________________________________________
>>> gdal-dev mailing list
>>> gdal-dev at lists.osgeo.org
>>> https://lists.osgeo.org/mailman/listinfo/gdal-dev
>>
>
> _______________________________________________
> gdal-dev mailing list
> gdal-dev at lists.osgeo.org
> https://lists.osgeo.org/mailman/listinfo/gdal-dev

-- 
http://www.spatialys.com
My software is free, but my time generally not.


From huebenthal at uxis.de  Fri Apr 15 05:24:44 2022
From: huebenthal at uxis.de (=?UTF-8?Q?Frank_H=c3=bcbenthal?=)
Date: Fri, 15 Apr 2022 14:24:44 +0200
Subject: [gdal-dev] GetProjectionRef returns invalid projection
In-Reply-To: <4f1ae98f-fdd2-5624-177b-e484cf88e5dd@spatialys.com>
References: <72c74e84-4a94-e980-3a22-e23ae44a050b@uxis.de>
 <8b90217e-78fc-a07d-e1fd-d8d5bfaf4c7c@spatialys.com>
 <276555cc-d35f-b393-6fe4-1cadc1f31e7e@uxis.de>
 <4f1ae98f-fdd2-5624-177b-e484cf88e5dd@spatialys.com>
Message-ID: <774fe670-18a6-5678-f2a0-de5c5c02e1c0@uxis.de>

Perfect. This works.

Thank you,

Frank

Am 15.04.2022 um 14:08 schrieb Even Rouault:
> Tihs works fine for me:
>
> $ python -c "from osgeo import gdal; ds= 
> gdal.Open('/home/even/T?l?chargements/OFM.tif'); 
> print(ds.GetProjectionRef())"
> PROJCS["WGS 84 / Pseudo-Mercator",GEOGCS["WGS 
> 84",DATUM["WGS_1984",SPHEROID["WGS 
> 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4326"]],PROJECTION["Mercator_1SP"],PARAMETER["central_meridian",0],PARAMETER["scale_factor",1],PARAMETER["false_easting",0],PARAMETER["false_northing",0],UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH],EXTENSION["PROJ4","+proj=merc 
> +a=6378137 +b=6378137 +lat_ts=0 +lon_0=0 +x_0=0 +y_0=0 +k=1 +units=m 
> +nadgrids=@null +wktext +no_defs"],AUTHORITY["EPSG","3857"]]
>
> However I suspect that your issue is that PROJ is misconfigured and 
> cannot find its proj.db. Make sure that PROJ_LIB points to the 
> directory where proj.db is located
>
> I can reproduce your issue by setting a wrong path for PROJ_LIB:
>
> $ PROJ_LIB=/unexisting/path python -c "from osgeo import gdal; ds= 
> gdal.Open('/home/even/T?l?chargements/OFM.tif'); 
> print(ds.GetProjectionRef())"
> Warning 1: PROJ: proj_create_from_database: Cannot find proj.db
> Warning 1: The definition of projected CRS EPSG:3857 got from GeoTIFF 
> keys is not the same as the one from the EPSG registry, which may 
> cause issues during reprojection operations. Set GTIFF_SRS_SOURCE 
> configuration option to EPSG to use official parameters (overriding 
> the ones from GeoTIFF keys), or to GEOKEYS to use custom values from 
> GeoTIFF keys and drop the EPSG code.
> LOCAL_CS["WGS 84 / 
> Pseudo-Mercator",UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH]]
>
> Le 15/04/2022 ? 13:52, Frank H?benthal a ?crit?:
>> Here it is: https://easyupload.io/rg2ltd
>>
>> Unfortunately It is rather big (36MB).
>>
>> Best regards,
>>
>> Frank
>>
>> Am 15.04.2022 um 13:41 schrieb Even Rouault:
>>> Frank,
>>>
>>> please provide a link to such file
>>>
>>> Even
>>>
>>> Le 15/04/2022 ? 13:27, Frank H?benthal a ?crit?:
>>>> I use GDAL C++ to load GeoTIFF files. Since I moved to GDAL 3.4 I 
>>>> have problems to get the projection string from some (not all) of 
>>>> these GeoTIFF files. With GDAL 3.2 still something like this was 
>>>> returned:
>>>>
>>>> PROJCS["WGS 84 / Pseudo-Mercator",GEOGCS["WGS 
>>>> 84",DATUM["WGS_1984",SPHEROID["WGS 
>>>> 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4326"]],PROJECTION["Mercator_1SP"],PARAMETER["central_meridian",0],PARAMETER["scale_factor",1],PARAMETER["false_easting",0],PARAMETER["false_northing",0],UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH],EXTENSION["PROJ4","+proj=merc 
>>>> +a=6378137 +b=6378137 +lat_ts=0 +lon_0=0 +x_0=0 +y_0=0 +k=1 
>>>> +units=m +nadgrids=@null +wktext +no_defs"],AUTHORITY["EPSG","3857"]]
>>>>
>>>> With GDAL 3.4 I get for the same map file only this:
>>>>
>>>> "LOCAL_CS["WGS 84 / 
>>>> Pseudo-Mercator",UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH],AUTHORITY["EPSG","3857"]]"
>>>>
>>>> I use the projection to create finally a transformation, but 
>>>> OGRCreateCoordinateTransformation returns NULL with the short 
>>>> string from GDAL 3.4 while it was still working with 3.2.
>>>>
>>>> Best regards,
>>>>
>>>> Frank
>>>>
>>>>
>>>> _______________________________________________
>>>> gdal-dev mailing list
>>>> gdal-dev at lists.osgeo.org
>>>> https://lists.osgeo.org/mailman/listinfo/gdal-dev
>>>
>>
>> _______________________________________________
>> gdal-dev mailing list
>> gdal-dev at lists.osgeo.org
>> https://lists.osgeo.org/mailman/listinfo/gdal-dev
>


From even.rouault at spatialys.com  Sat Apr 16 09:55:40 2022
From: even.rouault at spatialys.com (Even Rouault)
Date: Sat, 16 Apr 2022 18:55:40 +0200
Subject: [gdal-dev] Add coded field domains to file geodatabase
In-Reply-To: <bf1cce13-7435-52e4-4679-eb1d75fc72e8@spatialys.com>
References: <vYVPa2jR3jCcv3vc1SgMWKxIOCM0mCX-K_kJH8pOAZnStxv4PAopeOpE9h5COKy5KjD2RFyIin287CiAS85bQKmeLvB6W-_q006I2DQzuUY=@protonmail.com>
 <bf1cce13-7435-52e4-4679-eb1d75fc72e8@spatialys.com>
Message-ID: <7c1828eb-b897-3f42-61d0-87b8899bba6c@spatialys.com>

It turns out that I needed that feature, hence 
https://github.com/OSGeo/gdal/pull/5620

Le 11/04/2022 ? 19:33, Even Rouault a ?crit?:
>
> Adam,
>
> I've just clarified the doc to explain that it is read-only for the 
> FileGDB driver.
>
> The FileGDB SDK itself seems to have support for writing too, but this 
> isn't implemented in the driver currently. Left as an exercise to the 
> contributor as one says.
>
> Even
>
> Le 11/04/2022 ? 19:13, adamgutonski via gdal-dev a ?crit?:
>> I am wondering how can one add a coded field domain to a file 
>> geodatabase using the FileGDB driver and File GDB API? Anytime I call 
>> AddFieldDomain it returns false:
>>
>> >>> coded_domain = ogr.CreateCodedFieldDomain("name", "desc", ogr.OFTString, 
>> ogr.OFSTNone, {1:'LOW'})
>> >>> driver = gdal.GetDriverByName("FileGDB")
>> >>> datasource = driver.Create(r'C:\output\test_domains.gdb', 0, 0, 0)
>> *>>> datasource.AddFieldDomain(coded_domain)*
>> *False*
>> *>>> datasource.TestCapability(ogr.ODsCAddFieldDomain)
>> False
>> *
>>
>> The documentation suggests that the FileGDB driver is capable of 
>> supporting domains as of 3.3: 
>> https://gdal.org/drivers/vector/filegdb.html?highlight=domains#field-domains
>>
>> I am using gdal version 3.4.2.
>>
>> Am I adding the domain incorrectly, or does this mean that domains 
>> are not supported with the FileGDB driver?
>>
>> Thank you,
>> Adam Gutonski
>>
>> _______________________________________________
>> gdal-dev mailing list
>> gdal-dev at lists.osgeo.org
>> https://lists.osgeo.org/mailman/listinfo/gdal-dev
> -- 
> http://www.spatialys.com
> My software is free, but my time generally not.
>
> _______________________________________________
> gdal-dev mailing list
> gdal-dev at lists.osgeo.org
> https://lists.osgeo.org/mailman/listinfo/gdal-dev

-- 
http://www.spatialys.com
My software is free, but my time generally not.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220416/50ba7138/attachment.html>

From jluis at ualg.pt  Mon Apr 18 09:31:23 2022
From: jluis at ualg.pt (=?iso-8859-1?Q?Joaquim_Manuel_Freire_Lu=EDs?=)
Date: Mon, 18 Apr 2022 16:31:23 +0000
Subject: [gdal-dev] -if netCDF fails to read Matlab .mat files
Message-ID: <AM6PR04MB39593931D7B47162A9CE6FA0A6F39@AM6PR04MB3959.eurprd04.prod.outlook.com>

Hi,

Matlab creates files in what they call the "mat" format (with a .mat extension) but which in fact are files in netCDF/HDF

And indeed we can read them ... but only if renamed to .nc

Why is this failing?

$ gdalinfo -if netCDF windaa.mat
ERROR 4: `windaa.mat' not recognized as a supported file format.
gdalinfo failed - unable to open 'windaa.mat'.

But this works

$ gdalinfo windaa.nc
Driver: netCDF/Network Common Data Format
Files: windaa.nc
Size is 512, 512
Subdatasets:
  SUBDATASET_1_NAME=NETCDF:"windaa.nc":u
  SUBDATASET_1_DESC=[15x41x35] u (64-bit floating-point)
  SUBDATASET_2_NAME=NETCDF:"windaa.nc":v
  SUBDATASET_2_DESC=[15x41x35] v (64-bit floating-point)
...



Joaquim
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220418/78ec0acf/attachment.html>

From even.rouault at spatialys.com  Mon Apr 18 11:06:30 2022
From: even.rouault at spatialys.com (Even Rouault)
Date: Mon, 18 Apr 2022 20:06:30 +0200
Subject: [gdal-dev] -if netCDF fails to read Matlab .mat files
In-Reply-To: <AM6PR04MB39593931D7B47162A9CE6FA0A6F39@AM6PR04MB3959.eurprd04.prod.outlook.com>
References: <AM6PR04MB39593931D7B47162A9CE6FA0A6F39@AM6PR04MB3959.eurprd04.prod.outlook.com>
Message-ID: <ba84fdf6-135c-05e8-15f5-9231c517152a@spatialys.com>

Joaquim,

https://www.loc.gov/preservation/digital/formats/fdd/fdd000440.shtml 
mentions HDF5, but I don't know if it is HDF5-only or the HDF5 profile 
of netCDF 4.

 From my tests trying to simulate the situation (I don't have a .mat 
file handy),

- if it is netCDF 3 file (non-HDF5), the netCDF driver should be able to 
open even with the .mat extension

- if it is netCDF 4 file,

 ??? - and the netCDF and HDF5 drivers are present, the HDF5 driver will 
kick in. The reason is that there's no easy way to recognize a HDF5 file 
from a netCDF 4 from their header, so the netCDF driver has a white list 
of extensions (which doesn't include .mat) when it sees the HDF5 driver 
is there, since it knows it is a potential fallback

 ??? - and only the netCDF driver is present, it will kick in

 ??? - and only the HDF5 driver is present, it will kick in

So basically I don't reproduce your issue.

You should be able to force the NetCDF driver by prefixing "NETCDF:" to 
the filename (the -if flag only restricts drivers which are probed. it 
doesn't force a driver to accept a file)

Even


Le 18/04/2022 ? 18:31, Joaquim Manuel Freire Lu?s a ?crit?:
>
> Hi,
>
> Matlab creates files in what they call the ?mat? format (with a .mat 
> extension) but which in fact are files in netCDF/HDF
>
> And indeed we can read them ? but only if renamed to .nc
>
> Why is this failing?
>
> $ gdalinfo -if netCDF windaa.mat
>
> ERROR 4: `windaa.mat' not recognized as a supported file format.
>
> gdalinfo failed - unable to open 'windaa.mat'.
>
> But this works
>
> $ gdalinfo windaa.nc
>
> Driver: netCDF/Network Common Data Format
>
> Files: windaa.nc
>
> Size is 512, 512
>
> Subdatasets:
>
> SUBDATASET_1_NAME=NETCDF:"windaa.nc":u
>
> SUBDATASET_1_DESC=[15x41x35] u (64-bit floating-point)
>
> SUBDATASET_2_NAME=NETCDF:"windaa.nc":v
>
> SUBDATASET_2_DESC=[15x41x35] v (64-bit floating-point)
>
> ?
>
> Joaquim
>
>
> _______________________________________________
> gdal-dev mailing list
> gdal-dev at lists.osgeo.org
> https://lists.osgeo.org/mailman/listinfo/gdal-dev

-- 
http://www.spatialys.com
My software is free, but my time generally not.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220418/429894fa/attachment.html>

From jluis at ualg.pt  Mon Apr 18 11:50:14 2022
From: jluis at ualg.pt (=?utf-8?B?Sm9hcXVpbSBNYW51ZWwgRnJlaXJlIEx1w61z?=)
Date: Mon, 18 Apr 2022 18:50:14 +0000
Subject: [gdal-dev] -if netCDF fails to read Matlab .mat files
In-Reply-To: <ba84fdf6-135c-05e8-15f5-9231c517152a@spatialys.com>
References: <AM6PR04MB39593931D7B47162A9CE6FA0A6F39@AM6PR04MB3959.eurprd04.prod.outlook.com>
 <ba84fdf6-135c-05e8-15f5-9231c517152a@spatialys.com>
Message-ID: <AM6PR04MB39599BF5A04769A878D5E473A6F39@AM6PR04MB3959.eurprd04.prod.outlook.com>

Strange, I don?t see an HDF5 driver in my list of drivers but I do include it in the GDAL build.

$ gdalinfo --formats | grep HDF
  HDF4 -raster,multidimensional raster- (ros): Hierarchical Data Format Release 4
  HDF4Image -raster- (rw+): HDF4 Dataset

Also

$ gdalinfo "NETCDF:"U.mat
ERROR 4: NETCDF:U.mat: No such file or directory
gdalinfo failed - unable to open 'NETCDF:U.mat'.

I?m sending attached the U.mat file

From: Even Rouault <even.rouault at spatialys.com>
Sent: Monday, April 18, 2022 7:07 PM
To: Joaquim Manuel Freire Lu?s <jluis at ualg.pt>; gdal-dev at lists.osgeo.org
Subject: Re: [gdal-dev] -if netCDF fails to read Matlab .mat files


Joaquim,

https://www.loc.gov/preservation/digital/formats/fdd/fdd000440.shtml mentions HDF5, but I don't know if it is HDF5-only or the HDF5 profile of netCDF 4.

From my tests trying to simulate the situation (I don't have a .mat file handy),

- if it is netCDF 3 file (non-HDF5), the netCDF driver should be able to open even with the .mat extension

- if it is netCDF 4 file,

    - and the netCDF and HDF5 drivers are present, the HDF5 driver will kick in. The reason is that there's no easy way to recognize a HDF5 file from a netCDF 4 from their header, so the netCDF driver has a white list of extensions (which doesn't include .mat) when it sees the HDF5 driver is there, since it knows it is a potential fallback

    - and only the netCDF driver is present, it will kick in

    - and only the HDF5 driver is present, it will kick in

So basically I don't reproduce your issue.

You should be able to force the NetCDF driver by prefixing "NETCDF:" to the filename (the -if flag only restricts drivers which are probed. it doesn't force a driver to accept a file)

Even


Le 18/04/2022 ? 18:31, Joaquim Manuel Freire Lu?s a ?crit :
Hi,

Matlab creates files in what they call the ?mat? format (with a .mat extension) but which in fact are files in netCDF/HDF

And indeed we can read them ? but only if renamed to .nc

Why is this failing?

$ gdalinfo -if netCDF windaa.mat
ERROR 4: `windaa.mat' not recognized as a supported file format.
gdalinfo failed - unable to open 'windaa.mat'.

But this works

$ gdalinfo windaa.nc
Driver: netCDF/Network Common Data Format
Files: windaa.nc
Size is 512, 512
Subdatasets:
  SUBDATASET_1_NAME=NETCDF:"windaa.nc":u
  SUBDATASET_1_DESC=[15x41x35] u (64-bit floating-point)
  SUBDATASET_2_NAME=NETCDF:"windaa.nc":v
  SUBDATASET_2_DESC=[15x41x35] v (64-bit floating-point)
?



Joaquim



_______________________________________________

gdal-dev mailing list

gdal-dev at lists.osgeo.org<mailto:gdal-dev at lists.osgeo.org>

https://lists.osgeo.org/mailman/listinfo/gdal-dev

--

http://www.spatialys.com

My software is free, but my time generally not.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220418/403f88f1/attachment-0001.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: U.mat
Type: application/octet-stream
Size: 47503 bytes
Desc: U.mat
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220418/403f88f1/attachment-0001.obj>

From jluis at ualg.pt  Mon Apr 18 11:54:36 2022
From: jluis at ualg.pt (=?utf-8?B?Sm9hcXVpbSBNYW51ZWwgRnJlaXJlIEx1w61z?=)
Date: Mon, 18 Apr 2022 18:54:36 +0000
Subject: [gdal-dev] -if netCDF fails to read Matlab .mat files
In-Reply-To: <AM6PR04MB39599BF5A04769A878D5E473A6F39@AM6PR04MB3959.eurprd04.prod.outlook.com>
References: <AM6PR04MB39593931D7B47162A9CE6FA0A6F39@AM6PR04MB3959.eurprd04.prod.outlook.com>
 <ba84fdf6-135c-05e8-15f5-9231c517152a@spatialys.com>
 <AM6PR04MB39599BF5A04769A878D5E473A6F39@AM6PR04MB3959.eurprd04.prod.outlook.com>
Message-ID: <AM6PR04MB39599656C2A42872A7FB8271A6F39@AM6PR04MB3959.eurprd04.prod.outlook.com>

I think the mail system refused the mat file in my previous mail. Let?s try with it zipped.


From: gdal-dev <gdal-dev-bounces at lists.osgeo.org> On Behalf Of Joaquim Manuel Freire Lu?s
Sent: Monday, April 18, 2022 7:50 PM
To: Even Rouault <even.rouault at spatialys.com>; gdal-dev at lists.osgeo.org
Subject: Re: [gdal-dev] -if netCDF fails to read Matlab .mat files

Strange, I don?t see an HDF5 driver in my list of drivers but I do include it in the GDAL build.

$ gdalinfo --formats | grep HDF
  HDF4 -raster,multidimensional raster- (ros): Hierarchical Data Format Release 4
  HDF4Image -raster- (rw+): HDF4 Dataset

Also

$ gdalinfo "NETCDF:"U.mat
ERROR 4: NETCDF:U.mat: No such file or directory
gdalinfo failed - unable to open 'NETCDF:U.mat'.

I?m sending attached the U.mat file

From: Even Rouault <even.rouault at spatialys.com<mailto:even.rouault at spatialys.com>>
Sent: Monday, April 18, 2022 7:07 PM
To: Joaquim Manuel Freire Lu?s <jluis at ualg.pt<mailto:jluis at ualg.pt>>; gdal-dev at lists.osgeo.org<mailto:gdal-dev at lists.osgeo.org>
Subject: Re: [gdal-dev] -if netCDF fails to read Matlab .mat files


Joaquim,

https://www.loc.gov/preservation/digital/formats/fdd/fdd000440.shtml mentions HDF5, but I don't know if it is HDF5-only or the HDF5 profile of netCDF 4.

From my tests trying to simulate the situation (I don't have a .mat file handy),

- if it is netCDF 3 file (non-HDF5), the netCDF driver should be able to open even with the .mat extension

- if it is netCDF 4 file,

    - and the netCDF and HDF5 drivers are present, the HDF5 driver will kick in. The reason is that there's no easy way to recognize a HDF5 file from a netCDF 4 from their header, so the netCDF driver has a white list of extensions (which doesn't include .mat) when it sees the HDF5 driver is there, since it knows it is a potential fallback

    - and only the netCDF driver is present, it will kick in

    - and only the HDF5 driver is present, it will kick in

So basically I don't reproduce your issue.

You should be able to force the NetCDF driver by prefixing "NETCDF:" to the filename (the -if flag only restricts drivers which are probed. it doesn't force a driver to accept a file)

Even


Le 18/04/2022 ? 18:31, Joaquim Manuel Freire Lu?s a ?crit :
Hi,

Matlab creates files in what they call the ?mat? format (with a .mat extension) but which in fact are files in netCDF/HDF

And indeed we can read them ? but only if renamed to .nc

Why is this failing?

$ gdalinfo -if netCDF windaa.mat
ERROR 4: `windaa.mat' not recognized as a supported file format.
gdalinfo failed - unable to open 'windaa.mat'.

But this works

$ gdalinfo windaa.nc
Driver: netCDF/Network Common Data Format
Files: windaa.nc
Size is 512, 512
Subdatasets:
  SUBDATASET_1_NAME=NETCDF:"windaa.nc":u
  SUBDATASET_1_DESC=[15x41x35] u (64-bit floating-point)
  SUBDATASET_2_NAME=NETCDF:"windaa.nc":v
  SUBDATASET_2_DESC=[15x41x35] v (64-bit floating-point)
?



Joaquim


_______________________________________________

gdal-dev mailing list

gdal-dev at lists.osgeo.org<mailto:gdal-dev at lists.osgeo.org>

https://lists.osgeo.org/mailman/listinfo/gdal-dev

--

http://www.spatialys.com

My software is free, but my time generally not.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220418/93ebbdb9/attachment-0001.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: U.mat.zip
Type: application/x-zip-compressed
Size: 42149 bytes
Desc: U.mat.zip
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220418/93ebbdb9/attachment-0001.bin>

From even.rouault at spatialys.com  Mon Apr 18 13:01:49 2022
From: even.rouault at spatialys.com (Even Rouault)
Date: Mon, 18 Apr 2022 22:01:49 +0200
Subject: [gdal-dev] -if netCDF fails to read Matlab .mat files
In-Reply-To: <AM6PR04MB39599BF5A04769A878D5E473A6F39@AM6PR04MB3959.eurprd04.prod.outlook.com>
References: <AM6PR04MB39593931D7B47162A9CE6FA0A6F39@AM6PR04MB3959.eurprd04.prod.outlook.com>
 <ba84fdf6-135c-05e8-15f5-9231c517152a@spatialys.com>
 <AM6PR04MB39599BF5A04769A878D5E473A6F39@AM6PR04MB3959.eurprd04.prod.outlook.com>
Message-ID: <8e8c23fa-d729-6aca-ffa5-2c086120c80d@spatialys.com>


Le 18/04/2022 ? 20:50, Joaquim Manuel Freire Lu?s a ?crit?:
>
> Strange, I don?t see an HDF5 driver in my list of drivers but I do 
> include it in the GDAL build.
>
Misconfigured / non-detected dependency then
>
> $ gdalinfo "NETCDF:"U.mat
>
> ERROR 4: NETCDF:U.mat: No such file or directory
>
> gdalinfo failed - unable to open 'NETCDF:U.mat'.
>
https://github.com/OSGeo/gdal/pull/5629 fixes automatic detection by 
either netCDF or HDF5 drivers, and makes NETCDF: prefixing ignore 
extension check for that particular formation of HDF5 files whose 
signature is at offset 512.

Even

-- 
http://www.spatialys.com
My software is free, but my time generally not.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220418/ff71725a/attachment.html>

From stefano.iacovella at gmail.com  Mon Apr 18 23:55:35 2022
From: stefano.iacovella at gmail.com (Stefano Iacovella)
Date: Tue, 19 Apr 2022 08:55:35 +0200
Subject: [gdal-dev] Using a custom operation with
 osr.CoordinateTransformation
Message-ID: <CAG9OqYrCTWhPwXGE+qGQEH3SVhtQpODtjee5nJ0o8BAjCGtjjg@mail.gmail.com>

Dear all,

I am wondering which is the best approach to use a custom operation to
transform coordinates from a datum to another.
I have managed to use a custom operation by creating a specific pipeline
and set it as:

options = osr.CoordinateTransformationOptions()

options.SetOperation('''+proj=pipeline
                        +step +proj=axisswap +order=2,1
                        +step +proj=unitconvert +xy_in=deg +xy_out=rad
+step +proj=push +v_3
                        +step +proj=cart +ellps=intl
                        +step +proj=helmert +x=-104.1 +y=-49.1 +z=-9.9
+rx=0.971 +ry=-2.917 +rz=0.714 +s=-11.68  +convention=position_vector
                        +step +inv +proj=cart +ellps=WGS84
                        +step +proj=pop +v_3
                        +step +proj=unitconvert
                        +xy_in=rad
                        +xy_out=deg
                        +step +proj=axisswap +order=2,1''')

transform = osr.CoordinateTransformation(source_crs, target_crs, options)

I have a few custom operation, then I would like to understand if it is
possible to include their definitions in the PROJ configuration, with a
different autorithy then EPSG. So that I can use it in something similar to:

options.SetOperation('urn:ogc:def:coordinateOperation:my_authority::900001')

I tried to read documentation of GDAl and PROJ but didn't find, probably my
fault, any clear explanation on how to customize configuration to include
custom operation.

Thank you all in advance for any hint

Stefano
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220419/339c3a4b/attachment.html>

From even.rouault at spatialys.com  Tue Apr 19 03:17:03 2022
From: even.rouault at spatialys.com (Even Rouault)
Date: Tue, 19 Apr 2022 12:17:03 +0200
Subject: [gdal-dev] Using a custom operation with
 osr.CoordinateTransformation
In-Reply-To: <CAG9OqYrCTWhPwXGE+qGQEH3SVhtQpODtjee5nJ0o8BAjCGtjjg@mail.gmail.com>
References: <CAG9OqYrCTWhPwXGE+qGQEH3SVhtQpODtjee5nJ0o8BAjCGtjjg@mail.gmail.com>
Message-ID: <54e78c90-8cda-6129-50d1-33c6c51742f8@spatialys.com>

Hi,

looking at 
https://github.com/OSGeo/PROJ/blob/master/data/sql/other_transformation_custom.sql 
should give you good hints on how to add custom transformations, here 
under a PROJ authority

If you want to create your own authority, you'll also need to do similar 
steps as the ones dones for the NKG authority in 
https://github.com/OSGeo/PROJ/blob/master/data/sql/nkg_post_customizations.sql

Even

Le 19/04/2022 ? 08:55, Stefano Iacovella a ?crit?:
> Dear all,
>
> I am wondering which is the best approach to use a custom operation to 
> transform coordinates from a datum to another.
> I have managed to use a custom operation by creating a specific 
> pipeline and set it as:
>
> options = osr.CoordinateTransformationOptions()
>
> options.SetOperation('''+proj=pipeline
> ? ? ? ? ? ? ? ? ? ? ? ? +step +proj=axisswap +order=2,1
> ? ? ? ? ? ? ? ? ? ? ? ? +step +proj=unitconvert +xy_in=deg +xy_out=rad 
> +step +proj=push +v_3
> ? ? ? ? ? ? ? ? ? ? ? ? +step +proj=cart +ellps=intl
> ? ? ? ? ? ? ? ? ? ? ? ? +step +proj=helmert +x=-104.1 +y=-49.1 +z=-9.9 
> +rx=0.971 +ry=-2.917 +rz=0.714 +s=-11.68 ?+convention=position_vector
> ? ? ? ? ? ? ? ? ? ? ? ? +step +inv +proj=cart +ellps=WGS84
> ? ? ? ? ? ? ? ? ? ? ? ? +step +proj=pop +v_3
> ? ? ? ? ? ? ? ? ? ? ? ? +step +proj=unitconvert
> ? ? ? ? ? ? ? ? ? ? ? ? +xy_in=rad
> ? ? ? ? ? ? ? ? ? ? ? ? +xy_out=deg
> ? ? ? ? ? ? ? ? ? ? ? ? +step +proj=axisswap +order=2,1''')
>
> transform = osr.CoordinateTransformation(source_crs, target_crs, options)
>
> I have a few custom operation, then I would like to understand if it 
> is possible to include their definitions in the PROJ configuration, 
> with a different autorithy then EPSG. So that I can use it in 
> something similar to:
>
> options.SetOperation('urn:ogc:def:coordinateOperation:my_authority::900001')
>
> I tried to read documentation of GDAl and PROJ but didn't find, 
> probably my fault, any clear explanation on how to customize 
> configuration to include custom operation.
>
> Thank you all in advance for any hint
>
> Stefano
>
>
> _______________________________________________
> gdal-dev mailing list
> gdal-dev at lists.osgeo.org
> https://lists.osgeo.org/mailman/listinfo/gdal-dev

-- 
http://www.spatialys.com
My software is free, but my time generally not.


From stefano.iacovella at gmail.com  Tue Apr 19 04:32:32 2022
From: stefano.iacovella at gmail.com (Stefano Iacovella)
Date: Tue, 19 Apr 2022 13:32:32 +0200
Subject: [gdal-dev] Using a custom operation with
 osr.CoordinateTransformation
In-Reply-To: <54e78c90-8cda-6129-50d1-33c6c51742f8@spatialys.com>
References: <CAG9OqYrCTWhPwXGE+qGQEH3SVhtQpODtjee5nJ0o8BAjCGtjjg@mail.gmail.com>
 <54e78c90-8cda-6129-50d1-33c6c51742f8@spatialys.com>
Message-ID: <CAG9OqYorOF4SEA_MVD4KZpPCRXfTS0PfZH3oABe=r=o=i+cifQ@mail.gmail.com>

Both examples look like what I was looking for

Thanks a lot Even :)

Stefano

Il giorno mar 19 apr 2022 alle ore 12:17 Even Rouault <
even.rouault at spatialys.com> ha scritto:

> Hi,
>
> looking at
>
> https://github.com/OSGeo/PROJ/blob/master/data/sql/other_transformation_custom.sql
> should give you good hints on how to add custom transformations, here
> under a PROJ authority
>
> If you want to create your own authority, you'll also need to do similar
> steps as the ones dones for the NKG authority in
>
> https://github.com/OSGeo/PROJ/blob/master/data/sql/nkg_post_customizations.sql
>
> Even
>
> Le 19/04/2022 ? 08:55, Stefano Iacovella a ?crit :
> > Dear all,
> >
> > I am wondering which is the best approach to use a custom operation to
> > transform coordinates from a datum to another.
> > I have managed to use a custom operation by creating a specific
> > pipeline and set it as:
> >
> > options = osr.CoordinateTransformationOptions()
> >
> > options.SetOperation('''+proj=pipeline
> >                         +step +proj=axisswap +order=2,1
> >                         +step +proj=unitconvert +xy_in=deg +xy_out=rad
> > +step +proj=push +v_3
> >                         +step +proj=cart +ellps=intl
> >                         +step +proj=helmert +x=-104.1 +y=-49.1 +z=-9.9
> > +rx=0.971 +ry=-2.917 +rz=0.714 +s=-11.68  +convention=position_vector
> >                         +step +inv +proj=cart +ellps=WGS84
> >                         +step +proj=pop +v_3
> >                         +step +proj=unitconvert
> >                         +xy_in=rad
> >                         +xy_out=deg
> >                         +step +proj=axisswap +order=2,1''')
> >
> > transform = osr.CoordinateTransformation(source_crs, target_crs, options)
> >
> > I have a few custom operation, then I would like to understand if it
> > is possible to include their definitions in the PROJ configuration,
> > with a different autorithy then EPSG. So that I can use it in
> > something similar to:
> >
> >
> options.SetOperation('urn:ogc:def:coordinateOperation:my_authority::900001')
> >
> > I tried to read documentation of GDAl and PROJ but didn't find,
> > probably my fault, any clear explanation on how to customize
> > configuration to include custom operation.
> >
> > Thank you all in advance for any hint
> >
> > Stefano
> >
> >
> > _______________________________________________
> > gdal-dev mailing list
> > gdal-dev at lists.osgeo.org
> > https://lists.osgeo.org/mailman/listinfo/gdal-dev
>
> --
> http://www.spatialys.com
> My software is free, but my time generally not.
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220419/ccc75542/attachment.html>

From stephenknox73 at gmail.com  Wed Apr 20 01:50:29 2022
From: stephenknox73 at gmail.com (Stephen Knox)
Date: Wed, 20 Apr 2022 09:50:29 +0100
Subject: [gdal-dev] GeoParquet / GeoArrow docs
Message-ID: <CAFkojsZ5GEPM43Nu0PgMri1fxEkngfbjR5zY2OUn2ppxOeFt+Q@mail.gmail.com>

Just looked at the docs since the GeoParquet pull request was merged. (
https://gdal.org/drivers/vector/parquet.html)

Wondering if might be useful to add that the Parquet and Arrow Drivers are
only present since version 3.5. I know it's experimental, so not finalised,
but people might be confused to find zero support in 3.4 or whatever
earlier version they are running?

Stephen
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220420/305f7578/attachment.html>

From even.rouault at spatialys.com  Wed Apr 20 02:25:22 2022
From: even.rouault at spatialys.com (Even Rouault)
Date: Wed, 20 Apr 2022 11:25:22 +0200
Subject: [gdal-dev] GeoParquet / GeoArrow docs
In-Reply-To: <CAFkojsZ5GEPM43Nu0PgMri1fxEkngfbjR5zY2OUn2ppxOeFt+Q@mail.gmail.com>
References: <CAFkojsZ5GEPM43Nu0PgMri1fxEkngfbjR5zY2OUn2ppxOeFt+Q@mail.gmail.com>
Message-ID: <c9c8b69b-e5b3-8eac-ebf1-0ef6d81ad5db@spatialys.com>

done

Le 20/04/2022 ? 10:50, Stephen Knox a ?crit?:
> Just looked at the docs since the GeoParquet pull request was merged. 
> (https://gdal.org/drivers/vector/parquet.html)
>
> Wondering if might be useful to add that the Parquet and Arrow Drivers 
> are only present since version 3.5. I know it's experimental, so not 
> finalised, but people might be confused to find zero support in 3.4 or 
> whatever earlier version they are running?
>
> Stephen
>
> _______________________________________________
> gdal-dev mailing list
> gdal-dev at lists.osgeo.org
> https://lists.osgeo.org/mailman/listinfo/gdal-dev

-- 
http://www.spatialys.com
My software is free, but my time generally not.


From Matt.Wilkie at yukon.ca  Thu Apr 21 12:04:32 2022
From: Matt.Wilkie at yukon.ca (Matt.Wilkie at yukon.ca)
Date: Thu, 21 Apr 2022 19:04:32 +0000
Subject: [gdal-dev] Convert to min containing bit depth?
Message-ID: <2df417d95f794570a2f34c1c3fde008d@yukon.ca>

Idea for a small but useful python tool: scan image for min/max values and convert to smallest possible bit depth without losing values. Surely someone has done something like this already. Any suggestions for where to look for prior art?

thanks.
Matt Wilkie
Geomatics Developer & Administrator
Environment | Technology, Innovation and Mapping
T 867-667-8133 | Yukon.ca<http://yukon.ca/>
Hours: 08:30-16:30, Mon-Wed: Office, Thu: Remote, Fri: Away.

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220421/6bcaf31a/attachment.html>

From idan at miara.com  Thu Apr 21 12:13:55 2022
From: idan at miara.com (Idan Miara)
Date: Thu, 21 Apr 2022 22:13:55 +0300
Subject: [gdal-dev] Convert to min containing bit depth?
In-Reply-To: <2df417d95f794570a2f34c1c3fde008d@yukon.ca>
References: <2df417d95f794570a2f34c1c3fde008d@yukon.ca>
Message-ID: <CAEDrt38oCGRqNb9xLby-QWyipLH9uy6LcgzDGT5eVm8NbaJb_A@mail.gmail.com>

Not exactly what you asked for but similar idea - rgb2pct.py

On Thu, 21 Apr 2022, 22:04 , <Matt.Wilkie at yukon.ca> wrote:

> Idea for a small but useful python tool: scan image for min/max values and
> convert to smallest possible bit depth without losing values. Surely
> someone has done something like this already. Any suggestions for where to
> look for prior art?
>
>
>
> thanks.
>
> *Matt Wilkie*
>
> Geomatics Developer & Administrator
>
> Environment | Technology, Innovation and Mapping
>
> T 867-667-8133 | *Yukon.ca <http://yukon.ca/>*
>
> *Hours: 08:30-16:30, Mon-Wed: Office, Thu: Remote, Fri: Away.*
>
>
> _______________________________________________
> gdal-dev mailing list
> gdal-dev at lists.osgeo.org
> https://lists.osgeo.org/mailman/listinfo/gdal-dev
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220421/0a25a083/attachment.html>

From mwtoews at gmail.com  Thu Apr 21 20:04:31 2022
From: mwtoews at gmail.com (Mike Taves)
Date: Fri, 22 Apr 2022 15:04:31 +1200
Subject: [gdal-dev] Convert to min containing bit depth?
In-Reply-To: <2df417d95f794570a2f34c1c3fde008d@yukon.ca>
References: <2df417d95f794570a2f34c1c3fde008d@yukon.ca>
Message-ID: <CAM2FmMpzWmbpo6C7Jg2BOuFPBK8C-iEOXCxhX4-pkwoQKXtOSQ@mail.gmail.com>

On Fri, 22 Apr 2022 at 07:05, <Matt.Wilkie at yukon.ca> wrote:
>
> Idea for a small but useful python tool: scan image for min/max values and convert to smallest possible bit depth without losing values. Surely someone has done something like this already. Any suggestions for where to look for prior art?

This is driver-specific, as certain formats expect multiples of 2
(e.g.) NBITS=1/2/4. But for GTiff, what I typically use in a script is
to find the maximum value, then use "ceil(log(maxval, 2))" to get the
number of bits, e.g.:

from math import ceil, log
from osgeo import gdal

maxval = 17  # for example
nbits = ceil(log(maxval, 2))  # 5

drv = gdal.GetDriverByName("GTiff")
opts = [f"NBITS={maxval}"]
ds = drv.Create(fname, nx, ny, 1, gdal.GDT_Byte, opts)
...

similar can be done with rasterio, passing the keyword
"rasterio.open(fname, 'w', ..., nbits=nbits)"

For the drivers that expect NBITS as a multiple of 2:

nbits = 2**ceil(log(nbits, 2))

If nbits is greater than 8, then UInt16 or UInt32 may be required, as
supported by the driver.

From idan at miara.com  Thu Apr 21 23:18:12 2022
From: idan at miara.com (Idan Miara)
Date: Fri, 22 Apr 2022 09:18:12 +0300
Subject: [gdal-dev] Convert to min containing bit depth?
In-Reply-To: <CAM2FmMpzWmbpo6C7Jg2BOuFPBK8C-iEOXCxhX4-pkwoQKXtOSQ@mail.gmail.com>
References: <2df417d95f794570a2f34c1c3fde008d@yukon.ca>
 <CAM2FmMpzWmbpo6C7Jg2BOuFPBK8C-iEOXCxhX4-pkwoQKXtOSQ@mail.gmail.com>
Message-ID: <CAEDrt387vmw=Pxy7FFEnqFtxc4sEPZkVHzZvSis3HpccqQBr7w@mail.gmail.com>

Computing the min value is also requited if you have negative values and
could also be useful If you wanted to optimize that method further by
utilising the offset parameter (and or the scale, but computing the right
combination for an optimize lossless compression could be more expensive).

On Fri, 22 Apr 2022, 06:05 Mike Taves, <mwtoews at gmail.com> wrote:

> On Fri, 22 Apr 2022 at 07:05, <Matt.Wilkie at yukon.ca> wrote:
> >
> > Idea for a small but useful python tool: scan image for min/max values
> and convert to smallest possible bit depth without losing values. Surely
> someone has done something like this already. Any suggestions for where to
> look for prior art?
>
> This is driver-specific, as certain formats expect multiples of 2
> (e.g.) NBITS=1/2/4. But for GTiff, what I typically use in a script is
> to find the maximum value, then use "ceil(log(maxval, 2))" to get the
> number of bits, e.g.:
>
> from math import ceil, log
> from osgeo import gdal
>
> maxval = 17  # for example
> nbits = ceil(log(maxval, 2))  # 5
>
> drv = gdal.GetDriverByName("GTiff")
> opts = [f"NBITS={maxval}"]
> ds = drv.Create(fname, nx, ny, 1, gdal.GDT_Byte, opts)
> ...
>
> similar can be done with rasterio, passing the keyword
> "rasterio.open(fname, 'w', ..., nbits=nbits)"
>
> For the drivers that expect NBITS as a multiple of 2:
>
> nbits = 2**ceil(log(nbits, 2))
>
> If nbits is greater than 8, then UInt16 or UInt32 may be required, as
> supported by the driver.
> _______________________________________________
> gdal-dev mailing list
> gdal-dev at lists.osgeo.org
> https://lists.osgeo.org/mailman/listinfo/gdal-d
> <https://lists.osgeo.org/mailman/listinfo/gdal-dev>e vroom
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220422/14703f9e/attachment.html>

From even.rouault at spatialys.com  Fri Apr 22 02:32:11 2022
From: even.rouault at spatialys.com (Even Rouault)
Date: Fri, 22 Apr 2022 11:32:11 +0200
Subject: [gdal-dev] GDAL 3.4.3 RC1 available
Message-ID: <a88d2959-2cf5-715d-a61f-ec429cf494ec@spatialys.com>

Hi,

I have prepared a GDAL/OGR 3.4.3 release candidate.

Pick up an archive among the following ones (by ascending size):

 ? https://download.osgeo.org/gdal/3.4.3/gdal-3.4.3rc1.tar.xz
 ? https://download.osgeo.org/gdal/3.4.3/gdal-3.4.3rc1.tar.gz
 ? https://download.osgeo.org/gdal/3.4.3/gdal343rc1.zip

A snapshot of the gdalautotest suite is also available :

https://download.osgeo.org/gdal/3.4.3/gdalautotest-3.4.3rc1.tar.gz
 ? https://download.osgeo.org/gdal/3.4.3/gdalautotest-3.4.3rc1.zip

GDAL-GRASS plugin:

 ? https://download.osgeo.org/gdal/3.4.3/gdal-grass-3.4.3.tar.gz

The NEWS file is here :

 ? https://github.com/OSGeo/gdal/blob/v3.4.3RC1/gdal/NEWS.md

I'll call for a vote promoting it to final later next week if no
serious problems are reported before.

Best regards,

Even

-- 
http://www.spatialys.com
My software is free, but my time generally not.


From even.rouault at spatialys.com  Fri Apr 22 07:56:45 2022
From: even.rouault at spatialys.com (Even Rouault)
Date: Fri, 22 Apr 2022 16:56:45 +0200
Subject: [gdal-dev] GDAL 3.4.3 RC2 available (Re: GDAL 3.4.3 RC1 available)
In-Reply-To: <a88d2959-2cf5-715d-a61f-ec429cf494ec@spatialys.com>
References: <a88d2959-2cf5-715d-a61f-ec429cf494ec@spatialys.com>
Message-ID: <d326e87a-635d-14f5-99ed-75412b991fcd@spatialys.com>

I've tagged an RC2 whose only change is in the gdal-grass plugin 
(backport of https://github.com/OSGeo/gdal/pull/5503)

Hence only its corresponding archive is updated:

https://download.osgeo.org/gdal/3.4.3/gdal-grass-3.4.3rc2.tar.gz

Even

Le 22/04/2022 ? 11:32, Even Rouault a ?crit?:
> Hi,
>
> I have prepared a GDAL/OGR 3.4.3 release candidate.
>
> Pick up an archive among the following ones (by ascending size):
>
> ? https://download.osgeo.org/gdal/3.4.3/gdal-3.4.3rc1.tar.xz
> ? https://download.osgeo.org/gdal/3.4.3/gdal-3.4.3rc1.tar.gz
> ? https://download.osgeo.org/gdal/3.4.3/gdal343rc1.zip
>
> A snapshot of the gdalautotest suite is also available :
>
> https://download.osgeo.org/gdal/3.4.3/gdalautotest-3.4.3rc1.tar.gz
> ? https://download.osgeo.org/gdal/3.4.3/gdalautotest-3.4.3rc1.zip
>
> GDAL-GRASS plugin:
>
> ? https://download.osgeo.org/gdal/3.4.3/gdal-grass-3.4.3.tar.gz
>
> The NEWS file is here :
>
> ? https://github.com/OSGeo/gdal/blob/v3.4.3RC1/gdal/NEWS.md
>
> I'll call for a vote promoting it to final later next week if no
> serious problems are reported before.
>
> Best regards,
>
> Even
>
-- 
http://www.spatialys.com
My software is free, but my time generally not.


From Andre.Vautour at Teledyne.com  Fri Apr 22 09:01:00 2022
From: Andre.Vautour at Teledyne.com (=?iso-8859-1?Q?Vautour=2C_Andr=E9_=28INT=29?=)
Date: Fri, 22 Apr 2022 16:01:00 +0000
Subject: [gdal-dev] BAG CRS
Message-ID: <YT3PR01MB493035E1067A542F6673B34E97F79@YT3PR01MB4930.CANPRD01.PROD.OUTLOOK.COM>

Hi all,

It has just come to my attention that the BAG driver in GDAL is writing the CRS with a WKT codeSpace and a WKT 2.0 string as the code. While I am fairly sure we started that incorrect practice here at CARIS with a WKT 1.0 string, this is the first time I've seen a WKT 2.0 string written in there, and I am therefore concerned about interoperability.

I think we can all agree that what makes the most sense is to write an EPSG codebase with the EPSG code if we have it, and I think falling back to a WKT 1.0 string if it is not EPSG is a reasonable fallback if it is not EPSG, given how it has been used in the past, but I am worried that older software won't recognize the WKT 2.0 string.

Would you be willing to take a pull request that does that? Worst-case, would you be fine with changing that WKT 2.0 string to a WKT 1.0 string?

Regards,
Andr?
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220422/8dea2aab/attachment.html>

From even.rouault at spatialys.com  Fri Apr 22 09:21:54 2022
From: even.rouault at spatialys.com (Even Rouault)
Date: Fri, 22 Apr 2022 18:21:54 +0200
Subject: [gdal-dev] BAG CRS
In-Reply-To: <YT3PR01MB493035E1067A542F6673B34E97F79@YT3PR01MB4930.CANPRD01.PROD.OUTLOOK.COM>
References: <YT3PR01MB493035E1067A542F6673B34E97F79@YT3PR01MB4930.CANPRD01.PROD.OUTLOOK.COM>
Message-ID: <ea4db3db-712a-88d9-5f65-bce33057b482@spatialys.com>

Andr?,

I don't confirm this trying:

$ gdal_translate autotest/gcore/data/byte.tif byte.bag

$ gdalinfo byte.bag -mdd xml:BAG | grep PROJCS
 ??????????? <gco:CharacterString>PROJCS["NAD27 / UTM zone 
11N",GEOGCS["NAD27",DATUM["North_American_Datum_1927",SPHEROID["Clarke 
1866",6378206.4,294.978698213898,AUTHORITY["EPSG","7008"]],AUTHORITY["EPSG","6267"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4267"]],PROJECTION["Transverse_Mercator"],PARAMETER["latitude_of_origin",0],PARAMETER["central_meridian",-117],PARAMETER["scale_factor",0.9996],PARAMETER["false_easting",500000],PARAMETER["false_northing",0],UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH],AUTHORITY["EPSG","26711"]]</gco:CharacterString>

This is WKT1

I'm wondering if the confusion might come from looking at the CRS 
reported by gdalinfo, which will always be WKT2 in recent GDAL versions 
whatever the encoding in the source dataset itself ?

Or perhaps you try to write a Geographic 3D CRS ? in which case WKT2 
will be used since there's no WKT1 representation for this

$ gdalwarp -overwrite autotest/gcore/data/byte.tif byte.bag -t_srs 
EPSG:4979 -ot float32

$ gdalinfo byte.bag -mdd xml:BAG | grep GEOGCRS
 ??????????? <gco:CharacterString>GEOGCRS["WGS 84",ENSEMBLE["World 
Geodetic System 1984 ensemble",MEMBER["World Geodetic System 1984 
(Transit)"],MEMBER["World Geodetic System 1984 (G730)"],MEMBER["World 
Geodetic System 1984 (G873)"],MEMBER["World Geodetic System 1984 
(G1150)"],MEMBER["World Geodetic System 1984 (G1674)"],MEMBER["World 
Geodetic System 1984 (G1762)"],MEMBER["World Geodetic System 1984 
(G2139)"],ELLIPSOID["WGS 
84",6378137,298.257223563,LENGTHUNIT["metre",1]],ENSEMBLEACCURACY[2.0]],PRIMEM["Greenwich",0,ANGLEUNIT["degree",0.0174532925199433]],CS[ellipsoidal,3],AXIS["geodetic 
latitude 
(Lat)",north,ORDER[1],ANGLEUNIT["degree",0.0174532925199433]],AXIS["geodetic 
longitude 
(Lon)",east,ORDER[2],ANGLEUNIT["degree",0.0174532925199433]],AXIS["ellipsoidal 
height (h)",up,ORDER[3],LENGTHUNIT["metre",1]], [... snip ....] 
,ID["EPSG",4979]]</gco:CharacterString>

(I see that gdalinfo also issues a "ERROR 1: PROJ: 
proj_create_compound_crs: components of the compound CRS do not belong 
to one of the allowed combinations of 
http://docs.opengeospatial.org/as/18-005r4/18-005r4.html#34" when 
reading this, which I suspect comes from the fact that it tries to 
create a CompoundCRS from this 3D GeogCRS and the "VERT_CS["unknown", 
VERT_DATUM["unknown", 2000]]", so writing 3D GeogCRS isn't really 
appropriate for BAG)

Even

Le 22/04/2022 ? 18:01, Vautour, Andr? (INT) a ?crit?:
>
> Hi all,
>
> It has just come to my attention that the BAG driver in GDAL is 
> writing the CRS with a WKT codeSpace and a WKT 2.0 string as the code. 
> While I am fairly sure we started that incorrect practice here at 
> CARIS with a WKT 1.0 string, this is the first time I?ve seen a WKT 
> 2.0 string written in there, and I am therefore concerned about 
> interoperability.
>
> I think we can all agree that what makes the most sense is to write an 
> EPSG codebase with the EPSG code if we have it, and I think falling 
> back to a WKT 1.0 string if it is not EPSG is a reasonable fallback if 
> it is not EPSG, given how it has been used in the past, but I am 
> worried that older software won?t recognize the WKT 2.0 string.
>
> Would you be willing to take a pull request that does that? 
> Worst-case, would you be fine with changing that WKT 2.0 string to a 
> WKT 1.0 string?
>
> Regards,
>
> Andr?
>
>
> _______________________________________________
> gdal-dev mailing list
> gdal-dev at lists.osgeo.org
> https://lists.osgeo.org/mailman/listinfo/gdal-dev

-- 
http://www.spatialys.com
My software is free, but my time generally not.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220422/380beb12/attachment-0001.html>

From eric.g.younkin at noaa.gov  Fri Apr 22 09:31:28 2022
From: eric.g.younkin at noaa.gov (Eric Younkin - NOAA Federal)
Date: Fri, 22 Apr 2022 12:31:28 -0400
Subject: [gdal-dev] BAG CRS
In-Reply-To: <YT3PR01MB493035E1067A542F6673B34E97F79@YT3PR01MB4930.CANPRD01.PROD.OUTLOOK.COM>
References: <YT3PR01MB493035E1067A542F6673B34E97F79@YT3PR01MB4930.CANPRD01.PROD.OUTLOOK.COM>
Message-ID: <CAFe6qKgYxDXty6XTJ+PkKSH5CCsoPDt6=cg-FMMAWb-ApPubGw@mail.gmail.com>

Just to be clear, I believe we are talking about the vertical wkt string
provided through the VAR_VERT_WKT creation option.  Not the horizontal
coordinate system.

On Fri, Apr 22, 2022 at 12:01 PM Vautour, Andr? (INT) <
Andre.Vautour at teledyne.com> wrote:

> Hi all,
>
>
>
> It has just come to my attention that the BAG driver in GDAL is writing
> the CRS with a WKT codeSpace and a WKT 2.0 string as the code. While I am
> fairly sure we started that incorrect practice here at CARIS with a WKT 1.0
> string, this is the first time I?ve seen a WKT 2.0 string written in there,
> and I am therefore concerned about interoperability.
>
>
>
> I think we can all agree that what makes the most sense is to write an
> EPSG codebase with the EPSG code if we have it, and I think falling back to
> a WKT 1.0 string if it is not EPSG is a reasonable fallback if it is not
> EPSG, given how it has been used in the past, but I am worried that older
> software won?t recognize the WKT 2.0 string.
>
>
>
> Would you be willing to take a pull request that does that? Worst-case,
> would you be fine with changing that WKT 2.0 string to a WKT 1.0 string?
>
>
>
> Regards,
>
> Andr?
>


-- 
Eric Younkin
Physical Scientist
NOAA OCS, Hydrographic Systems and Technology Branch
1315 East-West Highway
N/CS11, Room 6604
Silver Spring, MD 20910
Office: 240-847-8208
Cell: 828-331-8197
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220422/673e3f81/attachment.html>

From Andre.Vautour at Teledyne.com  Fri Apr 22 09:35:37 2022
From: Andre.Vautour at Teledyne.com (=?utf-8?B?VmF1dG91ciwgQW5kcsOpIChJTlQp?=)
Date: Fri, 22 Apr 2022 16:35:37 +0000
Subject: [gdal-dev] BAG CRS
In-Reply-To: <ea4db3db-712a-88d9-5f65-bce33057b482@spatialys.com>
References: <YT3PR01MB493035E1067A542F6673B34E97F79@YT3PR01MB4930.CANPRD01.PROD.OUTLOOK.COM>
 <ea4db3db-712a-88d9-5f65-bce33057b482@spatialys.com>
Message-ID: <YT3PR01MB493069B9A790FDCD3529330C97F79@YT3PR01MB4930.CANPRD01.PROD.OUTLOOK.COM>

Sorry Even,

I should have done more research on my end up front before sending this. A client told us his WKT 2.0 BAG was created with GDAL. Looking at it some more, it was the vertical CRS that was WKT 2.0.

Their vertical CRS looked as follows:
<gco:CharacterString>VERTCRS["ellipse",VDATUM["NAD83(2011) / UTM zone 10N + ellipse"],CS[vertical,1],AXIS["ellipsoid height (h)",up,LENGTHUNIT["metre",1]]]</gco:CharacterString>

Cheers,
Andr?

From: Even Rouault <even.rouault at spatialys.com>
Sent: April 22, 2022 13:22
To: Vautour, Andr? (INT) <Andre.Vautour at Teledyne.com>; gdal-dev at lists.osgeo.org
Subject: Re: [gdal-dev] BAG CRS

External Email

Andr?,

I don't confirm this trying:

$ gdal_translate autotest/gcore/data/byte.tif byte.bag

$ gdalinfo byte.bag -mdd xml:BAG | grep PROJCS
            <gco:CharacterString>PROJCS["NAD27 / UTM zone 11N",GEOGCS["NAD27",DATUM["North_American_Datum_1927",SPHEROID["Clarke 1866",6378206.4,294.978698213898,AUTHORITY["EPSG","7008"]],AUTHORITY["EPSG","6267"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4267"]],PROJECTION["Transverse_Mercator"],PARAMETER["latitude_of_origin",0],PARAMETER["central_meridian",-117],PARAMETER["scale_factor",0.9996],PARAMETER["false_easting",500000],PARAMETER["false_northing",0],UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH],AUTHORITY["EPSG","26711"]]</gco:CharacterString>

This is WKT1

I'm wondering if the confusion might come from looking at the CRS reported by gdalinfo, which will always be WKT2 in recent GDAL versions whatever the encoding in the source dataset itself ?

Or perhaps you try to write a Geographic 3D CRS ? in which case WKT2 will be used since there's no WKT1 representation for this

$ gdalwarp -overwrite autotest/gcore/data/byte.tif byte.bag -t_srs EPSG:4979 -ot float32

$ gdalinfo byte.bag -mdd xml:BAG | grep GEOGCRS
            <gco:CharacterString>GEOGCRS["WGS 84",ENSEMBLE["World Geodetic System 1984 ensemble",MEMBER["World Geodetic System 1984 (Transit)"],MEMBER["World Geodetic System 1984 (G730)"],MEMBER["World Geodetic System 1984 (G873)"],MEMBER["World Geodetic System 1984 (G1150)"],MEMBER["World Geodetic System 1984 (G1674)"],MEMBER["World Geodetic System 1984 (G1762)"],MEMBER["World Geodetic System 1984 (G2139)"],ELLIPSOID["WGS 84",6378137,298.257223563,LENGTHUNIT["metre",1]],ENSEMBLEACCURACY[2.0]],PRIMEM["Greenwich",0,ANGLEUNIT["degree",0.0174532925199433]],CS[ellipsoidal,3],AXIS["geodetic latitude (Lat)",north,ORDER[1],ANGLEUNIT["degree",0.0174532925199433]],AXIS["geodetic longitude (Lon)",east,ORDER[2],ANGLEUNIT["degree",0.0174532925199433]],AXIS["ellipsoidal height (h)",up,ORDER[3],LENGTHUNIT["metre",1]], [... snip ....] ,ID["EPSG",4979]]</gco:CharacterString>

(I see that gdalinfo also issues a "ERROR 1: PROJ: proj_create_compound_crs: components of the compound CRS do not belong to one of the allowed combinations of http://docs.opengeospatial.org/as/18-005r4/18-005r4.html#34" when reading this, which I suspect comes from the fact that it tries to create a CompoundCRS from this 3D GeogCRS and the "VERT_CS["unknown", VERT_DATUM["unknown", 2000]]", so writing 3D GeogCRS isn't really appropriate for BAG)

Even
Le 22/04/2022 ? 18:01, Vautour, Andr? (INT) a ?crit :
Hi all,

It has just come to my attention that the BAG driver in GDAL is writing the CRS with a WKT codeSpace and a WKT 2.0 string as the code. While I am fairly sure we started that incorrect practice here at CARIS with a WKT 1.0 string, this is the first time I?ve seen a WKT 2.0 string written in there, and I am therefore concerned about interoperability.

I think we can all agree that what makes the most sense is to write an EPSG codebase with the EPSG code if we have it, and I think falling back to a WKT 1.0 string if it is not EPSG is a reasonable fallback if it is not EPSG, given how it has been used in the past, but I am worried that older software won?t recognize the WKT 2.0 string.

Would you be willing to take a pull request that does that? Worst-case, would you be fine with changing that WKT 2.0 string to a WKT 1.0 string?

Regards,
Andr?



_______________________________________________

gdal-dev mailing list

gdal-dev at lists.osgeo.org<mailto:gdal-dev at lists.osgeo.org>

https://lists.osgeo.org/mailman/listinfo/gdal-dev

--

http://www.spatialys.com

My software is free, but my time generally not.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220422/98634d33/attachment-0001.html>

From even.rouault at spatialys.com  Fri Apr 22 09:47:17 2022
From: even.rouault at spatialys.com (Even Rouault)
Date: Fri, 22 Apr 2022 18:47:17 +0200
Subject: [gdal-dev] BAG CRS
In-Reply-To: <YT3PR01MB493069B9A790FDCD3529330C97F79@YT3PR01MB4930.CANPRD01.PROD.OUTLOOK.COM>
References: <YT3PR01MB493035E1067A542F6673B34E97F79@YT3PR01MB4930.CANPRD01.PROD.OUTLOOK.COM>
 <ea4db3db-712a-88d9-5f65-bce33057b482@spatialys.com>
 <YT3PR01MB493069B9A790FDCD3529330C97F79@YT3PR01MB4930.CANPRD01.PROD.OUTLOOK.COM>
Message-ID: <75dc5d50-0093-49d3-0a91-0f2532bda034@spatialys.com>

Andr?,

hum ok. it might perhaps be possible that WKT2 could come when extract 
the vertical part but I still can't reproduce that trying:

$ gdal_translate autotest/gcore/data/byte.tif byte.bag -a_srs 
'COMPOUNDCRS["foo",PROJCRS["NAD27 / UTM zone 
11N",BASEGEOGCRS["NAD27",DATUM["North American Datum 
1927",ELLIPSOID["Clarke 
1866",6378206.4,294.978698213898,LENGTHUNIT["metre",1]]],PRIMEM["Greenwich",0,ANGLEUNIT["degree",0.0174532925199433]],ID["EPSG",4267]],CONVERSION["UTM 
zone 11N",METHOD["Transverse 
Mercator",ID["EPSG",9807]],PARAMETER["Latitude of natural 
origin",0,ANGLEUNIT["degree",0.0174532925199433],ID["EPSG",8801]],PARAMETER["Longitude 
of natural 
origin",-117,ANGLEUNIT["degree",0.0174532925199433],ID["EPSG",8802]],PARAMETER["Scale 
factor at natural 
origin",0.9996,SCALEUNIT["unity",1],ID["EPSG",8805]],PARAMETER["False 
easting",500000,LENGTHUNIT["metre",1],ID["EPSG",8806]],PARAMETER["False 
northing",0,LENGTHUNIT["metre",1],ID["EPSG",8807]]],CS[Cartesian,2],AXIS["(E)",east,ORDER[1],LENGTHUNIT["metre",1]],AXIS["(N)",north,ORDER[2],LENGTHUNIT["metre",1]],USAGE[SCOPE["Engineering 
survey, topographic mapping."],AREA["North America - between 120?W and 
114?W - onshore. Canada - Alberta; British Columbia; Northwest 
Territories; Nunavut. Mexico. United States (USA) - California; Idaho; 
Nevada; Oregon; 
Washington."],BBOX[26.93,-120,78.13,-114]],ID["EPSG",26711]],VERTCRS["ellipse",VDATUM["NAD83(2011) 
/ UTM zone 10N + ellipse"],CS[vertical,1],AXIS["ellipsoid height 
(h)",up,LENGTHUNIT["metre",1]]]]'

$ gdalinfo byte.bag -mdd xml:BAG | grep VERT_CS
<gco:CharacterString>VERT_CS["ellipse",VERT_DATUM["NAD83(2011) / UTM 
zone 10N + ellipse",2005],UNIT["metre",1],AXIS["Ellipsoid 
height",UP]]</gco:CharacterString>

(the ,2005 here isn't really appropriate. it should rather be ,2002,? 
but such formulations of CompoundCRS with a VerticalCRS that expressed 
an ellipsoidal height are not ISO-19111 compliant)

Anyway if you can find a way to reproduce the issue with a CRS provided 
through the GetProjection()/SetProjection() API of GDAL, a fix would be 
welcome. If it is the user who provides WKT2 with a manual VAR_VERT_WKT 
option, then I'd say it is their responsibility to provide the right value.

Even

Le 22/04/2022 ? 18:35, Vautour, Andr? (INT) a ?crit?:
>
> Sorry Even,
>
> I should have done more research on my end up front before sending 
> this. A client told us his WKT 2.0 BAG was created with GDAL. Looking 
> at it some more, it was the vertical CRS that was WKT 2.0.
>
> Their vertical CRS looked as follows:
>
> <gco:CharacterString>VERTCRS["ellipse",VDATUM["NAD83(2011) / UTM zone 
> 10N + ellipse"],CS[vertical,1],AXIS["ellipsoid height 
> (h)",up,LENGTHUNIT["metre",1]]]</gco:CharacterString>
>
> Cheers,
>
> Andr?
>
> *From:* Even Rouault <even.rouault at spatialys.com>
> *Sent:* April 22, 2022 13:22
> *To:* Vautour, Andr? (INT) <Andre.Vautour at Teledyne.com>; 
> gdal-dev at lists.osgeo.org
> *Subject:* Re: [gdal-dev] BAG CRS
>
> External Email
>
> Andr?,
>
> I don't confirm this trying:
>
> $ gdal_translate autotest/gcore/data/byte.tif byte.bag
>
> $ gdalinfo byte.bag -mdd xml:BAG | grep PROJCS
> ??????????? <gco:CharacterString>PROJCS["NAD27 / UTM zone 
> 11N",GEOGCS["NAD27",DATUM["North_American_Datum_1927",SPHEROID["Clarke 
> 1866",6378206.4,294.978698213898,AUTHORITY["EPSG","7008"]],AUTHORITY["EPSG","6267"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4267"]],PROJECTION["Transverse_Mercator"],PARAMETER["latitude_of_origin",0],PARAMETER["central_meridian",-117],PARAMETER["scale_factor",0.9996],PARAMETER["false_easting",500000],PARAMETER["false_northing",0],UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH],AUTHORITY["EPSG","26711"]]</gco:CharacterString>
>
> This is WKT1
>
> I'm wondering if the confusion might come from looking at the CRS 
> reported by gdalinfo, which will always be WKT2 in recent GDAL 
> versions whatever the encoding in the source dataset itself ?
>
> Or perhaps you try to write a Geographic 3D CRS ? in which case WKT2 
> will be used since there's no WKT1 representation for this
>
> $ gdalwarp -overwrite autotest/gcore/data/byte.tif byte.bag -t_srs 
> EPSG:4979 -ot float32
>
> $ gdalinfo byte.bag -mdd xml:BAG | grep GEOGCRS
> ??????????? <gco:CharacterString>GEOGCRS["WGS 84",ENSEMBLE["World 
> Geodetic System 1984 ensemble",MEMBER["World Geodetic System 1984 
> (Transit)"],MEMBER["World Geodetic System 1984 (G730)"],MEMBER["World 
> Geodetic System 1984 (G873)"],MEMBER["World Geodetic System 1984 
> (G1150)"],MEMBER["World Geodetic System 1984 (G1674)"],MEMBER["World 
> Geodetic System 1984 (G1762)"],MEMBER["World Geodetic System 1984 
> (G2139)"],ELLIPSOID["WGS 
> 84",6378137,298.257223563,LENGTHUNIT["metre",1]],ENSEMBLEACCURACY[2.0]],PRIMEM["Greenwich",0,ANGLEUNIT["degree",0.0174532925199433]],CS[ellipsoidal,3],AXIS["geodetic 
> latitude 
> (Lat)",north,ORDER[1],ANGLEUNIT["degree",0.0174532925199433]],AXIS["geodetic 
> longitude 
> (Lon)",east,ORDER[2],ANGLEUNIT["degree",0.0174532925199433]],AXIS["ellipsoidal 
> height (h)",up,ORDER[3],LENGTHUNIT["metre",1]], [... snip ....] 
> ,ID["EPSG",4979]]</gco:CharacterString>
>
> (I see that gdalinfo also issues a "ERROR 1: PROJ: 
> proj_create_compound_crs: components of the compound CRS do not belong 
> to one of the allowed combinations of 
> http://docs.opengeospatial.org/as/18-005r4/18-005r4.html#34" when 
> reading this, which I suspect comes from the fact that it tries to 
> create a CompoundCRS from this 3D GeogCRS and the "VERT_CS["unknown", 
> VERT_DATUM["unknown", 2000]]", so writing 3D GeogCRS isn't really 
> appropriate for BAG)
>
> Even
>
> Le 22/04/2022 ? 18:01, Vautour, Andr? (INT) a ?crit?:
>
>     Hi all,
>
>     It has just come to my attention that the BAG driver in GDAL is
>     writing the CRS with a WKT codeSpace and a WKT 2.0 string as the
>     code. While I am fairly sure we started that incorrect practice
>     here at CARIS with a WKT 1.0 string, this is the first time I?ve
>     seen a WKT 2.0 string written in there, and I am therefore
>     concerned about interoperability.
>
>     I think we can all agree that what makes the most sense is to
>     write an EPSG codebase with the EPSG code if we have it, and I
>     think falling back to a WKT 1.0 string if it is not EPSG is a
>     reasonable fallback if it is not EPSG, given how it has been used
>     in the past, but I am worried that older software won?t recognize
>     the WKT 2.0 string.
>
>     Would you be willing to take a pull request that does that?
>     Worst-case, would you be fine with changing that WKT 2.0 string to
>     a WKT 1.0 string?
>
>     Regards,
>
>     Andr?
>
>
>
>     _______________________________________________
>
>     gdal-dev mailing list
>
>     gdal-dev at lists.osgeo.org
>
>     https://lists.osgeo.org/mailman/listinfo/gdal-dev
>
> -- 
> http://www.spatialys.com
> My software is free, but my time generally not.

-- 
http://www.spatialys.com
My software is free, but my time generally not.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220422/6a8b6f7b/attachment.html>

From Andre.Vautour at Teledyne.com  Fri Apr 22 09:51:46 2022
From: Andre.Vautour at Teledyne.com (=?utf-8?B?VmF1dG91ciwgQW5kcsOpIChJTlQp?=)
Date: Fri, 22 Apr 2022 16:51:46 +0000
Subject: [gdal-dev] BAG CRS
In-Reply-To: <75dc5d50-0093-49d3-0a91-0f2532bda034@spatialys.com>
References: <YT3PR01MB493035E1067A542F6673B34E97F79@YT3PR01MB4930.CANPRD01.PROD.OUTLOOK.COM>
 <ea4db3db-712a-88d9-5f65-bce33057b482@spatialys.com>
 <YT3PR01MB493069B9A790FDCD3529330C97F79@YT3PR01MB4930.CANPRD01.PROD.OUTLOOK.COM>
 <75dc5d50-0093-49d3-0a91-0f2532bda034@spatialys.com>
Message-ID: <YT3PR01MB4930D8F6ACEB954F2177DC4F97F79@YT3PR01MB4930.CANPRD01.PROD.OUTLOOK.COM>

Yeah, I agree with your assessment. I hadn?t realized that you could set the option externally when I started the thread. I agree with you that the user likely set it themselves given what you have shown thus far, so I?ll sort it out with them. Apologies for taking some of your time.

Thanks again,
Andr?

From: Even Rouault <even.rouault at spatialys.com>
Sent: April 22, 2022 13:47
To: Vautour, Andr? (INT) <Andre.Vautour at Teledyne.com>; gdal-dev at lists.osgeo.org
Subject: Re: [gdal-dev] BAG CRS

External Email

Andr?,

hum ok. it might perhaps be possible that WKT2 could come when extract the vertical part but I still can't reproduce that trying:

$ gdal_translate autotest/gcore/data/byte.tif byte.bag -a_srs 'COMPOUNDCRS["foo",PROJCRS["NAD27 / UTM zone 11N",BASEGEOGCRS["NAD27",DATUM["North American Datum 1927",ELLIPSOID["Clarke 1866",6378206.4,294.978698213898,LENGTHUNIT["metre",1]]],PRIMEM["Greenwich",0,ANGLEUNIT["degree",0.0174532925199433]],ID["EPSG",4267]],CONVERSION["UTM zone 11N",METHOD["Transverse Mercator",ID["EPSG",9807]],PARAMETER["Latitude of natural origin",0,ANGLEUNIT["degree",0.0174532925199433],ID["EPSG",8801]],PARAMETER["Longitude of natural origin",-117,ANGLEUNIT["degree",0.0174532925199433],ID["EPSG",8802]],PARAMETER["Scale factor at natural origin",0.9996,SCALEUNIT["unity",1],ID["EPSG",8805]],PARAMETER["False easting",500000,LENGTHUNIT["metre",1],ID["EPSG",8806]],PARAMETER["False northing",0,LENGTHUNIT["metre",1],ID["EPSG",8807]]],CS[Cartesian,2],AXIS["(E)",east,ORDER[1],LENGTHUNIT["metre",1]],AXIS["(N)",north,ORDER[2],LENGTHUNIT["metre",1]],USAGE[SCOPE["Engineering survey, topographic mapping."],AREA["North America - between 120?W and 114?W - onshore. Canada - Alberta; British Columbia; Northwest Territories; Nunavut. Mexico. United States (USA) - California; Idaho; Nevada; Oregon; Washington."],BBOX[26.93,-120,78.13,-114]],ID["EPSG",26711]],VERTCRS["ellipse",VDATUM["NAD83(2011) / UTM zone 10N + ellipse"],CS[vertical,1],AXIS["ellipsoid height (h)",up,LENGTHUNIT["metre",1]]]]'

$ gdalinfo byte.bag -mdd xml:BAG | grep VERT_CS
            <gco:CharacterString>VERT_CS["ellipse",VERT_DATUM["NAD83(2011) / UTM zone 10N + ellipse",2005],UNIT["metre",1],AXIS["Ellipsoid height",UP]]</gco:CharacterString>

(the ,2005 here isn't really appropriate. it should rather be ,2002,  but such formulations of CompoundCRS with a VerticalCRS that expressed an ellipsoidal height are not ISO-19111 compliant)

Anyway if you can find a way to reproduce the issue with a CRS provided through the GetProjection()/SetProjection() API of GDAL, a fix would be welcome. If it is the user who provides WKT2 with a manual VAR_VERT_WKT option, then I'd say it is their responsibility to provide the right value.

Even
Le 22/04/2022 ? 18:35, Vautour, Andr? (INT) a ?crit :
Sorry Even,

I should have done more research on my end up front before sending this. A client told us his WKT 2.0 BAG was created with GDAL. Looking at it some more, it was the vertical CRS that was WKT 2.0.

Their vertical CRS looked as follows:
<gco:CharacterString>VERTCRS["ellipse",VDATUM["NAD83(2011) / UTM zone 10N + ellipse"],CS[vertical,1],AXIS["ellipsoid height (h)",up,LENGTHUNIT["metre",1]]]</gco:CharacterString>

Cheers,
Andr?

From: Even Rouault <even.rouault at spatialys.com><mailto:even.rouault at spatialys.com>
Sent: April 22, 2022 13:22
To: Vautour, Andr? (INT) <Andre.Vautour at Teledyne.com><mailto:Andre.Vautour at Teledyne.com>; gdal-dev at lists.osgeo.org<mailto:gdal-dev at lists.osgeo.org>
Subject: Re: [gdal-dev] BAG CRS

External Email

Andr?,

I don't confirm this trying:

$ gdal_translate autotest/gcore/data/byte.tif byte.bag

$ gdalinfo byte.bag -mdd xml:BAG | grep PROJCS
            <gco:CharacterString>PROJCS["NAD27 / UTM zone 11N",GEOGCS["NAD27",DATUM["North_American_Datum_1927",SPHEROID["Clarke 1866",6378206.4,294.978698213898,AUTHORITY["EPSG","7008"]],AUTHORITY["EPSG","6267"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4267"]],PROJECTION["Transverse_Mercator"],PARAMETER["latitude_of_origin",0],PARAMETER["central_meridian",-117],PARAMETER["scale_factor",0.9996],PARAMETER["false_easting",500000],PARAMETER["false_northing",0],UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH],AUTHORITY["EPSG","26711"]]</gco:CharacterString>

This is WKT1

I'm wondering if the confusion might come from looking at the CRS reported by gdalinfo, which will always be WKT2 in recent GDAL versions whatever the encoding in the source dataset itself ?

Or perhaps you try to write a Geographic 3D CRS ? in which case WKT2 will be used since there's no WKT1 representation for this

$ gdalwarp -overwrite autotest/gcore/data/byte.tif byte.bag -t_srs EPSG:4979 -ot float32

$ gdalinfo byte.bag -mdd xml:BAG | grep GEOGCRS
            <gco:CharacterString>GEOGCRS["WGS 84",ENSEMBLE["World Geodetic System 1984 ensemble",MEMBER["World Geodetic System 1984 (Transit)"],MEMBER["World Geodetic System 1984 (G730)"],MEMBER["World Geodetic System 1984 (G873)"],MEMBER["World Geodetic System 1984 (G1150)"],MEMBER["World Geodetic System 1984 (G1674)"],MEMBER["World Geodetic System 1984 (G1762)"],MEMBER["World Geodetic System 1984 (G2139)"],ELLIPSOID["WGS 84",6378137,298.257223563,LENGTHUNIT["metre",1]],ENSEMBLEACCURACY[2.0]],PRIMEM["Greenwich",0,ANGLEUNIT["degree",0.0174532925199433]],CS[ellipsoidal,3],AXIS["geodetic latitude (Lat)",north,ORDER[1],ANGLEUNIT["degree",0.0174532925199433]],AXIS["geodetic longitude (Lon)",east,ORDER[2],ANGLEUNIT["degree",0.0174532925199433]],AXIS["ellipsoidal height (h)",up,ORDER[3],LENGTHUNIT["metre",1]], [... snip ....] ,ID["EPSG",4979]]</gco:CharacterString>

(I see that gdalinfo also issues a "ERROR 1: PROJ: proj_create_compound_crs: components of the compound CRS do not belong to one of the allowed combinations of http://docs.opengeospatial.org/as/18-005r4/18-005r4.html#34" when reading this, which I suspect comes from the fact that it tries to create a CompoundCRS from this 3D GeogCRS and the "VERT_CS["unknown", VERT_DATUM["unknown", 2000]]", so writing 3D GeogCRS isn't really appropriate for BAG)

Even
Le 22/04/2022 ? 18:01, Vautour, Andr? (INT) a ?crit :
Hi all,

It has just come to my attention that the BAG driver in GDAL is writing the CRS with a WKT codeSpace and a WKT 2.0 string as the code. While I am fairly sure we started that incorrect practice here at CARIS with a WKT 1.0 string, this is the first time I?ve seen a WKT 2.0 string written in there, and I am therefore concerned about interoperability.

I think we can all agree that what makes the most sense is to write an EPSG codebase with the EPSG code if we have it, and I think falling back to a WKT 1.0 string if it is not EPSG is a reasonable fallback if it is not EPSG, given how it has been used in the past, but I am worried that older software won?t recognize the WKT 2.0 string.

Would you be willing to take a pull request that does that? Worst-case, would you be fine with changing that WKT 2.0 string to a WKT 1.0 string?

Regards,
Andr?




_______________________________________________

gdal-dev mailing list

gdal-dev at lists.osgeo.org<mailto:gdal-dev at lists.osgeo.org>

https://lists.osgeo.org/mailman/listinfo/gdal-dev

--

http://www.spatialys.com

My software is free, but my time generally not.

--

http://www.spatialys.com

My software is free, but my time generally not.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220422/7aa5454b/attachment-0001.html>

From mdsumner at gmail.com  Fri Apr 22 17:49:45 2022
From: mdsumner at gmail.com (Michael Sumner)
Date: Sat, 23 Apr 2022 10:49:45 +1000
Subject: [gdal-dev] default for RelativeToVRT field
Message-ID: <CAAcGz98OcBQhK-7j7N6xXnGd0auyPjXrwHKfcD6cxEo+5+WJHQ@mail.gmail.com>

I would like to control the relativeToVRT field by setting it to 0/false,
it seems the only way to do that is to give a non-local or absolute path to
the *output* file, or give an absolute path for the input. .

intif=autotest/gdrivers/data/gtiff/byte_signed.tif
abtif="$(pwd)"/$intif
gdal_translate $intif -of VRT here.vrt
gdal_translate $intif -of VRT /tmp/there.vrt
gdal_translate $abtif -of VRT here_abs.vrt

grep relative here.vrt
      <SourceFilename relativeToVRT="1">a ...
grep relative /tmp/there.vrt
      <SourceFilename relativeToVRT="0">/p ...
grep relative here_abs.vrt
      <SourceFilename relativeToVRT="0">/p ...

It's the same in C++, if 'pszFilename' is relative the value is 1, if
absolute it is 0.

  GDALDataset *poSrcDS = (GDALDataset *)GDALOpenShared(pszFilename,
GA_ReadOnly);

  GDALDriver *poDriver = (GDALDriver *) GDALGetDriverByName( "VRT" );
  GDALDataset *poVRTDS = poDriver->CreateCopy("", poSrcDS, false, NULL,
NULL, NULL);

  const char *xmlvrt = poVRTDS->GetMetadata("xml:VRT")[0];

Is it possible to force GDAL to make the SourceFilename absolute by setting
options? Or is it just a matter of forcing an input path to be absolute?

I'm concerned about cases of relative paths with prefixes, I want to create
in-memory VRT text that *always* has absolute paths for exactly this
CreateCopy("", ) situation with no actual VRT file.

Thank you, Mike



--
Michael Sumner
Software and Database Engineer
Australian Antarctic Division
Hobart, Australia
e-mail: mdsumner at gmail.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220423/9ceb22bd/attachment.html>

From chaoli0394 at gmail.com  Fri Apr 22 21:40:21 2022
From: chaoli0394 at gmail.com (Chao Li)
Date: Sat, 23 Apr 2022 13:40:21 +0900
Subject: [gdal-dev] Issues in Raster Resampling
Message-ID: <CADrR-jb23gu5Op7wJwnNyLOPpOuVp0tJ-ztLX=AbQfG+YdkC=A@mail.gmail.com>

Dear Gdal Developer,

Thank you for reading my email.

I used gdal.Wrap() to resample from a high resolution to a lower. However,
my raster has no value (nan). So, when I set resampleAlg, the larger grids
with nan(s) will become nan.

Here is my reprex in Python:

from osgeo import gdal

### resample and reproject
### data are from MOD11A2 and MYD11A2, and have been converted into annual
mean values
raster_rprj = gdal.Warp("./2015_daytime_mean_re.tif",
                        "./2015_daytime_mean_clip.tif", dstSRS =
"EPSG:4326",
                        xRes = 0.008, yRes = 0.008, resampleAlg = "average")

raster_rprj = None

I hope it runs as the function np.nanmean()

Thank you for your time.

Best regards,

Mike Li
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220423/0bad880d/attachment-0001.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: 2015_daytime_mean_clip.tif
Type: image/tiff
Size: 14450 bytes
Desc: not available
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220423/0bad880d/attachment-0001.tif>

From even.rouault at spatialys.com  Sat Apr 23 02:13:23 2022
From: even.rouault at spatialys.com (Even Rouault)
Date: Sat, 23 Apr 2022 11:13:23 +0200
Subject: [gdal-dev] Issues in Raster Resampling
In-Reply-To: <CADrR-jb23gu5Op7wJwnNyLOPpOuVp0tJ-ztLX=AbQfG+YdkC=A@mail.gmail.com>
References: <CADrR-jb23gu5Op7wJwnNyLOPpOuVp0tJ-ztLX=AbQfG+YdkC=A@mail.gmail.com>
Message-ID: <a5885fab-a452-81d2-af5f-3dc840cd8abc@spatialys.com>

Mike,

if you look at the nodata value set on 2015_daytime_mean_clip.tif, it is 
at 3.39999995214436425e+38, and not at nan.

If you add the srcNodata=math.nan argument to gdal.Warp(), this will fix 
your issue.

Even

Le 23/04/2022 ? 06:40, Chao Li a ?crit?:
> Dear Gdal Developer,
>
> Thank?you for reading my email.
>
> I used gdal.Wrap() to resample from a high resolution to a lower. 
> However, my raster has no value (nan). So, when I set resampleAlg, the 
> larger grids with nan(s) will become nan.
>
> Here is my reprex in Python:
>
> from osgeo import gdal
>
> ### resample and reproject
> ### data are from?MOD11A2 and?MYD11A2, and have been converted into 
> annual mean values
> raster_rprj = gdal.Warp("./2015_daytime_mean_re.tif",
> ? ? ? ? ? ? ? ? ? ? ? ? "./2015_daytime_mean_clip.tif", dstSRS = 
> "EPSG:4326",
> ? ? ? ? ? ? ? ? ? ? ? ? xRes = 0.008, yRes = 0.008, resampleAlg = 
> "average")
>
> raster_rprj = None
>
> I hope it runs as the function?np.nanmean()
>
> Thank you for your time.
>
> Best regards,
>
> Mike Li
>
>
> _______________________________________________
> gdal-dev mailing list
> gdal-dev at lists.osgeo.org
> https://lists.osgeo.org/mailman/listinfo/gdal-dev

-- 
http://www.spatialys.com
My software is free, but my time generally not.


From even.rouault at spatialys.com  Sat Apr 23 02:37:44 2022
From: even.rouault at spatialys.com (Even Rouault)
Date: Sat, 23 Apr 2022 11:37:44 +0200
Subject: [gdal-dev] default for RelativeToVRT field
In-Reply-To: <CAAcGz98OcBQhK-7j7N6xXnGd0auyPjXrwHKfcD6cxEo+5+WJHQ@mail.gmail.com>
References: <CAAcGz98OcBQhK-7j7N6xXnGd0auyPjXrwHKfcD6cxEo+5+WJHQ@mail.gmail.com>
Message-ID: <be378df8-44cf-a910-d148-3e5e7bb8e480@spatialys.com>

Michael,

> Or is it just a matter of forcing an input path to be absolute?

for regular use cases (ie VRT name not set to empty), you might not even 
been able to do that in master since 
https://github.com/OSGeo/gdal/commit/6d7001656d06af138f8e46ff1651056626db11e8 
which tries to write relative filename as much as possible, even if all 
paths are absolute

Testing with your use case with empty VRT filename, I see the behavior 
has not changed, and that you'll indeed get relativeToVRT="0" only if 
using a source dataset with an absolute path. For most use cases where 
you use an empty filename, it doesn't matter much because you don't 
actually re-open it and use it immediately, and thus the source dataset 
is not re-opened. I can imagine though that you could get into trouble 
if serializing it from the xml:VRT content and re-opening the resulting VRT.

> Is it possible to force GDAL to make the SourceFilename absolute by 
> setting options?

The solution would probably be to add an explicit creation option to the 
VRT driver, like SOURCE_PATH=ABSOLUTE, that would override the current 
heuristics.

Even

-- 
http://www.spatialys.com
My software is free, but my time generally not.


From julius.jancevicius at s2p.lt  Mon Apr 25 07:17:26 2022
From: julius.jancevicius at s2p.lt (=?utf-8?Q?Julius_Jancevi=C4=8Dius?=)
Date: Mon, 25 Apr 2022 17:17:26 +0300
Subject: [gdal-dev] Setting colours for some pixel values.
Message-ID: <000001d858af$30b94940$922bdbc0$@s2p.lt>

Good afternoon, Sir/Madam

 ?

I have a .tiff file where are 6 values (1, 2, 3, 4, 5, 6). This is a test of the classification algorithm (1 ? Water, etc.) I am trying to set colors for that, code: 

 ?

It sets colors, but all others are set to black. From 7 to 65536 (including 0) code sets the color black. Is it possible to set values just from 1 to 6?

 ?

Pagarbiai

Julius Jancevi?ius

 ?

Programuotojas

UAB ?S2P?

Solutions to Perform
Adresas: Ukmerg?s g. 251, 

LT - 07100, Vilnius

Tel: +370 683 99470

El. p.:  <mailto:julius.jancevicius at s2p.lt> julius.jancevicius at s2p.lt

 <http://www.s2p.lt/> http://www.s2p.lt

 ?

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220425/38e20309/attachment-0001.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: image001.png
Type: image/png
Size: 45005 bytes
Desc: not available
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220425/38e20309/attachment-0001.png>

From kmskavi at gmail.com  Mon Apr 25 23:28:12 2022
From: kmskavi at gmail.com (Kavitha K)
Date: Tue, 26 Apr 2022 11:58:12 +0530
Subject: [gdal-dev] how to build gdal 3.4.2
Message-ID: <CACLbJJfWv-vU1iOhy5x2oTKLNBcnO=y3YDjLp_eZZ0xX7V3Nig@mail.gmail.com>

Hi All,

I have downloaded gdal-3.4.2
cd gdal-3.4.2
./configure
checking for internal_proj_create_from_wkt in -linternalproj... no
configure: error: PROJ 6 symbols not found

[root at pi-dnac-158 proj-6.0.0]# ./configure --prefix /usr/local

checking for pkg-config... /bin/pkg-config
checking pkg-config is at least version 0.9.0... yes
checking for SQLITE3... configure: error: Package requirements (sqlite3 >=
3.7) were not met:

No package 'sqlite3' found

Consider adjusting the PKG_CONFIG_PATH environment variable if you
installed software in a non-standard prefix.

Alternatively, you may set the environment variables SQLITE3_CFLAGS
and SQLITE3_LIBS to avoid the need to call pkg-config.
See the pkg-config man page for more details.




thanks,
Kavitha
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220426/4193f823/attachment.html>

From mateusz at loskot.net  Tue Apr 26 00:48:22 2022
From: mateusz at loskot.net (Mateusz Loskot)
Date: Tue, 26 Apr 2022 09:48:22 +0200
Subject: [gdal-dev] how to build gdal 3.4.2
In-Reply-To: <CACLbJJfWv-vU1iOhy5x2oTKLNBcnO=y3YDjLp_eZZ0xX7V3Nig@mail.gmail.com>
References: <CACLbJJfWv-vU1iOhy5x2oTKLNBcnO=y3YDjLp_eZZ0xX7V3Nig@mail.gmail.com>
Message-ID: <CABUeae9ych=G+PAHDzBVTMxEXdqidED2eMMi_BT=s9ETtzbP_A@mail.gmail.com>

On Tue, 26 Apr 2022, 08:28 Kavitha K, <kmskavi at gmail.com> wrote:

> Hi All,
>
> I have downloaded gdal-3.4.2
> cd gdal-3.4.2
> ./configure
> checking for internal_proj_create_from_wkt in -linternalproj... no
> configure: error: PROJ 6 symbols not found
>
> [root at pi-dnac-158 proj-6.0.0]# ./configure --prefix /usr/local
>
> checking for pkg-config... /bin/pkg-config
> checking pkg-config is at least version 0.9.0... yes
> checking for SQLITE3... configure: error: Package requirements (sqlite3 >=
> 3.7) were not met:
>
> No package 'sqlite3' found
>


https://gdal.org/download.html#build-requirements

--
Mateusz Loskot, http://mateusz.loskot.net
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220426/eedfdf56/attachment.html>

From Matt.Wilkie at yukon.ca  Tue Apr 26 09:47:04 2022
From: Matt.Wilkie at yukon.ca (Matt.Wilkie at yukon.ca)
Date: Tue, 26 Apr 2022 16:47:04 +0000
Subject: [gdal-dev] Convert to min containing bit depth?
In-Reply-To: <CAEDrt387vmw=Pxy7FFEnqFtxc4sEPZkVHzZvSis3HpccqQBr7w@mail.gmail.com>
References: <2df417d95f794570a2f34c1c3fde008d@yukon.ca>
 <CAM2FmMpzWmbpo6C7Jg2BOuFPBK8C-iEOXCxhX4-pkwoQKXtOSQ@mail.gmail.com>
 <CAEDrt387vmw=Pxy7FFEnqFtxc4sEPZkVHzZvSis3HpccqQBr7w@mail.gmail.com>
Message-ID: <d6c918b7f49749e7b853d9ecda316000@yukon.ca>

Thank you both for this, very helpful.

-Matt

From: Idan Miara <idan at miara.com>
Sent: April 21, 2022 11:18 PM
To: Mike Taves <mwtoews at gmail.com>
Cc: Matt.Wilkie <Matt.Wilkie at yukon.ca>; gdal dev <gdal-dev at lists.osgeo.org>
Subject: Re: [gdal-dev] Convert to min containing bit depth?

Computing the min value is also requited if you have negative values and could also be useful If you wanted to optimize that method further by utilising the offset parameter (and or the scale, but computing the right combination for an optimize lossless compression could be more expensive).

On Fri, 22 Apr 2022, 06:05 Mike Taves, <mwtoews at gmail.com<mailto:mwtoews at gmail.com>> wrote:
On Fri, 22 Apr 2022 at 07:05, <Matt.Wilkie at yukon.ca<mailto:Matt.Wilkie at yukon.ca>> wrote:
>
> Idea for a small but useful python tool: scan image for min/max values and convert to smallest possible bit depth without losing values. Surely someone has done something like this already. Any suggestions for where to look for prior art?

This is driver-specific, as certain formats expect multiples of 2
(e.g.) NBITS=1/2/4. But for GTiff, what I typically use in a script is
to find the maximum value, then use "ceil(log(maxval, 2))" to get the
number of bits, e.g.:

from math import ceil, log
from osgeo import gdal

maxval = 17  # for example
nbits = ceil(log(maxval, 2))  # 5

drv = gdal.GetDriverByName("GTiff")
opts = [f"NBITS={maxval}"]
ds = drv.Create(fname, nx, ny, 1, gdal.GDT_Byte, opts)
...

similar can be done with rasterio, passing the keyword
"rasterio.open(fname, 'w', ..., nbits=nbits)"

For the drivers that expect NBITS as a multiple of 2:

nbits = 2**ceil(log(nbits, 2))

If nbits is greater than 8, then UInt16 or UInt32 may be required, as
supported by the driver.
_______________________________________________
gdal-dev mailing list
gdal-dev at lists.osgeo.org<mailto:gdal-dev at lists.osgeo.org>
https://lists.osgeo.org/mailman/listinfo/gdal-d<https://can01.safelinks.protection.outlook.com/?url=https%3A%2F%2Flists.osgeo.org%2Fmailman%2Flistinfo%2Fgdal-dev&data=05%7C01%7CMatt.Wilkie%40yukon.ca%7C530d4395252944fbff3a08da2427e83d%7C98f515313973490abb70195aa264a2bc%7C0%7C0%7C637862051196803406%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=Wxzbgz3TEIvRtrCiUvFSGc5CUoGIbeeCC8VXt1wtfuA%3D&reserved=0>e vroom
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220426/5c65b868/attachment.html>

From Matt.Wilkie at yukon.ca  Tue Apr 26 13:03:28 2022
From: Matt.Wilkie at yukon.ca (Matt.Wilkie at yukon.ca)
Date: Tue, 26 Apr 2022 20:03:28 +0000
Subject: [gdal-dev] Standardize gdal-utils scripts return code for "no
 arguments"
In-Reply-To: <9070572acd2c4fa49f1d247374336fca@yukon.ca>
References: <9070572acd2c4fa49f1d247374336fca@yukon.ca>
Message-ID: <d63a6a48c36b4824a5ba8f5cec480894@yukon.ca>

Hi Folks,

I've converted all the scripts that were using -1 to 1. However when I started looking at the ones returning 2 it became less clear what to do. Excepting gdal2tiles all of them are using GDALArgumentParser and I don't see where the return value is being set. Thinking this might mean the mainline utils might be using 2 for no args I checked gdal_translate and gdalwarp, but no, both of those use 1.

The scripts that return 2 are:

osgeo_utils\gdal2xyz.py
osgeo_utils\gdal_calc.py
osgeo_utils\gdal_fillnodata.py
osgeo_utils\gdal_polygonize.py
osgeo_utils\pct2rgb.py
osgeo_utils\rgb2pct.py
osgeo_utils\samples\gdallocationinfo.py


I haven't been able to figure out the GDALArgumentParser  parser class so I embarked on making everything else use 2 instead of 1. I'm questioning the wisdom of that at the moment since so many files are touched. However the process has forced me to look more closely at the many scripts and start to internalize the various patterns they use. This has been worthwhile even if the approach might get abandoned. The "make everything return 2" effort is in branch patch-5561-ret2<https://github.com/maphew/gdal/tree/patch-5561-ret2>.

The next message will have more details on how I've tried and failed to understand GDALArgumentParser.

-Matt

From: gdal-dev <gdal-dev-bounces at lists.osgeo.org> On Behalf Of Matt.Wilkie at yukon.ca
Sent: April 4, 2022 4:07 PM
To: gdal-dev at lists.osgeo.org
Subject: [gdal-dev] Standardize gdal-utils scripts return code for "no arguments"

Hi folks,

I'm working on "Standardize gdal-utils scripts return codes #5561" for all the scripts in swig/python/gdal-utils. Currently the scripts do not return the same status code for "was run without arguments".

It would be good for the same code meant the same thing across all the scripts in the package. Given that most of the scripts use `1` now, and that this is in line with sys,exit() docs I think it makes sense to make 1 the new standard.

At present we have (return_code, num scripts with that code):

0: 30
1: 56
2:  8
-1:  9

-1 is a special case. In the script code it's written as `return -1` but subprocess.run() captures it as `4294967295`. Another special case is `gdal_auth.py` sample which with no arguments spawns a web authentication page in browser.

Changing the return code will mean anyone who is relying on those in their own scripts or programs will need to adjust. This seems to be a small price for the gain in harmonization across the utilities, to me. Your thoughts?


[0]: https://github.com/OSGeo/gdal/issues/5561<https://can01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fgithub.com%2FOSGeo%2Fgdal%2Fissues%2F5561&data=04%7C01%7Cmatt.wilkie%40yukon.ca%7Cc3e8dba890e54a879a4808da168fdceb%7C98f515313973490abb70195aa264a2bc%7C0%7C0%7C637847105002756645%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000&sdata=cJaW4TxL68DJMI8KTEjVjQCIzsN1Oa9ShUtILmy1%2B2g%3D&reserved=0>
[1]: https://docs.python.org/3/library/sys.html#sys.exit<https://can01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fdocs.python.org%2F3%2Flibrary%2Fsys.html%23sys.exit&data=04%7C01%7Cmatt.wilkie%40yukon.ca%7Cc3e8dba890e54a879a4808da168fdceb%7C98f515313973490abb70195aa264a2bc%7C0%7C0%7C637847105002756645%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000&sdata=pHA7JH0IS7tjePzMXO1MzvO6svuPVHVR9uQgPqxOtMY%3D&reserved=0>, "Unix programs generally use 2 for command line syntax errors and 1 for all other kind of errors"

Matt Wilkie
Geomatics Developer & Administrator
Environment | Technology, Innovation and Mapping
T 867-667-8133 | Yukon.ca<https://can01.safelinks.protection.outlook.com/?url=http%3A%2F%2Fyukon.ca%2F&data=04%7C01%7Cmatt.wilkie%40yukon.ca%7Cc3e8dba890e54a879a4808da168fdceb%7C98f515313973490abb70195aa264a2bc%7C0%7C0%7C637847105002756645%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000&sdata=S08L%2BQsPMBZOc2%2Bb3wnWS8W08a0ejZpHRC1QAMfFEyk%3D&reserved=0>
Hours: 08:30-16:30, Mon-Wed: Office, Thu: Remote, Fri: Away.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220426/2b528583/attachment.html>

From Matt.Wilkie at yukon.ca  Tue Apr 26 13:05:50 2022
From: Matt.Wilkie at yukon.ca (Matt.Wilkie at yukon.ca)
Date: Tue, 26 Apr 2022 20:05:50 +0000
Subject: [gdal-dev] Standardize gdal-utils scripts return code for "no
 arguments"
In-Reply-To: <27b89410166241e2867d47f458acc7bf@yukon.ca>
References: <9070572acd2c4fa49f1d247374336fca@yukon.ca>
 <27b89410166241e2867d47f458acc7bf@yukon.ca>
Message-ID: <6a2c8b41a3bf4d9b85db0ad5a1c135ef@yukon.ca>

Here is the path I'm following in trying to deconstruct GDALArgumentParser.
With file = pc2rgb.py:
        r = subprocess.run([sys.executable,
            file],
            shell=True,
            capture_output=True,
            text=True,
            )
        if debug:
            print(f'returncode: {r.returncode}')
I get:
returncode: 2
Digging in to pct2rgb.py I see main() calling PCT2RGB class, calling pct2rgb function, which should error out with an exception.:
def main(argv=sys.argv):
    return PCT2RGB().main(argv)
    def doit(self, **kwargs):
        return pct2rgb(**kwargs)
def doit(**kwargs):
    try:
        ds = pct2rgb(**kwargs)
        return ds, 0
    except:
        return None, 1
def pct2rgb(src_filename: PathLikeOrStr, pct_filename: Optional[PathLikeOrStr], dst_filename: PathLikeOrStr,
            band_number: int = 1, out_bands: int = 3, driver_name: Optional[str] = None):
    # Open source file
    src_ds = open_ds(src_filename)
    if src_ds is None:
        raise Exception(f'Unable to open {src_filename} ')
    ...
So I'm thinking that while PCT2RGB class is invoking GDALArgumentParser it's exiting early somehow with this 2 return code.
def get_parser(self, argv) -> GDALArgumentParser:
    ...
    return parser
I look at auxillary/gdal_argparse.py: class GDALArgumentParser(argparse.ArgumentParser) and I see... well a bunch of stuff I only apprehend the shadowy outlines of. Looking at the return statements doesn't add light. (It doesn't help that I don't understand how classes work. There's this thing called super() but it's not defined anywhere. Shouldn't that cause an error? Oh it's from stdlib builtins.pyi. What the heck is a pyi? "...It is pitch black. You are likely to be eaten by a grue.")
> findstr "return" ..\auxiliary\gdal_argparse.py
        return super().parse_args(args=args, **kwargs)
        return shlex.split(arg_line, comments=True)
        return self._parser
        return kwargs
        return kwargs
            return 0
            return 1
        return epilog or None
So my question is: where is returncode: 2 coming from?

-Matt

From: Matt.Wilkie
Sent: April 26, 2022 1:03 PM
To: 'gdal-dev at lists.osgeo.org' <gdal-dev at lists.osgeo.org>
Subject: RE: Standardize gdal-utils scripts return code for "no arguments"

Hi Folks,

I've converted all the scripts that were using -1 to 1. However when I started looking at the ones returning 2 it became less clear what to do. Excepting gdal2tiles all of them are using GDALArgumentParser and I don't see where the return value is being set. Thinking this might mean the mainline utils might be using 2 for no args I checked gdal_translate and gdalwarp, but no, both of those use 1.

The scripts that return 2 are:

osgeo_utils\gdal2xyz.py
osgeo_utils\gdal_calc.py
osgeo_utils\gdal_fillnodata.py
osgeo_utils\gdal_polygonize.py
osgeo_utils\pct2rgb.py
osgeo_utils\rgb2pct.py
osgeo_utils\samples\gdallocationinfo.py


I haven't been able to figure out the GDALArgumentParser  parser class so I embarked on making everything else use 2 instead of 1. I'm questioning the wisdom of that at the moment since so many files are touched. However the process has forced me to look more closely at the many scripts and start to internalize the various patterns they use. This has been worthwhile even if the approach might get abandoned. The "make everything return 2" effort is in branch patch-5561-ret2<https://github.com/maphew/gdal/tree/patch-5561-ret2>.

The next message will have more details on how I've tried and failed to understand GDALArgumentParser.

-Matt

From: gdal-dev <gdal-dev-bounces at lists.osgeo.org<mailto:gdal-dev-bounces at lists.osgeo.org>> On Behalf Of Matt.Wilkie at yukon.ca<mailto:Matt.Wilkie at yukon.ca>
Sent: April 4, 2022 4:07 PM
To: gdal-dev at lists.osgeo.org<mailto:gdal-dev at lists.osgeo.org>
Subject: [gdal-dev] Standardize gdal-utils scripts return code for "no arguments"

Hi folks,

I'm working on "Standardize gdal-utils scripts return codes #5561" for all the scripts in swig/python/gdal-utils. Currently the scripts do not return the same status code for "was run without arguments".

It would be good for the same code meant the same thing across all the scripts in the package. Given that most of the scripts use `1` now, and that this is in line with sys,exit() docs I think it makes sense to make 1 the new standard.

At present we have (return_code, num scripts with that code):

0: 30
1: 56
2:  8
-1:  9

-1 is a special case. In the script code it's written as `return -1` but subprocess.run() captures it as `4294967295`. Another special case is `gdal_auth.py` sample which with no arguments spawns a web authentication page in browser.

Changing the return code will mean anyone who is relying on those in their own scripts or programs will need to adjust. This seems to be a small price for the gain in harmonization across the utilities, to me. Your thoughts?


[0]: https://github.com/OSGeo/gdal/issues/5561<https://can01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fgithub.com%2FOSGeo%2Fgdal%2Fissues%2F5561&data=04%7C01%7Cmatt.wilkie%40yukon.ca%7Cc3e8dba890e54a879a4808da168fdceb%7C98f515313973490abb70195aa264a2bc%7C0%7C0%7C637847105002756645%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000&sdata=cJaW4TxL68DJMI8KTEjVjQCIzsN1Oa9ShUtILmy1%2B2g%3D&reserved=0>
[1]: https://docs.python.org/3/library/sys.html#sys.exit<https://can01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fdocs.python.org%2F3%2Flibrary%2Fsys.html%23sys.exit&data=04%7C01%7Cmatt.wilkie%40yukon.ca%7Cc3e8dba890e54a879a4808da168fdceb%7C98f515313973490abb70195aa264a2bc%7C0%7C0%7C637847105002756645%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000&sdata=pHA7JH0IS7tjePzMXO1MzvO6svuPVHVR9uQgPqxOtMY%3D&reserved=0>, "Unix programs generally use 2 for command line syntax errors and 1 for all other kind of errors"

Matt Wilkie
Geomatics Developer & Administrator
Environment | Technology, Innovation and Mapping
T 867-667-8133 | Yukon.ca<https://can01.safelinks.protection.outlook.com/?url=http%3A%2F%2Fyukon.ca%2F&data=04%7C01%7Cmatt.wilkie%40yukon.ca%7Cc3e8dba890e54a879a4808da168fdceb%7C98f515313973490abb70195aa264a2bc%7C0%7C0%7C637847105002756645%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000&sdata=S08L%2BQsPMBZOc2%2Bb3wnWS8W08a0ejZpHRC1QAMfFEyk%3D&reserved=0>
Hours: 08:30-16:30, Mon-Wed: Office, Thu: Remote, Fri: Away.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220426/66bab844/attachment-0001.html>

From johannespaul92 at gmail.com  Wed Apr 27 06:19:42 2022
From: johannespaul92 at gmail.com (Johannes Paul)
Date: Wed, 27 Apr 2022 15:19:42 +0200
Subject: [gdal-dev] GDAL compilation on Centos8 with MrSID
Message-ID: <CACcmK9ZCgy_A-pgfweRmLm621gHGqEdg6MGAB5sGy6c+VRad6A@mail.gmail.com>

Hello,
I'm struggling to compile GDAL on Centos8 with MrSID driver.
I got the MrSID SDK from online
(https://www.extensis.com/support/developers), however for
linux only gcc 4.8.2 and gcc 5.3.1 versions of the SDK are available.
I can manage to compile GDAL on Centos7 (gcc 4.8.5) with MrSID SDK (gcc
5.3.1), however when trying to achieve compilation on Centos8 (gcc 8.5.0),
I get the following errors at make stage
```
In file included from
/MrSID_DSDK-9.5.4.4709-rhel6.x86-64.gcc531/Raster_DSDK/include/lt_types.h:28,

                 from mrsiddataset_headers_include.h:50,

                 from mrsiddataset.cpp:53:


/MrSID_DSDK-9.5.4.4709-rhel6.x86-64.gcc531/Raster_DSDK/include/lt_platform.h:102:5:
error: #error PLATFORM ERROR: unknown compiler

    #error PLATFORM ERROR: unknown compiler


In file included from mrsiddataset_headers_include.h:50,

                 from mrsiddataset.cpp:53:


/MrSID_DSDK-9.5.4.4709-rhel6.x86-64.gcc531/Raster_DSDK/include/lt_types.h:72:5:
error: #error NOT YET PORTED TO TARGET COMPILER

    #error NOT YET PORTED TO TARGET COMPILER


/MrSID_DSDK-9.5.4.4709-rhel6.x86-64.gcc531/Raster_DSDK/include/lt_types.h:131:5:
error: #error NOT YET PORTED TO TARGET COMPILER

    #error NOT YET PORTED TO TARGET COMPILER
...
```
I suspect this is related to the fact that MrSID SDK is compiled with an
old version of GCC (5.3) whereas GDAL is being compiled with a new one
(8.5).

Unfortunately old versions of GCC are not available on Centos8, and I did
not manage to compile old GCC from source on Centos8.

Any help would be appreciated.
Thanks
Johannes
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220427/a6020c25/attachment.html>

From idan at miara.com  Wed Apr 27 06:24:20 2022
From: idan at miara.com (Idan Miara)
Date: Wed, 27 Apr 2022 16:24:20 +0300
Subject: [gdal-dev] Standardize gdal-utils scripts return code for "no
 arguments"
In-Reply-To: <6a2c8b41a3bf4d9b85db0ad5a1c135ef@yukon.ca>
References: <9070572acd2c4fa49f1d247374336fca@yukon.ca>
 <27b89410166241e2867d47f458acc7bf@yukon.ca>
 <6a2c8b41a3bf4d9b85db0ad5a1c135ef@yukon.ca>
Message-ID: <PH0PR05MB80103B9ACAEE97AC2ECD9BE4C1FA9@PH0PR05MB8010.namprd05.prod.outlook.com>

Hi Matt,

Since you mentioned that you don't understand how classes work (i.e. super
function)
I would highly recommend spending some time to go over some basic Python
OOP, it's not complicated and I'm confident that it would be very useful.
>From a quick search, maybe this link would be useful
https://realpython.com/python3-object-oriented-programming/ but there are
many other resources.
super() is mainly used in Python as a way to call the superclass' function
when that you subclass (https://realpython.com/python-super/)
For example, in `GDALArgumentParser.__init__()` I call `super().__init__`
in order to access ArgumentParser's constructor (__init__).

GDALArgumentParser is defined as `class
GDALArgumentParser(argparse.ArgumentParser)`.
So GDALArgumentParser is a superclass of the built in class
argparse.ArgumentParser.
The objective of this class is mainly to standardize our usage of
ArgumentParser by adding some functionality that was implemented in many
different utils on top of ArgumentParser.
As GDALArgumentParser is a thin superclass of ArgumentParser, If you want
to better understand GDALArgumentParser I advise you to first read the docs
here https://docs.python.org/3/library/argparse.html, it helped me very
much when I coded GDALArgumentParser.

Bottom line, returncode 2 is from the very last line in argparse.py, the
builtin ArgumentParser (function ArgumentParser.error()):
`self.exit(2, _('%(prog)s: error: %(message)s\n') % args)`
When ArgumentParser encounters an error (like calling it without arguments
when arguments were required) it calls this function and exits with
errorcode 2.
You could see this in action if you copy-paste and run without parameters
the first example in the ArgumentParser docs (
https://docs.python.org/3/library/argparse.html).

The way I found this was just using the debugger in PyCharm and stepping in
until I found out what's exits the run
(If an exception is raised it makes it much easier as you can easily follow
the call stack)

pyi are stub files (https://peps.python.org/pep-0484/) and you probably
encountered them when digging into Python's standard library which is not
written in pure Python.

Best,
Idan

On Tue, 26 Apr 2022 at 23:06, <Matt.Wilkie at yukon.ca> wrote:

> *Here is the path I'm following in trying to deconstruct *
> *GDALArgumentParser.*
>
> With file = pc2rgb.py:
>
>         r = subprocess.run([sys.executable,
>
>             file],
>
>             shell=True,
>
>             capture_output=True,
>
>             text=True,
>
>             )
>
>         if debug:
>
>             print(f'returncode: {r.returncode}')
>
> I get:
>
> returncode: 2
>
> Digging in to pct2rgb.py I see main() calling PCT2RGB class, calling
> pct2rgb function, which should error out with an exception.:
>
> def main(argv=sys.argv):
>
>     return PCT2RGB().main(argv)
>
>     def doit(self, **kwargs):
>
>         return pct2rgb(**kwargs)
>
> def doit(**kwargs):
>
>     try:
>
>         ds = pct2rgb(**kwargs)
>
>         return ds, 0
>
>     except:
>
>         return None, 1
>
> def pct2rgb(src_filename: PathLikeOrStr, pct_filename:
> Optional[PathLikeOrStr], dst_filename: PathLikeOrStr,
>
>             band_number: int = 1, out_bands: int = 3, driver_name:
> Optional[str] = None):
>
>     # Open source file
>
>     src_ds = open_ds(src_filename)
>
>     if src_ds is None:
>
>         raise Exception(f'Unable to open {src_filename} ')
>
>     ...
>
> So I'm thinking that while PCT2RGB class is invoking GDALArgumentParser
> it's exiting early somehow with this 2 return code.
>
> def get_parser(self, argv) -> GDALArgumentParser:
>
>     ...
>
>     return parser
>
> I look at auxillary/gdal_argparse.py: class
> GDALArgumentParser(argparse.ArgumentParser) and I see... well a bunch of
> stuff I only apprehend the shadowy outlines of. Looking at the return
> statements doesn't add light. (It doesn't help that I don't understand how
> classes work. There's this thing called super() but it's not defined
> anywhere. Shouldn't that cause an error? Oh it's from stdlib builtins.pyi.
> What the heck is a pyi? *"...It is pitch black. You are likely to be
> eaten by a grue."*)
>
> ? findstr "return" ..\auxiliary\gdal_argparse.py
>
>         return super().parse_args(args=args, **kwargs)
>
>         return shlex.split(arg_line, comments=True)
>
>         return self._parser
>
>         return kwargs
>
>         return kwargs
>
>             return 0
>
>             return 1
>
>         return epilog or None
>
> So my question is: where is returncode: 2 coming from?
>
>
>
> -Matt
>
>
>
> *From:* Matt.Wilkie
> *Sent:* April 26, 2022 1:03 PM
> *To:* 'gdal-dev at lists.osgeo.org' <gdal-dev at lists.osgeo.org>
> *Subject:* RE: Standardize gdal-utils scripts return code for "no
> arguments"
>
>
>
> Hi Folks,
>
>
>
> I've converted all the scripts that were using -1 to 1. However when I
> started looking at the ones returning 2 it became less clear what to do.
> Excepting *gdal2tiles* all of them are using GDALArgumentParser and I
> don't see where the return value is being set. Thinking this might mean the
> mainline utils might be using 2 for no args I checked *gdal_translate*
> and *gdalwarp*, but no, both of those use 1.
>
>
>
> The scripts that return 2 are:
>
>
>
> osgeo_utils\gdal2xyz.py
>
> osgeo_utils\gdal_calc.py
>
> osgeo_utils\gdal_fillnodata.py
>
> osgeo_utils\gdal_polygonize.py
>
> osgeo_utils\pct2rgb.py
>
> osgeo_utils\rgb2pct.py
>
> osgeo_utils\samples\gdallocationinfo.py
>
>
>
>
>
> I haven?t been able to figure out the GDALArgumentParser  parser class so
> I embarked on making everything else use 2 instead of 1. I'm questioning
> the wisdom of that at the moment since so many files are touched. However
> the process has forced me to look more closely at the many scripts and
> start to internalize the various patterns they use. This has been
> worthwhile even if the approach might get abandoned. The ?make everything
> return 2? effort is in branch patch-5561-ret2
> <https://github.com/maphew/gdal/tree/patch-5561-ret2>.
>
>
>
> The next message will have more details on how I?ve tried and failed to
> understand GDALArgumentParser.
>
>
>
> -Matt
>
>
>
> *From:* gdal-dev <gdal-dev-bounces at lists.osgeo.org> *On Behalf Of *
> Matt.Wilkie at yukon.ca
> *Sent:* April 4, 2022 4:07 PM
> *To:* gdal-dev at lists.osgeo.org
> *Subject:* [gdal-dev] Standardize gdal-utils scripts return code for "no
> arguments"
>
>
>
> Hi folks,
>
>
>
> I?m working on ?Standardize gdal-utils scripts return codes #5561? for all
> the scripts in swig/python/gdal-utils. Currently the scripts do not return
> the same status code for "was run without arguments".
>
>
>
> It would be good for the same code meant the same thing across all the
> scripts in the package. Given that most of the scripts use `1` now, and
> that this is in line with sys,exit() docs I think it makes sense to make 1
> the new standard.
>
>
>
> At present we have (return_code, num scripts with that code):
>
>
>
> 0: 30
>
> 1: 56
>
> 2:  8
>
> -1:  9
>
>
>
> -1 is a special case. In the script code it?s written as `return -1` but
> subprocess.run() captures it as `4294967295`. Another special case is
> `gdal_auth.py` sample which with no arguments spawns a web authentication
> page in browser.
>
>
>
> Changing the return code will mean anyone who is relying on those in their
> own scripts or programs will need to adjust. This seems to be a small price
> for the gain in harmonization across the utilities, to me. Your thoughts?
>
>
>
>
>
> [0]: https://github.com/OSGeo/gdal/issues/5561
> <https://can01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fgithub.com%2FOSGeo%2Fgdal%2Fissues%2F5561&data=04%7C01%7Cmatt.wilkie%40yukon.ca%7Cc3e8dba890e54a879a4808da168fdceb%7C98f515313973490abb70195aa264a2bc%7C0%7C0%7C637847105002756645%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000&sdata=cJaW4TxL68DJMI8KTEjVjQCIzsN1Oa9ShUtILmy1%2B2g%3D&reserved=0>
>
> [1]: https://docs.python.org/3/library/sys.html#sys.exit
> <https://can01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fdocs.python.org%2F3%2Flibrary%2Fsys.html%23sys.exit&data=04%7C01%7Cmatt.wilkie%40yukon.ca%7Cc3e8dba890e54a879a4808da168fdceb%7C98f515313973490abb70195aa264a2bc%7C0%7C0%7C637847105002756645%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000&sdata=pHA7JH0IS7tjePzMXO1MzvO6svuPVHVR9uQgPqxOtMY%3D&reserved=0>,
> ?Unix programs generally use 2 for command line syntax errors and 1 for all
> other kind of errors?
>
>
>
> *Matt Wilkie*
>
> Geomatics Developer & Administrator
>
> Environment | Technology, Innovation and Mapping
>
> T 867-667-8133 | *Yukon.ca
> <https://can01.safelinks.protection.outlook.com/?url=http%3A%2F%2Fyukon.ca%2F&data=04%7C01%7Cmatt.wilkie%40yukon.ca%7Cc3e8dba890e54a879a4808da168fdceb%7C98f515313973490abb70195aa264a2bc%7C0%7C0%7C637847105002756645%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000&sdata=S08L%2BQsPMBZOc2%2Bb3wnWS8W08a0ejZpHRC1QAMfFEyk%3D&reserved=0>*
>
> *Hours: 08:30-16:30, Mon-Wed: Office, Thu: Remote, Fri: Away.*
> _______________________________________________
> gdal-dev mailing list
> gdal-dev at lists.osgeo.org
> https://lists.osgeo.org/mailman/listinfo/gdal-dev
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220427/610b9241/attachment-0001.html>

From Matt.Wilkie at yukon.ca  Wed Apr 27 10:26:23 2022
From: Matt.Wilkie at yukon.ca (Matt.Wilkie at yukon.ca)
Date: Wed, 27 Apr 2022 17:26:23 +0000
Subject: [gdal-dev] Standardize gdal-utils scripts return code for "no
 arguments"
In-Reply-To: <PH0PR05MB80103CAEEB064EBD4F3CA056C1FA9@PH0PR05MB8010.namprd05.prod.outlook.com>
References: <9070572acd2c4fa49f1d247374336fca@yukon.ca>
 <27b89410166241e2867d47f458acc7bf@yukon.ca>
 <6a2c8b41a3bf4d9b85db0ad5a1c135ef@yukon.ca>
 <PH0PR05MB80103CAEEB064EBD4F3CA056C1FA9@PH0PR05MB8010.namprd05.prod.outlook.com>
Message-ID: <3b048e99fe414cec8393ba1c702097af@yukon.ca>

Thank you for the study path Idan, much appreciated and I will use it.

> Bottom line, returncode 2 is from the very last line in argparse.py,
> the builtin ArgumentParser (function ArgumentParser.error()):
> `self.exit(2, _('%(prog)s: error: %(message)s\n') % args)`

Hmmm. Since return 2 is the default for argparse then it seems to we should do the same for all the python utils?

-Matt

From: Idan Miara <idanmiara at outlook.com> On Behalf Of Idan Miara
Sent: April 27, 2022 6:24 AM
To: Matt.Wilkie <Matt.Wilkie at yukon.ca>
Cc: gdal-dev at lists.osgeo.org
Subject: Re: [gdal-dev] Standardize gdal-utils scripts return code for "no arguments"


You don't often get email from idan at miara.com<mailto:idan at miara.com>. Learn why this is important<https://aka.ms/LearnAboutSenderIdentification>

Hi Matt,

Since you mentioned that you don't understand how classes work (i.e. super function)
I would highly recommend spending some time to go over some basic Python OOP, it's not complicated and I'm confident that it would be very useful.
From a quick search, maybe this link would be useful https://realpython.com/python3-object-oriented-programming/<https://can01.safelinks.protection.outlook.com/?url=https%3A%2F%2Frealpython.com%2Fpython3-object-oriented-programming%2F&data=05%7C01%7CMatt.Wilkie%40yukon.ca%7C44e0362e122546ade38008da28514d88%7C98f515313973490abb70195aa264a2bc%7C0%7C0%7C637866628546448376%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=lldjRlTrTEnWnk4lhViopt%2B2v4cmk1li2JXWDGySfO0%3D&reserved=0> but there are many other resources.
super() is mainly used in Python as a way to call the superclass' function when that you subclass (https://realpython.com/python-super/<https://can01.safelinks.protection.outlook.com/?url=https%3A%2F%2Frealpython.com%2Fpython-super%2F&data=05%7C01%7CMatt.Wilkie%40yukon.ca%7C44e0362e122546ade38008da28514d88%7C98f515313973490abb70195aa264a2bc%7C0%7C0%7C637866628546448376%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=KZ%2B4PamCCg0v1nA2hFrq1LsSeBXAN7oKCKWgLpyW%2FKU%3D&reserved=0>)
For example, in `GDALArgumentParser.__init__()` I call `super().__init__` in order to access ArgumentParser's constructor (__init__).

GDALArgumentParser is defined as `class GDALArgumentParser(argparse.ArgumentParser)`.
So GDALArgumentParser is a superclass of the built in class argparse.ArgumentParser.
The objective of this class is mainly to standardize our usage of ArgumentParser by adding some functionality that was implemented in many different utils on top of ArgumentParser.
As GDALArgumentParser is a thin superclass of ArgumentParser, If you want to better understand GDALArgumentParser I advise you to first read the docs here https://docs.python.org/3/library/argparse.html<https://can01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fdocs.python.org%2F3%2Flibrary%2Fargparse.html&data=05%7C01%7CMatt.Wilkie%40yukon.ca%7C44e0362e122546ade38008da28514d88%7C98f515313973490abb70195aa264a2bc%7C0%7C0%7C637866628546448376%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=rbnjs2pgbJh5nIb8iYJE2BJQX0v65yEsopaf3iWaZ5g%3D&reserved=0>, it helped me very much when I coded GDALArgumentParser.

Bottom line, returncode 2 is from the very last line in argparse.py, the builtin ArgumentParser (function ArgumentParser.error()):
`self.exit(2, _('%(prog)s: error: %(message)s\n') % args)`
When ArgumentParser encounters an error (like calling it without arguments when arguments were required) it calls this function and exits with errorcode 2.
You could see this in action if you copy-paste and run without parameters the first example in the ArgumentParser docs (https://docs.python.org/3/library/argparse.html<https://can01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fdocs.python.org%2F3%2Flibrary%2Fargparse.html&data=05%7C01%7CMatt.Wilkie%40yukon.ca%7C44e0362e122546ade38008da28514d88%7C98f515313973490abb70195aa264a2bc%7C0%7C0%7C637866628546448376%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=rbnjs2pgbJh5nIb8iYJE2BJQX0v65yEsopaf3iWaZ5g%3D&reserved=0>).

The way I found this was just using the debugger in PyCharm and stepping in until I found out what's exits the run
(If an exception is raised it makes it much easier as you can easily follow the call stack)

pyi are stub files (https://peps.python.org/pep-0484/<https://can01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fpeps.python.org%2Fpep-0484%2F&data=05%7C01%7CMatt.Wilkie%40yukon.ca%7C44e0362e122546ade38008da28514d88%7C98f515313973490abb70195aa264a2bc%7C0%7C0%7C637866628546448376%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=YgIYRRFyd1rKQnLQukduYh71LiPtV5XltFow%2B31%2BdkU%3D&reserved=0>) and you probably encountered them when digging into Python's standard library which is not written in pure Python.

Best,
Idan

On Tue, 26 Apr 2022 at 23:06, <Matt.Wilkie at yukon.ca<mailto:Matt.Wilkie at yukon.ca>> wrote:
Here is the path I'm following in trying to deconstruct GDALArgumentParser.
With file = pc2rgb.py:
        r = subprocess.run([sys.executable,
            file],
            shell=True,
            capture_output=True,
            text=True,
            )
        if debug:
            print(f'returncode: {r.returncode}')
I get:
returncode: 2
Digging in to pct2rgb.py I see main() calling PCT2RGB class, calling pct2rgb function, which should error out with an exception.:
def main(argv=sys.argv):
    return PCT2RGB().main(argv)
    def doit(self, **kwargs):
        return pct2rgb(**kwargs)
def doit(**kwargs):
    try:
        ds = pct2rgb(**kwargs)
        return ds, 0
    except:
        return None, 1
def pct2rgb(src_filename: PathLikeOrStr, pct_filename: Optional[PathLikeOrStr], dst_filename: PathLikeOrStr,
            band_number: int = 1, out_bands: int = 3, driver_name: Optional[str] = None):
    # Open source file
    src_ds = open_ds(src_filename)
    if src_ds is None:
        raise Exception(f'Unable to open {src_filename} ')
    ...
So I'm thinking that while PCT2RGB class is invoking GDALArgumentParser it's exiting early somehow with this 2 return code.
def get_parser(self, argv) -> GDALArgumentParser:
    ...
    return parser
I look at auxillary/gdal_argparse.py: class GDALArgumentParser(argparse.ArgumentParser) and I see... well a bunch of stuff I only apprehend the shadowy outlines of. Looking at the return statements doesn't add light. (It doesn't help that I don't understand how classes work. There's this thing called super() but it's not defined anywhere. Shouldn't that cause an error? Oh it's from stdlib builtins.pyi. What the heck is a pyi? "...It is pitch black. You are likely to be eaten by a grue.")
? findstr "return" ..\auxiliary\gdal_argparse.py
        return super().parse_args(args=args, **kwargs)
        return shlex.split(arg_line, comments=True)
        return self._parser
        return kwargs
        return kwargs
            return 0
            return 1
        return epilog or None
So my question is: where is returncode: 2 coming from?

-Matt

From: Matt.Wilkie
Sent: April 26, 2022 1:03 PM
To: 'gdal-dev at lists.osgeo.org<mailto:gdal-dev at lists.osgeo.org>' <gdal-dev at lists.osgeo.org<mailto:gdal-dev at lists.osgeo.org>>
Subject: RE: Standardize gdal-utils scripts return code for "no arguments"

Hi Folks,

I've converted all the scripts that were using -1 to 1. However when I started looking at the ones returning 2 it became less clear what to do. Excepting gdal2tiles all of them are using GDALArgumentParser and I don't see where the return value is being set. Thinking this might mean the mainline utils might be using 2 for no args I checked gdal_translate and gdalwarp, but no, both of those use 1.

The scripts that return 2 are:

osgeo_utils\gdal2xyz.py
osgeo_utils\gdal_calc.py
osgeo_utils\gdal_fillnodata.py
osgeo_utils\gdal_polygonize.py
osgeo_utils\pct2rgb.py
osgeo_utils\rgb2pct.py
osgeo_utils\samples\gdallocationinfo.py


I haven?t been able to figure out the GDALArgumentParser  parser class so I embarked on making everything else use 2 instead of 1. I'm questioning the wisdom of that at the moment since so many files are touched. However the process has forced me to look more closely at the many scripts and start to internalize the various patterns they use. This has been worthwhile even if the approach might get abandoned. The ?make everything return 2? effort is in branch patch-5561-ret2<https://can01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fgithub.com%2Fmaphew%2Fgdal%2Ftree%2Fpatch-5561-ret2&data=05%7C01%7CMatt.Wilkie%40yukon.ca%7C44e0362e122546ade38008da28514d88%7C98f515313973490abb70195aa264a2bc%7C0%7C0%7C637866628546448376%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=G9NH8tqppVyTgxx6ubzvxZEtjCLtytJPOqcId7s5DDM%3D&reserved=0>.

The next message will have more details on how I?ve tried and failed to understand GDALArgumentParser.

-Matt

From: gdal-dev <gdal-dev-bounces at lists.osgeo.org<mailto:gdal-dev-bounces at lists.osgeo.org>> On Behalf Of Matt.Wilkie at yukon.ca<mailto:Matt.Wilkie at yukon.ca>
Sent: April 4, 2022 4:07 PM
To: gdal-dev at lists.osgeo.org<mailto:gdal-dev at lists.osgeo.org>
Subject: [gdal-dev] Standardize gdal-utils scripts return code for "no arguments"

Hi folks,

I?m working on ?Standardize gdal-utils scripts return codes #5561? for all the scripts in swig/python/gdal-utils. Currently the scripts do not return the same status code for "was run without arguments".

It would be good for the same code meant the same thing across all the scripts in the package. Given that most of the scripts use `1` now, and that this is in line with sys,exit() docs I think it makes sense to make 1 the new standard.

At present we have (return_code, num scripts with that code):

0: 30
1: 56
2:  8
-1:  9

-1 is a special case. In the script code it?s written as `return -1` but subprocess.run() captures it as `4294967295`. Another special case is `gdal_auth.py` sample which with no arguments spawns a web authentication page in browser.

Changing the return code will mean anyone who is relying on those in their own scripts or programs will need to adjust. This seems to be a small price for the gain in harmonization across the utilities, to me. Your thoughts?


[0]: https://github.com/OSGeo/gdal/issues/5561<https://can01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fgithub.com%2FOSGeo%2Fgdal%2Fissues%2F5561&data=05%7C01%7CMatt.Wilkie%40yukon.ca%7C44e0362e122546ade38008da28514d88%7C98f515313973490abb70195aa264a2bc%7C0%7C0%7C637866628546448376%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=ivFPApdA%2FDSKBptJoFtavUj5DkwTyPrHomPLt2YqKiM%3D&reserved=0>
[1]: https://docs.python.org/3/library/sys.html#sys.exit<https://can01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fdocs.python.org%2F3%2Flibrary%2Fsys.html%23sys.exit&data=05%7C01%7CMatt.Wilkie%40yukon.ca%7C44e0362e122546ade38008da28514d88%7C98f515313973490abb70195aa264a2bc%7C0%7C0%7C637866628546448376%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=feIqF2ldsa%2FZzWXBWGPY6v4js3lkGxPptty9vdebozY%3D&reserved=0>, ?Unix programs generally use 2 for command line syntax errors and 1 for all other kind of errors?

Matt Wilkie
Geomatics Developer & Administrator
Environment | Technology, Innovation and Mapping
T 867-667-8133 | Yukon.ca<https://can01.safelinks.protection.outlook.com/?url=http%3A%2F%2Fyukon.ca%2F&data=05%7C01%7CMatt.Wilkie%40yukon.ca%7C44e0362e122546ade38008da28514d88%7C98f515313973490abb70195aa264a2bc%7C0%7C0%7C637866628546448376%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=AUpiUIH7jENlcxo%2BIY%2BAx9WVdHeGvRJzzzorrFR3LE4%3D&reserved=0>
Hours: 08:30-16:30, Mon-Wed: Office, Thu: Remote, Fri: Away.
_______________________________________________
gdal-dev mailing list
gdal-dev at lists.osgeo.org<mailto:gdal-dev at lists.osgeo.org>
https://lists.osgeo.org/mailman/listinfo/gdal-dev<https://can01.safelinks.protection.outlook.com/?url=https%3A%2F%2Flists.osgeo.org%2Fmailman%2Flistinfo%2Fgdal-dev&data=05%7C01%7CMatt.Wilkie%40yukon.ca%7C44e0362e122546ade38008da28514d88%7C98f515313973490abb70195aa264a2bc%7C0%7C0%7C637866628546448376%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C3000%7C%7C%7C&sdata=Kz6E8GoJl5e%2BO5dfVAwVD9nm9wAZbvFBoXh0H5ZiQ3g%3D&reserved=0>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220427/8d0fc873/attachment-0001.html>

From jukka.rahkonen at maanmittauslaitos.fi  Wed Apr 27 23:28:47 2022
From: jukka.rahkonen at maanmittauslaitos.fi (Rahkonen Jukka (MML))
Date: Thu, 28 Apr 2022 06:28:47 +0000
Subject: [gdal-dev] Why gdal2tiles creates png.aux.xml files
Message-ID: <8568e22ffbfa45f18c3ad752e2999424@maanmittauslaitos.fi>

Hi,

I noticed this question in gis.stacexchange https://gis.stackexchange.com/questions/429896/how-to-not-generate-png-aux-xml-files-when-using-gdal2tiles. The current gdal2tiles.py really seems to write the aux.xml files except for the base tiles. I wonder if it is necessary and if there is another way to prevent it than setting GDAL_PAM_ENABLED=NO as suggested in the answer.

-Jukka Rahkonen-
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220428/6b84798a/attachment.html>

From robert.coup at koordinates.com  Thu Apr 28 07:29:06 2022
From: robert.coup at koordinates.com (Robert Coup)
Date: Thu, 28 Apr 2022 15:29:06 +0100
Subject: [gdal-dev] Standardize gdal-utils scripts return code for "no
 arguments"
In-Reply-To: <3b048e99fe414cec8393ba1c702097af@yukon.ca>
References: <9070572acd2c4fa49f1d247374336fca@yukon.ca>
 <27b89410166241e2867d47f458acc7bf@yukon.ca>
 <6a2c8b41a3bf4d9b85db0ad5a1c135ef@yukon.ca>
 <PH0PR05MB80103CAEEB064EBD4F3CA056C1FA9@PH0PR05MB8010.namprd05.prod.outlook.com>
 <3b048e99fe414cec8393ba1c702097af@yukon.ca>
Message-ID: <CAFLLRpLsW3rR1mU8FCsVrk=bFB0i3hTfdhGGjoziV=vtZ7k6_A@mail.gmail.com>

Hi Matt,

On Wed, 27 Apr 2022 at 18:27, <Matt.Wilkie at yukon.ca> wrote:

>
>
> Since return 2 is the default for argparse then it seems to we should do
> the same for all the python utils?
>

In my experience 2 is a common exit code when missing/invalid arguments are
passed to a process in the unix-ey world, but it's not standardised or
universal.

Rob :)
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220428/117e7495/attachment.html>

From neteler at osgeo.org  Thu Apr 28 13:31:07 2022
From: neteler at osgeo.org (Markus Neteler)
Date: Thu, 28 Apr 2022 22:31:07 +0200
Subject: [gdal-dev] Moving GDAL GRASS driver in a dedicated repository ?
In-Reply-To: <36ba97a9-1dc6-eacb-8765-55c0c4a97929@spatialys.com>
References: <36ba97a9-1dc6-eacb-8765-55c0c4a97929@spatialys.com>
Message-ID: <CALFmHhv+AfuxtT9BrKLCR2D8=4aJoV9k-4J5yxXsp4dLOah3TA@mail.gmail.com>

Hi Even,

(back to your wish)

On Thu, Nov 18, 2021 at 7:12 PM Even Rouault <even.rouault at spatialys.com> wrote:
>
> Hi,
>
> (writing to both GDAL and GRASS lists)
>
> Working on the transition to CMake as the GDAL build system, the
> particular status of the GRASS driver in GDAL raised my attention.
>
> (The following is based on my understanding. It has been ages since I
> didn't try this...)
>
> This driver is a bit odd in the sense that there's a cyclic dependency
> to work around, as GRASS links to GDAL , but the GDAL GRASS driver needs
> to be linked against GRASS.
>
> So the usual procedure is:
>
> - build GDAL without the GRASS driver
>
> - build GRASS against GDAL
>
> - build the GDAL GRASS driver from the separate gdal-grass tarball that
> GDAL distributes along its main tarball.
>
> With the current GDAL autoconf build system, there's also the
> possibility to rebuild GDAL with the GRASS driver builtin in libgdal,
> but that's a bit odd, since you need to make sure that this new libgdal
> is the one that GRASS will link against at runtime, otherwise chaos will
> ensure. I'm not sure if that's used. This is typically something I would
> *not* want to support in the new GDAL cmake build.
>
> All in all, given the particular nature of that driver, I believe it
> would be better in a dedicated repository, with its standalone build
> scripts, whose initial version could be just the ones of
> https://github.com/OSGeo/gdal/tree/master/frmts/grass/pkg, or evolve to
> CMake or whatever the maintainers of that driver would prefer. I believe
> this would make the situation clearer.
>
> Opinions ? and people interested in setting up that dedicated repository ?

Yes and finally done that:

https://github.com/OSGeo/gdal-grass

Hope I got it right (history is preserved, I used

git filter-repo --path ogr/ogrsf_frmts/grass --path frmts/grass

and then moved the remaining needed files into the toplevel directory.
Hope I got it right.

Markus

-- 
Markus Neteler, PhD
https://www.mundialis.de - free data with free software
https://grass.osgeo.org
https://courses.neteler.org/blog

From johannespaul92 at gmail.com  Fri Apr 29 01:35:46 2022
From: johannespaul92 at gmail.com (Johannes Paul)
Date: Fri, 29 Apr 2022 10:35:46 +0200
Subject: [gdal-dev] GDAL compilation on Centos8 with MrSID
In-Reply-To: <CACcmK9ZCgy_A-pgfweRmLm621gHGqEdg6MGAB5sGy6c+VRad6A@mail.gmail.com>
References: <CACcmK9ZCgy_A-pgfweRmLm621gHGqEdg6MGAB5sGy6c+VRad6A@mail.gmail.com>
Message-ID: <CACcmK9ZG2tTrW8kgsAUFk2RT3zd+0VoRK9DFxY2niT-we_sRaA@mail.gmail.com>

For the record, I finally managed to build GDAL with MrSID on Centos8 (gcc
8.5). Basically the MrSID SDK is overcautiously restricting itself to the
gcc version that was current at the time it was released (gcc5), and the
build can be fixed by patching the lt_platform.h header manually, as
detailed here https://github.com/OSGeo/gdal/issues/2797.
Thanks,
Johannes

On Wed, 27 Apr 2022 at 15:19, Johannes Paul <johannespaul92 at gmail.com>
wrote:

> Hello,
> I'm struggling to compile GDAL on Centos8 with MrSID driver.
> I got the MrSID SDK from online (
> https://www.extensis.com/support/developers), however for linux only gcc
> 4.8.2 and gcc 5.3.1 versions of the SDK are available.
> I can manage to compile GDAL on Centos7 (gcc 4.8.5) with MrSID SDK (gcc
> 5.3.1), however when trying to achieve compilation on Centos8 (gcc 8.5.0),
> I get the following errors at make stage
> ```
> In file included from
> /MrSID_DSDK-9.5.4.4709-rhel6.x86-64.gcc531/Raster_DSDK/include/lt_types.h:28,
>
>                  from mrsiddataset_headers_include.h:50,
>
>                  from mrsiddataset.cpp:53:
>
>
> /MrSID_DSDK-9.5.4.4709-rhel6.x86-64.gcc531/Raster_DSDK/include/lt_platform.h:102:5:
> error: #error PLATFORM ERROR: unknown compiler
>
>     #error PLATFORM ERROR: unknown compiler
>
>
> In file included from mrsiddataset_headers_include.h:50,
>
>                  from mrsiddataset.cpp:53:
>
>
> /MrSID_DSDK-9.5.4.4709-rhel6.x86-64.gcc531/Raster_DSDK/include/lt_types.h:72:5:
> error: #error NOT YET PORTED TO TARGET COMPILER
>
>     #error NOT YET PORTED TO TARGET COMPILER
>
>
> /MrSID_DSDK-9.5.4.4709-rhel6.x86-64.gcc531/Raster_DSDK/include/lt_types.h:131:5:
> error: #error NOT YET PORTED TO TARGET COMPILER
>
>     #error NOT YET PORTED TO TARGET COMPILER
> ...
> ```
> I suspect this is related to the fact that MrSID SDK is compiled with an
> old version of GCC (5.3) whereas GDAL is being compiled with a new one
> (8.5).
>
> Unfortunately old versions of GCC are not available on Centos8, and I did
> not manage to compile old GCC from source on Centos8.
>
> Any help would be appreciated.
> Thanks
> Johannes
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220429/ba62a5c2/attachment.html>

From j1 at jimenezshaw.com  Fri Apr 29 02:30:50 2022
From: j1 at jimenezshaw.com (Javier Jimenez Shaw)
Date: Fri, 29 Apr 2022 11:30:50 +0200
Subject: [gdal-dev] CMake: undefined reference to symbol dlerror
Message-ID: <CADRrdKt8yuQ+KfFkJait8=kf-EROzGd17a+6UGA2Fa_kxjVgWQ@mail.gmail.com>

We have a link problem on Linux when using GDAL transiently. If we link the
unit tests for a library which depends on GDAL, i.e. an executable which
transiently depends on GDAL through our library, we get the following
linker error:

/usr/bin/ld:
libs/ioimage/tests/CMakeFiles/tests_unit_ioimage.dir/unit/writers/test_geoTiffWriter.cpp.o:
undefined reference to symbol 'dlerror@@GLIBC_2.2.5'
/usr/bin/ld: /lib/x86_64-linux-gnu/libdl.so.2: error adding symbols: DSO
missing from command line

We need to add -ldl to the linker line after GDAL in order to resolve the
linker problem. This can be done when adding the property

  INTERFACE_LINK_LIBRARIES "dl"

to the GDAL::GDAL imported target in GDAL-targets-release.cmake (this is a
generated file); apparently it is not enough to add dl to the
IMPORTED_LINK_DEPENDENT_LIBRARIES_RELEASE property.

Does GDAL depend publicly on dl?
We do not find the proper way to patch GDAL's CMake code to add that
dependency in the generated config file.

Thanks
Javier

.___ ._ ..._ .. . ._.  .___ .. __ . _. . __..  ... .... ._ .__
Entre dos pensamientos racionales
hay infinitos pensamientos irracionales.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220429/2521cfb0/attachment.html>

From jmckenna at gatewaygeomatics.com  Fri Apr 29 07:05:00 2022
From: jmckenna at gatewaygeomatics.com (Jeff McKenna)
Date: Fri, 29 Apr 2022 11:05:00 -0300
Subject: [gdal-dev] GDAL 3.4.3 RC1 available
In-Reply-To: <a88d2959-2cf5-715d-a61f-ec429cf494ec@spatialys.com>
References: <a88d2959-2cf5-715d-a61f-ec429cf494ec@spatialys.com>
Message-ID: <179ae371-b272-1329-8bf4-59cc5e26611e@gatewaygeomatics.com>

Sorry for the delay in my usual testing, no issues here on Windows, with 
the MS4W build environment.  -jeff





-- 
Jeff McKenna
GatewayGeo: Developers of MS4W, MapServer Consulting and Training
co-founder of FOSS4G
http://gatewaygeo.com/



On 2022-04-22 6:32 a.m., Even Rouault wrote:
> Hi,
> 
> I have prepared a GDAL/OGR 3.4.3 release candidate.
> 
> Pick up an archive among the following ones (by ascending size):
> 
>  ? https://download.osgeo.org/gdal/3.4.3/gdal-3.4.3rc1.tar.xz
>  ? https://download.osgeo.org/gdal/3.4.3/gdal-3.4.3rc1.tar.gz
>  ? https://download.osgeo.org/gdal/3.4.3/gdal343rc1.zip
> 
> A snapshot of the gdalautotest suite is also available :
> 
> https://download.osgeo.org/gdal/3.4.3/gdalautotest-3.4.3rc1.tar.gz
>  ? https://download.osgeo.org/gdal/3.4.3/gdalautotest-3.4.3rc1.zip
> 
> GDAL-GRASS plugin:
> 
>  ? https://download.osgeo.org/gdal/3.4.3/gdal-grass-3.4.3.tar.gz
> 
> The NEWS file is here :
> 
>  ? https://github.com/OSGeo/gdal/blob/v3.4.3RC1/gdal/NEWS.md
> 
> I'll call for a vote promoting it to final later next week if no
> serious problems are reported before.
> 
> Best regards,
> 
> Even
> 


From nyall.dawson at gmail.com  Fri Apr 29 18:10:39 2022
From: nyall.dawson at gmail.com (Nyall Dawson)
Date: Sat, 30 Apr 2022 11:10:39 +1000
Subject: [gdal-dev] Hints that a raster band represents a DEM?
Message-ID: <CAB28AsjdrcLTMQV5ZUW3XfTtTYYmY6Hdf1qstLN=BThP6hfrsQ@mail.gmail.com>

Hi list,

I'm looking for any tips on potential approaches I could use to
automagically guess that a particular band from a data source
represents an elevation surface.

I haven't been able to find any common metadata components in the
files I've investigated which could help indicate this, but maybe I'm
missing something. Right now the best approach I can think of would be
to test if the layer's CRS has a vertical component (but unfortunately
even among DEM layers I think this will be rare!).

Any suggestions?
Nyall

From mdsumner at gmail.com  Fri Apr 29 20:42:14 2022
From: mdsumner at gmail.com (Michael Sumner)
Date: Sat, 30 Apr 2022 13:42:14 +1000
Subject: [gdal-dev] Hints that a raster band represents a DEM?
In-Reply-To: <CAB28AsjdrcLTMQV5ZUW3XfTtTYYmY6Hdf1qstLN=BThP6hfrsQ@mail.gmail.com>
References: <CAB28AsjdrcLTMQV5ZUW3XfTtTYYmY6Hdf1qstLN=BThP6hfrsQ@mail.gmail.com>
Message-ID: <CAAcGz9_ioyVutODv9_jSNw+F_tutCT_5FRMkDxnYr=3ZwR5Lcg@mail.gmail.com>

read from a global dem via the warper and do a correlation test?

:)


On Sat, Apr 30, 2022 at 11:11 AM Nyall Dawson <nyall.dawson at gmail.com>
wrote:

> Hi list,
>
> I'm looking for any tips on potential approaches I could use to
> automagically guess that a particular band from a data source
> represents an elevation surface.
>
> I haven't been able to find any common metadata components in the
> files I've investigated which could help indicate this, but maybe I'm
> missing something. Right now the best approach I can think of would be
> to test if the layer's CRS has a vertical component (but unfortunately
> even among DEM layers I think this will be rare!).
>
> Any suggestions?
> Nyall
> _______________________________________________
> gdal-dev mailing list
> gdal-dev at lists.osgeo.org
> https://lists.osgeo.org/mailman/listinfo/gdal-dev
>


-- 
Michael Sumner
Software and Database Engineer
Australian Antarctic Division
Hobart, Australia
e-mail: mdsumner at gmail.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.osgeo.org/pipermail/gdal-dev/attachments/20220430/5a66842d/attachment.html>

